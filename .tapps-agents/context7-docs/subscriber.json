{
  "library": "subscriber",
  "topic": null,
  "documentation": {
    "content": "## Database Adapter - plans() Method Implementation\n\n```javascript\n// Implementation example\nconst db = {\n  plans: function(callback) {\n    // Fetch from your database\n    const planData = {\n      trial: {\n        duration: 14,      // 14-day trial period\n        fallback: \"free\"   // Plan to fall back to after trial expires\n      },\n      plans: [\n        {\n          name: \"free\",\n          limits: {\n            clients: 3,        // Max 3 clients\n            projects: 5,       // Max 5 projects\n            storage: 0         // 0 = blocked completely\n          }\n        },\n        {\n          name: \"basic\",\n          limits: {\n            clients: {         // Granular control per action\n              create: 10,\n              show: 100,\n              index: null,     // null = unlimited\n              update: null,\n              delete: null\n            },\n            projects: 15\n          }\n        },\n        {\n          name: \"premium\",\n          clients: 50,         // Shorthand: limits creation only\n          projects: null       // null = unlimited\n        }\n      ]\n    };\n\n    callback(null, planData);\n  }\n};\n\n// Shorthand forms also supported:\n// 1. Just plans array: callback(null, [{name: \"free\", clients: 3}])\n// 2. Trial as integer: {trial: 14, plans: [...]}\n```\n\n## Plan Data Structure Examples (JSON)\n\n```json\n{ \"plans\": [ { \"name\": \"free\", \"clients\": 3, \"groups\": 2 }, { \"name\": \"bronze\", \"clients\": 5, \"groups\": 10 } ] }\n```\n\n## Plan Data Structure Examples (JSON)\n\n```json\n[ { \"name\": \"free\", \"clients\": 3, \"groups\": 2 }, { \"name\": \"bronze\", \"clients\": 5, \"groups\": 10 } ]\n```\n\n## Plan Data Structure Examples (JSON)\n\n```json\n{ \"trial\": 14, \"plans\": [ { \"name\": \"free\", \"clients\": 3, \"groups\": 2 }, { \"name\": \"bronze\", \"clients\": 5, \"groups\": 10 } ] }\n```\n\n## JavaScript: Configure Free Trial with Fallback Plan\n\n```javascript\nconst db = {\n  plans: function(callback) {\n    callback(null, {\n      trial: {\n        duration: 14,      // Days before trial expires\n        fallback: \"free\"   // Plan to use after trial expires\n      },\n      plans: [\n        {name: \"free\", limits: {clients: 3}},\n        {name: \"pro\", limits: {clients: 25}}\n      ]\n    });\n  },\n\n  user: function(username, callback) {\n    const now = Date.now();\n    const fourteenDaysAgo = now - (14 * 24 * 60 * 60 * 1000);\n\n    // User on active trial\n    callback(null, {\n      name: \"trial_user\",\n      plan: {\n        name: \"pro\",\n        trial: true,\n        join: Date.now() - (7 * 24 * 60 * 60 * 1000)  // Joined 7 days ago\n      },\n      usage: {clients: 15}  // Using pro plan features\n    });\n\n    // Trial expired -> falls back to \"free\" plan automatically\n    // POST /api/clients would be blocked if usage (15) > free limit (3)\n\n    // Extended trial (admin override)\n    callback(null, {\n      name: \"extended_user\",\n      plan: {\n        name: \"pro\",\n        trial: true,\n        join: fourteenDaysAgo - (10 * 24 * 60 * 60 * 1000),  // 24 days ago\n        expire: now + (5 * 24 * 60 * 60 * 1000)              // Extended 5 more days\n      },\n      usage: {clients: 20}\n    });\n  }\n};\n```\n\n## JavaScript: Complete Express App with Subscriber Middleware\n\n```javascript\nconst express = require('express');\nconst subscriber = require('subscriber');\nconst app = express();\n\n// Mock database adapter\nconst db = {\n  plans: function(callback) {\n    callback(null, {\n      trial: {duration: 14, fallback: \"free\"},\n      plans: [\n        {name: \"free\", limits: {clients: 3, projects: 5}},\n        {name: \"startup\", limits: {clients: 15, projects: 25}},\n        {name: \"business\", clients: null, projects: null}\n      ]\n    });\n  },\n\n  user: function(username, callback) {\n    const users = {\n      john: {\n        plan: {name: \"free\", join: Date.now()},\n        usage: {clients: 2, projects: 3}\n      },\n      jane: {\n        plan: {name: \"startup\", trial: true, join: Date.now() - 5*24*60*60*1000},\n        usage: {clients: 10, projects: 20}\n      }\n    };\n    callback(null, users[username]);\n  }\n};\n\n// Middleware setup\napp.use(express.json());\n\n// Authentication middleware (sets req.user)\napp.use(function(req, res, next) {\n  const auth = req.headers.authorization;\n  if (auth && auth.startsWith('Bearer ')) {\n    req.user = auth.substring(7);  // Extract username from Bearer token\n  }\n  next();\n});\n\n// Subscriber middleware (checks plan limits)\napp.use(subscriber.init({\n  db: db,\n  timeout: 60,\n  base: '/api'\n}));\n\n// Application routes\napp.post('/api/clients', function(req, res) {\n  res.json({id: 1, name: req.body.name, created: true});\n});\n\napp.post('/api/projects', function(req, res) {\n  res.json({id: 1, name: req.body.name, created: true});\n});\n\napp.listen(3000);\n\n// Test requests:\n// curl -X POST http://localhost:3000/api/clients \\\n//   -H \"Authorization: Bearer john\" \\\n//   -H \"Content-Type: application/json\" \\\n//   -d '{\"name\":\"ACME Corp\"}'\n// -> 200 OK (john has 2/3 clients)\n\n// curl -X POST http://localhost:3000/api/projects \\\n//   -H \"Authorization: Bearer jane\" \\\n//   -H \"Content-Type: application/json\" \\\n//   -d '{\"name\":\"Website Redesign\"}'\n// -> 200 OK (jane on trial with startup limits: 20/25 projects)\n```\n\n## Database Adapter - user() Method Implementation\n\n```javascript\nconst db = {\n  user: function(username, callback) {\n    // Fetch from your database\n    const userData = {\n      name: \"john\",\n      plan: {\n        name: \"basic\",\n        trial: true,                   // Currently on free trial\n        join: 1609459200000,           // Joined plan timestamp (Date.getTime())\n        expire: 1610668800000          // Optional: explicit expiry override\n      },\n      usage: {\n        clients: 7,                    // Has 7 clients\n        projects: 12                   // Has 12 projects\n      }\n    };\n\n    callback(null, userData);\n  }\n};\n\n// Shorthand forms supported:\n// 1. Plan as string: {name: \"john\", plan: \"basic\", usage: {...}}\n// 2. Usage as properties: {name: \"john\", plan: \"basic\", clients: 7, projects: 12}\n// 3. Combined: {name: \"john\", plan: \"free\", clients: 5}\n\n// User identification from req.user:\n// - String: req.user = \"john\" -> db.user(\"john\", callback)\n// - Object: req.user = {id: \"john\"} -> db.user(\"john\", callback)\n```\n\n## Shorthand Plan Definition with Free Trial\n\n```javascript\n{trial:14,plans:[{name:\"premium\",groups:5},{name:\"pro\",groups:10}]}\n```\n\n## User Plan Shorthand\n\n```javascript\n{name:\"john\",plan:\"free\",usage:{clients:3,groups:2}}\n```\n\n## Retrieve All Plans with Limits and Trial Info (JavaScript)\n\n```javascript\ndb.plans(function(err, data) {\n  // handle error or process data\n});\n```\n\n## User Object Structure for Free Trials\n\n```javascript\n{\n  name: \"john\",\n  plan: {\n    name: \"pro\",\n    join: 1234567,\n    expire: 1238899,\n    trial: true\n  },\n  usage: {\n    clients: 3,\n    groups: 2\n  }\n}\n```\n\n## User Information\n\n```APIDOC\n## GET /db/user/:name\n\n### Description\nRetrieves user information, including plan and current usage.\n\n### Method\nGET\n\n### Endpoint\n/db/user/:name\n\n### Parameters\n#### Path Parameters\n- **name** (string) - Required - The name of the user.\n\n### Request Example\nNone\n\n### Response\n#### Success Response (200)\n- **user** (object) - The user object containing name, plan, and usage details.\n  - **name** (string) - Required - Name of the user.\n  - **plan** (object | string) - Required - Properties of the user's current plan, or just the name of the plan.\n    - **name** (string) - Required - Name of the plan.\n    - **trial** (boolean) - Optional - If true, the user is in a free trial.\n    - **join** (integer) - Required - Date of joining the plan (Unix timestamp).\n    - **expire** (integer) - Optional - Date of plan expiration (Unix timestamp).\n  - **usage** (object) - Optional - Current usage of resources.\n    - **[resource_name]** (integer) - The current usage count for the specified resource.\n\n#### Response Example\n```json\n{\n  \"name\": \"john\",\n  \"plan\": {\n    \"name\": \"premium\",\n    \"join\": 1678886400,\n    \"expire\": 1681564800\n  },\n  \"usage\": {\n    \"clients\": 3,\n    \"groups\": 2\n  }\n}\n```\n*Note: A shorthand for the plan and usage properties is also supported.*\n```\n",
    "library": "subscriber",
    "topic": "overview",
    "source": "api"
  },
  "source": "api",
  "saved_at": "2026-02-04T10:33:36.184240"
}