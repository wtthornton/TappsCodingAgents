{
  "library": "state_persistence_config",
  "topic": "best-practices",
  "documentation": {
    "content": "## Proxy Pattern for Existing Class Persistence\n\n```cpp\n// Proxy pattern for existing classes\nmodded class TAG_ExistingEconomyManager\n{\n    int m_iTotalCurrency;\n    ref map<string, int> m_mPlayerBalances;\n\n    void TAG_ExistingEconomyManager()\n    {\n        // Register existing instance for persistence\n        EDF_DataCallbackSingle<EPF_ScriptedStateSaveData> callback(\n            this, \"OnPersistenceLoaded\");\n        EPF_PersistentScriptedStateProxy.CreateAsync(this, callback: callback);\n    }\n\n    private void OnPersistenceLoaded()\n    {\n        Print(string.Format(\"Economy state loaded: %1 total currency\",\n                            m_iTotalCurrency));\n    }\n\n    void ~TAG_ExistingEconomyManager()\n    {\n        EPF_PersistentScriptedStateProxy.Destroy(this);\n    }\n}\n\n```\n\n## Define Existing Class for Persistence\n\n```cs\n/*external code from other mod*/\nclass TAG_MyExistingCounter\n{\n    int m_iCount;\n\n    //------------------------------------------------------------------------------------------------\n    void Increment()\n    {\n        Print(++m_iCount);\n    }\n};\n\n```\n\n## C++: Implement Virtual Garage System for Entity Persistence\n\n```cpp\nclass TAG_VirtualGarageSystem\n{\n    void StoreVehicle(IEntity vehicle, int playerId)\n    {\n        EPF_PersistenceComponent persistence = \n            EPF_Component<EPF_PersistenceComponent>.Find(vehicle);\n\n        if (!persistence)\n        {\n            Print(\"Vehicle does not have persistence component\", LogLevel.ERROR);\n            return;\n        }\n\n        // Pause tracking to prevent auto-deletion during storage\n        persistence.PauseTracking();\n\n        // Save current state\n        EPF_EReadResult readResult;\n        EPF_EntitySaveData saveData = persistence.Save(readResult);\n\n        if (!saveData || readResult == EPF_EReadResult.ERROR)\n        {\n            Print(\"Failed to save vehicle state\", LogLevel.ERROR);\n            persistence.ResumeTracking();\n            return;\n        }\n\n        // Add to custom garage collection\n        EDF_DbContext dbContext = EPF_PersistenceManager.GetInstance().GetDbContext();\n        TAG_GarageEntry entry = new TAG_GarageEntry();\n        entry.m_sPlayerId = playerId.ToString();\n        entry.m_sVehiclePersistentId = persistence.GetPersistentId();\n        entry.m_iStorageTime = System.GetUnixTime();\n\n        EDF_DbOperationStatusOnlyCallback callback(this, \"OnVehicleStored\");\n        dbContext.AddOrUpdateAsync(entry, callback);\n\n        // Delete physical entity from world\n        SCR_EntityHelper.DeleteEntityAndChildren(vehicle);\n\n        Print(string.Format(\"Vehicle stored in garage for player %1\", playerId));\n    }\n\n    void OnVehicleStored(EDF_EDbOperationStatusCode statusCode)\n    {\n        if (statusCode != EDF_EDbOperationStatusCode.SUCCESS)\n            Print(\"Failed to save garage entry to database\", LogLevel.ERROR);\n    }\n\n    void RetrieveVehicle(int playerId, vector spawnPosition)\n    {\n        // Query garage for player's vehicles\n        EDF_DbContext dbContext = EPF_PersistenceManager.GetInstance().GetDbContext();\n        EPF_DbFindCallbackMultiple<TAG_GarageEntry> callback(\n            Tuple2<int, vector>.Create(playerId, spawnPosition)\n                .Invoke(OnGarageEntriesLoaded));\n\n        EDF_DbFindCondition<TAG_GarageEntry> condition = \n            EDF_DbFind.Field(\"m_sPlayerId\").Equals(playerId.ToString());\n\n        dbContext.FindAllAsync(TAG_GarageEntry, callback, condition);\n    }\n\n    void OnGarageEntriesLoaded(EDF_EDbOperationStatusCode statusCode,\n                                array<ref TAG_GarageEntry> entries,\n                                int playerId,\n                                vector spawnPosition)\n    {\n        if (statusCode != EDF_EDbOperationStatusCode.SUCCESS || !entries ||\n            entries.IsEmpty())\n        {\n            Print(\"No vehicles in garage for player\", LogLevel.WARNING);\n            return;\n        }\n\n        // Take first vehicle\n        TAG_GarageEntry entry = entries[0];\n\n        // Load vehicle save-data\n        EPF_PersistenceManager manager = EPF_PersistenceManager.GetInstance();\n        EPF_PersistenceComponent persistence = \n            manager.FindPersistenceComponentById(entry.m_sVehiclePersistentId);\n\n        if (!persistence)\n        {\n            Print(\"Vehicle persistence data not found\", LogLevel.ERROR);\n            return;\n        }\n\n        // Get save-data and update spawn position\n        EDF_DbContext dbContext = manager.GetDbContext();\n        EPF_DbFindCallbackSingle<EPF_EntitySaveData> saveCallback(\n            Tuple3<TAG_GarageEntry, vector, int>.Create(entry, spawnPosition, playerId)\n                .Invoke(OnVehicleSaveDataLoaded));\n\n        EDF_DbFindCondition<EPF_EntitySaveData> condition = \n            EDF_DbFind.Field(\"m_sId\").Equals(entry.m_sVehiclePersistentId);\n\n        dbContext.FindFirstAsync(EPF_EntitySaveData, saveCallback, condition);\n    }\n\n    void OnVehicleSaveDataLoaded(EDF_EDbOperationStatusCode statusCode,\n                                  EPF_EntitySaveData saveData,\n                                  TAG_GarageEntry entry,\n                                  vector spawnPosition,\n                                  int playerId)\n    {\n        if (statusCode != EDF_EDbOperationStatusCode.SUCCESS || !saveData)\n        {\n            Print(\"Failed to load vehicle save-data\", LogLevel.ERROR);\n            return;\n        }\n\n        // Update spawn position\n        saveData.m_pTransformation.m_vOrigin = spawnPosition;\n\n        // Spawn vehicle back into world\n        IEntity vehicle = saveData.Spawn(isRoot: true);\n\n        if (!vehicle)\n        {\n            Print(\"Failed to spawn vehicle from save-data\", LogLevel.ERROR);\n            return;\n        }\n\n        // Remove from garage\n        EDF_DbContext dbContext = EPF_PersistenceManager.GetInstance().GetDbContext();\n        EDF_DbOperationStatusOnlyCallback callback(this, \"OnGarageEntryRemoved\");\n        dbContext.RemoveAsync(entry, callback);\n    }\n\n    void OnGarageEntryRemoved(EDF_EDbOperationStatusCode statusCode)\n    {\n        if (statusCode != EDF_EDbOperationStatusCode.SUCCESS)\n            Print(\"Failed to remove garage entry from database\", LogLevel.ERROR);\n    }\n};\n```\n\n## C# Save-Data Versioning and Migration Example\n\n```cs\n[\n    EPF_PersistentScriptedStateSettings(TAG_MyExistingCounter),\n    EDF_DbName.Automatic()\n]\nclass TAG_MyExistingCounterSaveData : EPF_ScriptedStateSaveData\n{\n    string m_sCount;\n\n    //------------------------------------------------------------------------------------------------\n    protected bool SerializationLoad(BaseSerializationLoadContext loadContext)\n    {\n        DeserializeMetaData(loadContext);\n\n        // Migtate V1 data\n        if (m_iDataLayoutVersion == 1)\n        {\n            int migrateCount;\n            loadContext.ReadValue(\"m_iCount\", migrateCount);\n            m_sCount = migrateCount.ToString();\n            return true;\n        }\n\n        loadContext.ReadValue(\"m_sCount\", m_sCount);\n\n        return true;\n    }\n\n    //------------------------------------------------------------------------------------------------\n    void TAG_MyExistingCounterSaveData()\n    {\n        // We set the version to two via ctor, but could also be done via SerializationSave\n        m_iDataLayoutVersion = 2;\n    }\n};\n\n```\n\n## Persisting Scripted State (Faction War)\n\n```cpp\n// Direct inheritance approach\nclass TAG_FactionWarState : EPF_PersistentScriptedState\n{\n    int m_iFactionAPoints;\n    int m_iFactionBPoints;\n    string m_sCurrentObjective;\n\n    void TAG_FactionWarState()\n    {\n        // Automatically registered on construction\n        m_iFactionAPoints = 0;\n        m_iFactionBPoints = 0;\n        m_sCurrentObjective = \"none\";\n    }\n\n    void AddPoints(string faction, int points)\n    {\n        if (faction == \"A\")\n            m_iFactionAPoints += points;\n        else\n            m_iFactionBPoints += points;\n\n        // Manually trigger save\n        Save();\n    }\n}\n\n[EPF_PersistentScriptedStateSettings(TAG_FactionWarState), EDF_DbName.Automatic()]\nclass TAG_FactionWarStateSaveData : EPF_ScriptedStateSaveData\n{\n    int m_iFactionAPoints;\n    int m_iFactionBPoints;\n    string m_sCurrentObjective;\n\n    // Auto-serialization by property name matching\n}\n\n// Usage\nTAG_FactionWarState warState = new TAG_FactionWarState();\nwarState.AddPoints(\"A\", 100);\n\n// Load on server restart\nEPF_PersistenceManager manager = EPF_PersistenceManager.GetInstance();\nstring stateId = warState.GetPersistentId();\nTAG_FactionWarState loadedState =\n    TAG_FactionWarState.Cast(manager.FindScriptedStateByPersistentId(stateId));\n\n```\n\n## C++ Player Respawn Logic with Persistence\n\n```cpp\n[BaseContainerProps(category: \"Respawn\")]\nclass TAG_PersistentSpawnLogic : EPF_BaseSpawnLogic\n{\n    [Attribute(\"{37578B1666981FCE}Prefabs/Characters/Core/Character_Base.et\")]\n    ResourceName m_rDefaultPrefab;\n\n    override void OnPlayerAuditSuccess_S(int playerId)\n    {\n        super.OnPlayerAuditSuccess_S(playerId);\n\n        EPF_PersistenceManager manager = EPF_PersistenceManager.GetInstance();\n\n        // Wait for persistence to be active before spawning\n        if (manager.GetState() != EPF_EPersistenceManagerState.ACTIVE)\n        {\n            manager.GetOnActiveEvent().Insert(\n                Tuple1<int>.Create(playerId).Invoke(HandlePlayerLoad));\n            return;\n        }\n\n        HandlePlayerLoad(playerId);\n    }\n\n    void HandlePlayerLoad(int playerId)\n    {\n        // Generate consistent character ID for player\n        string characterPersistenceId = string.Format(\"character_%1\", playerId);\n\n        // Query database for existing character\n        EDF_DbContext dbContext = EPF_PersistenceManager.GetInstance().GetDbContext();\n        EPF_DbFindCallbackSingle<EPF_CharacterSaveData> callback(\n            Tuple2<int, string>.Create(playerId, characterPersistenceId)\n                .Invoke(OnCharacterDataLoaded));\n\n        EDF_DbFindCondition<EPF_CharacterSaveData> condition =\n            EDF_DbFind.Field(\"m_sId\").Equals(characterPersistenceId);\n\n        dbContext.FindFirstAsync(EPF_CharacterSaveData, callback, condition);\n    }\n\n    void OnCharacterDataLoaded(EDF_EDbOperationStatusCode statusCode,\n                                EPF_CharacterSaveData saveData,\n                                int playerId,\n                                string characterPersistenceId)\n    {\n        if (statusCode == EDF_EDbOperationStatusCode.SUCCESS && saveData)\n        {\n            LoadCharacter(playerId, characterPersistenceId, saveData);\n        }\n        else\n        {\n            CreateCharacter(playerId, characterPersistenceId);\n        }\n    }\n\n    void LoadCharacter(int playerId, string characterPersistenceId,\n                       EPF_CharacterSaveData saveData)\n    {\n        Print(string.Format(\"Loading existing character for player %1\", playerId));\n\n        // Adjust spawn position for terrain\n        vector position = saveData.m_pTransformation.m_vOrigin;\n        SCR_WorldTools.FindEmptyTerrainPosition(position, position, 2);\n        saveData.m_pTransformation.m_vOrigin = position;\n\n        // Spawn character from save-data\n        IEntity character = saveData.Spawn(isRoot: true);\n        if (!character)\n        {\n            Print(\"Failed to spawn character from save-data, creating new\",\n                  LogLevel.ERROR);\n            CreateCharacter(playerId, characterPersistenceId);\n            return;\n        }\n\n        EPF_PersistenceComponent persistence = \n            EPF_Component<EPF_PersistenceComponent>.Find(character);\n\n        // Check if async load completion is needed\n        if (EPF_DeferredApplyResult.IsPending(saveData))\n        {\n            persistence.GetOnAfterLoadEvent().Insert(\n                Tuple2<int, IEntity>.Create(playerId, character)\n                    .Invoke(OnCharacterLoadComplete));\n        }\n        else\n        {\n            OnCharacterLoadComplete(playerId, character);\n        }\n    }\n\n    void OnCharacterLoadComplete(int playerId, IEntity character)\n    {\n        Print(string.Format(\"Character load complete for player %1\", playerId));\n        HandoverToPlayer(playerId, character);\n    }\n\n    override protected void CreateCharacter(int playerId, string characterPersistenceId)\n    {\n        Print(string.Format(\"Creating new character for player %1\", playerId));\n\n        // Get spawn position\n        vector position, yawPitchRoll;\n        GetCreationPosition(playerId, characterPersistenceId, position, yawPitchRoll);\n\n        // Spawn new character entity\n        ResourceName prefab = GetCreationPrefab(playerId, characterPersistenceId);\n        IEntity character = EPF_Utils.SpawnEntityPrefab(prefab, position, yawPitchRoll);\n\n        if (!character)\n        {\n            Print(\"Failed to spawn character entity\", LogLevel.ERROR);\n            return;\n        }\n\n        // Assign persistent ID to track this character\n        EPF_PersistenceComponent persistence = \n            EPF_Component<EPF_PersistenceComponent>.Find(character);\n        persistence.SetPersistentId(characterPersistenceId);\n\n        HandoverToPlayer(playerId, character);\n    }\n\n    override void OnPlayerKilled_S(int playerId, IEntity playerEntity,\n                                   IEntity killerEntity, notnull Instigator killer)\n    {\n        super.OnPlayerKilled_S(playerId, playerEntity, killerEntity, killer);\n\n        EPF_PersistenceComponent persistence = \n            EPF_Component<EPF_PersistenceComponent>.Find(playerEntity);\n\n```\n\n## Initialize Persistence System in Game Mode (C++)\n\n```cpp\n// Add to game mode entity in World Editor\n// Configure attributes:\n// - Enable Autosave: true\n// - Autosave Interval: 600 (seconds)\n// - Autosave Iterations: 5 (entities per tick)\n// - Update Rate: 0.33 (seconds)\n// - Connection Info: EDF_JsonFileDbConnectionInfo with database name\n\n[ComponentEditorProps(category: \"Persistence\")]\nclass MyGameModeClass : SCR_BaseGameModeClass\n{\n    // EPF_PersistenceManagerComponent is attached in World Editor\n}\n\nclass MyGameMode : SCR_BaseGameMode\n{\n    override void OnGameStart()\n    {\n        super.OnGameStart();\n\n        // Access persistence manager\n        EPF_PersistenceManager manager = EPF_PersistenceManager.GetInstance();\n\n        // Subscribe to persistence becoming active\n        manager.GetOnActiveEvent().Insert(OnPersistenceActive);\n\n        // Subscribe to auto-save completion\n        manager.GetOnAutoSaveCompleteEvent().Insert(OnAutoSaveComplete);\n    }\n\n    void OnPersistenceActive()\n    {\n        Print(\"Persistence system is now active and ready\");\n    }\n\n    void OnAutoSaveComplete()\n    {\n        Print(\"Auto-save cycle completed successfully\");\n    }\n}\n```\n\n## Persist Vehicle Fuel Component State\n\n```cpp\n[EPF_ComponentSaveDataType(FuelManagerComponent), BaseContainerProps()]\nclass EPF_FuelManagerComponentSaveDataClass : EPF_ComponentSaveDataClass\n{\n}\n\n[EDF_DbName.Automatic()]\nclass EPF_FuelManagerComponentSaveData : EPF_ComponentSaveData\n{\n    ref array<ref EPF_PersistentFuelNode> m_aFuelNodes;\n\n    override EPF_EReadResult ReadFrom(IEntity owner, GenericComponent component, \n                                       EPF_ComponentSaveDataClass attributes)\n    {\n        m_aFuelNodes = {};\n\n        array<BaseFuelNode> outNodes();\n        FuelManagerComponent.Cast(component).GetFuelNodesList(outNodes);\n\n        foreach (BaseFuelNode node : outNodes)\n        {\n            SCR_FuelNode fuelNode = SCR_FuelNode.Cast(node);\n            if (!fuelNode)\n                continue;\n\n            EPF_PersistentFuelNode persistentFuelNode();\n            persistentFuelNode.m_iTankId = fuelNode.GetFuelTankID();\n            persistentFuelNode.m_fFuel = fuelNode.GetFuel();\n\n            // Skip saving defaults to reduce database size\n            if (attributes.m_bTrimDefaults)\n            {\n                // Skip if tank is full\n                if (persistentFuelNode.m_fFuel >= fuelNode.GetMaxFuel())\n                    continue;\n\n                // Skip if at initial state\n                if (float.AlmostEqual(persistentFuelNode.m_fFuel, \n                                      fuelNode.EPF_GetInitialFuelTankState()))\n                    continue;\n            }\n\n            m_aFuelNodes.Insert(persistentFuelNode);\n        }\n\n        // Return DEFAULT if no modifications to persist\n        if (m_aFuelNodes.IsEmpty())\n            return EPF_EReadResult.DEFAULT;\n\n        return EPF_EReadResult.OK;\n    }\n\n    override EPF_EApplyResult ApplyTo(IEntity owner, GenericComponent component, \n                                       EPF_ComponentSaveDataClass attributes)\n    {\n        array<BaseFuelNode> outNodes();\n        FuelManagerComponent.Cast(component).GetFuelNodesList(outNodes);\n\n        // Try index-based matching first (assume same order)\n        bool tryIdxAccess = outNodes.Count() >= m_aFuelNodes.Count();\n\n        foreach (int idx, EPF_PersistentFuelNode persistentFuelNode : m_aFuelNodes)\n        {\n            SCR_FuelNode fuelNode;\n\n            // Fast path: index match with ID verification\n            if (tryIdxAccess)\n            {\n                SCR_FuelNode idxNode = SCR_FuelNode.Cast(outNodes.Get(idx));\n                if (idxNode.GetFuelTankID() == persistentFuelNode.m_iTankId)\n                    fuelNode = idxNode;\n            }\n\n            // Slow path: iterate all nodes to find matching tank ID\n            if (!fuelNode)\n            {\n                foreach (BaseFuelNode findNode : outNodes)\n                {\n                    SCR_FuelNode findFuelNode = SCR_FuelNode.Cast(findNode);\n                    if (findFuelNode && \n                        findFuelNode.GetFuelTankID() == persistentFuelNode.m_iTankId)\n                    {\n                        fuelNode = findFuelNode;\n                        break;\n                    }\n                }\n            }\n\n            if (!fuelNode)\n            {\n                Debug.Error(string.Format(\"Unable to find fuel tank ID '%1'\", \n                                          persistentFuelNode.m_iTankId));\n                continue;\n            }\n\n            fuelNode.SetFuel(persistentFuelNode.m_fFuel);\n        }\n\n        return EPF_EApplyResult.OK;\n    }\n\n    override bool Equals(notnull EPF_ComponentSaveData other)\n    {\n        EPF_FuelManagerComponentSaveData otherData = \n            EPF_FuelManagerComponentSaveData.Cast(other);\n\n        if (m_aFuelNodes.Count() != otherData.m_aFuelNodes.Count())\n            return false;\n\n        foreach (int idx, EPF_PersistentFuelNode fuelNode : m_aFuelNodes)\n        {\n            // Try same index first (likely correct)\n            if (fuelNode.Equals(otherData.m_aFuelNodes.Get(idx)))\n                continue;\n\n            // Search other indices\n            bool found;\n            foreach (int compareIdx, EPF_PersistentFuelNode otherFuelNode :\n                     otherData.m_aFuelNodes)\n            {\n                if (compareIdx == idx)\n                    continue;\n\n                if (fuelNode.Equals(otherFuelNode))\n                {\n                    found = true;\n                    break;\n                }\n            }\n\n            if (!found)\n                return false;\n        }\n\n        return true;\n    }\n}\n\nclass EPF_PersistentFuelNode\n{\n    int m_iTankId;\n    float m_fFuel;\n\n    bool Equals(notnull EPF_PersistentFuelNode other)\n    {\n        return m_iTankId == other.m_iTankId && \n               float.AlmostEqual(m_fFuel, other.m_fFuel);\n    }\n}\n\n```\n\n## Garage Entry Management - C#\n\n```csharp\nvoid Print(string.Format(\"Vehicle retrieved from garage for player %1\", playerId));\n    }\n\n    void OnGarageEntryRemoved(EDF_EDbOperationStatusCode statusCode)\n    {\n        if (statusCode != EDF_EDbOperationStatusCode.SUCCESS)\n            Print(\"Failed to remove garage entry\", LogLevel.ERROR);\n    }\n}\n```\n\n## Define Save Data for Existing Class\n\n```cs\n[ \n    EPF_PersistentScriptedStateSettings(TAG_MyExistingCounter),\n    EDF_DbName.Automatic()\n]\nclass TAG_MyExistingCounterSaveData : EPF_ScriptedStateSaveData\n{\n    int m_iCount;\n};\n\n```",
    "library": "state_persistence_config",
    "topic": "overview",
    "source": "fuzzy_match"
  },
  "source": "fuzzy_match",
  "saved_at": "2026-01-30T16:11:00.430996"
}