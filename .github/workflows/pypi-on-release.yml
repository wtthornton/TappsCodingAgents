# Publish to PyPI whenever a release is published.
# Runs for releases created by the Release workflow (tag push) or manually (e.g. gh release create).
# Single source of truth for PyPI so we always publish when we release.
# workflow_dispatch: manually publish a tag to PyPI (e.g. when auto-publish failed or was skipped).

name: Publish to PyPI on Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag to publish (e.g. v3.5.38). Leave empty when triggered by release event.'
        required: false
        type: string

# Prevent concurrent runs for the same release (use tag or run_id for manual dispatch)
concurrency:
  group: pypi-${{ github.event.release.id || github.event.inputs.tag_name || github.run_id }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

env:
  PYTHON_VERSION: "3.13"

jobs:
  pypi-publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    # Only publish stable releases (skip alpha, beta, rc, test). Skip filter when manually dispatched.
    if: |
      github.event_name == 'workflow_dispatch' ||
      (!contains(github.event.release.tag_name, 'alpha') &&
       !contains(github.event.release.tag_name, 'beta') &&
       !contains(github.event.release.tag_name, 'rc') &&
       !contains(github.event.release.tag_name, 'test'))
    environment:
      name: pypi
      url: https://pypi.org/project/tapps-agents/
    steps:
      - name: Resolve tag to publish
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -z "${{ github.event.inputs.tag_name }}" ]; then
              echo "ERROR: Manual run requires 'tag_name' input (e.g. v3.5.38)"
              exit 1
            fi
            echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag_name=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          fi
          echo "Publishing tag: $(cat $GITHUB_OUTPUT | grep tag_name | cut -d= -f2-)"
      - name: Checkout release tag
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.tag_name }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine

      - name: Build packages
        run: |
          rm -rf dist build *.egg-info
          find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
          python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true

      - name: PyPI Summary
        run: |
          echo "## Published to PyPI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.tag.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** [tapps-agents](https://pypi.org/project/tapps-agents/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Install with: \`pip install tapps-agents\`" >> $GITHUB_STEP_SUMMARY
