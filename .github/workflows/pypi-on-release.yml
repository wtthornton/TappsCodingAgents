# Publish to PyPI whenever a release is published.
# Runs for releases created by the Release workflow (tag push) or manually (e.g. gh release create).
# Single source of truth for PyPI so we always publish when we release.

name: Publish to PyPI on Release

on:
  release:
    types: [published]

# Prevent concurrent runs for the same release
concurrency:
  group: pypi-${{ github.event.release.id }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

env:
  PYTHON_VERSION: "3.13"

jobs:
  pypi-publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    # Only publish stable releases (skip alpha, beta, rc, test)
    if: |
      !contains(github.event.release.tag_name, 'alpha') &&
      !contains(github.event.release.tag_name, 'beta') &&
      !contains(github.event.release.tag_name, 'rc') &&
      !contains(github.event.release.tag_name, 'test')
    environment:
      name: pypi
      url: https://pypi.org/project/tapps-agents/
    steps:
      - name: Checkout release tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine

      - name: Build packages
        run: |
          rm -rf dist build *.egg-info
          find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
          python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true

      - name: PyPI Summary
        run: |
          echo "## Published to PyPI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** [tapps-agents](https://pypi.org/project/tapps-agents/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Install with: \`pip install tapps-agents\`" >> $GITHUB_STEP_SUMMARY
