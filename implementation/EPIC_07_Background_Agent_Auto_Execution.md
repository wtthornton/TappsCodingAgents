# Epic 7: Background Agent Auto-Execution

## Epic Goal

Enable Background Agents to automatically read and execute command files generated by workflows, eliminating the need for manual copy-paste of Skill commands. This transforms the semi-manual workflow execution into a fully automated experience where Background Agents autonomously execute workflow steps.

## Epic Description

### Existing System Context

- **Current relevant functionality**: TappsCodingAgents creates `.cursor-skill-command.txt` files in worktrees with Skill commands (e.g., `@analyst gather-requirements ...`). The framework uses file-based coordination because Cursor doesn't have a public programmatic API for Skills. Users currently must manually copy commands from these files into Cursor chat
- **Technology stack**: Python 3.13+, Cursor Background Agents, Git worktrees, file-based coordination system
- **Integration points**: 
  - `tapps_agents/workflow/cursor_executor.py` - Creates command files
  - `tapps_agents/workflow/skill_invoker.py` - Generates Skill commands
  - `.cursor/background-agents.yaml` - Background Agent configuration
  - Worktree management system

### Enhancement Details

- **What's being added/changed**: 
  - Create Background Agent configuration that watches for `.cursor-skill-command.txt` files
  - Implement command file reader that Background Agents can use
  - Add execution status tracking (started, in-progress, completed, failed)
  - Create artifact detection system to detect when Skills complete
  - Implement polling mechanism for workflow progression
  - Add error handling and retry logic for failed executions
  - Create status reporting system for workflow progress

- **How it integrates**: 
  - Background Agents read `.cursor-skill-command.txt` files from worktrees
  - Execute commands automatically without user intervention
  - Update status files to track execution progress
  - Detect completion via artifact presence or status files
  - Workflow executor polls for completion and advances to next step
  - Works with existing worktree isolation and command generation

- **Success criteria**: 
  - Background Agents automatically execute commands from generated files
  - Workflow steps progress automatically without manual intervention
  - Execution status is tracked and visible
  - Failed steps are detected and can be retried
  - Workflow completion is detected automatically
  - No manual copy-paste required

## Stories

1. **Story 7.1: Background Agent Configuration Setup and Validation**
   - Create Background Agent configuration template for `.cursor/background-agents.yaml`
   - Implement configuration schema validation (YAML structure, required fields)
   - Add configuration generator/initializer for auto-execution setup
   - Create configuration validation tool to verify Background Agent setup
   - Add configuration documentation and examples
   - Acceptance criteria: Configuration template created, validation works, setup tool functional, documentation complete

2. **Story 7.2: Background Agent Command File Reader**
   - Create Background Agent configuration that watches for `.cursor-skill-command.txt` files
   - Implement file reader that extracts commands from generated files
   - Add command parsing logic to handle Skill command format (`@agent action params`)
   - Create command queue system for multiple pending commands
   - Implement file watching/polling mechanism for command file detection
   - Acceptance criteria: Background Agent reads command files, commands parsed correctly, queue system works, file watching reliable

3. **Story 7.3: Automatic Command Execution**
   - Implement automatic execution of parsed commands in Background Agents
   - Add execution context (worktree path, project context, workflow state)
   - Create execution wrapper that handles Cursor Skill invocation
   - Implement execution logging and tracking
   - Add execution isolation (prevent concurrent execution conflicts)
   - Acceptance criteria: Commands execute automatically, context passed correctly, execution logged, isolation maintained

4. **Story 7.4: Execution Status Tracking**
   - Create status file format (`.cursor-skill-status.json`) with schema
   - Implement status updates (pending, executing, completed, failed, retrying)
   - Add status file writer that Background Agents update atomically
   - Create status reader for workflow executor
   - Implement status file locking to prevent race conditions
   - Add status history tracking for debugging
   - Acceptance criteria: Status files created and updated, status transitions tracked correctly, status readable by executor, locking prevents conflicts

5. **Story 7.5: Artifact Detection and Completion**
   - Implement artifact detection system (expected outputs from Skills)
   - Create completion detection logic (artifact presence or status file)
   - Add polling mechanism for workflow executor to check completion
   - Implement timeout handling for stuck executions
   - Create artifact validation (verify artifacts match expected format)
   - Add completion notification system
   - Acceptance criteria: Artifacts detected correctly, completion detected reliably, timeouts handled, artifacts validated, notifications sent

6. **Story 7.6: Error Handling and Retry Logic**
   - Implement error detection from status files or execution logs
   - Create retry mechanism with exponential backoff
   - Add error reporting and notification system
   - Implement graceful failure handling (skip step, abort workflow, continue)
   - Add error categorization (transient vs permanent failures)
   - Create error recovery strategies per error type
   - Acceptance criteria: Errors detected, retries work correctly, failure handling graceful, errors reported, recovery strategies effective

7. **Story 7.7: Workflow Executor Integration**
   - Integrate auto-execution system with `CursorWorkflowExecutor`
   - Modify workflow executor to use Background Agent auto-execution when enabled
   - Add configuration option to enable/disable auto-execution
   - Implement polling integration for completion detection
   - Add workflow state synchronization with Background Agent execution
   - Maintain backward compatibility with manual execution mode
   - Acceptance criteria: Executor uses auto-execution when enabled, polling works, state synchronized, backward compatible

8. **Story 7.8: Configuration Management and Feature Flags**
   - Create configuration management system for auto-execution features
   - Implement feature flags (enable/disable auto-execution, retry logic, etc.)
   - Add configuration validation on startup
   - Create configuration migration/upgrade system
   - Add runtime configuration reload capability
   - Acceptance criteria: Configuration managed centrally, feature flags work, validation catches errors, migration handles upgrades

9. **Story 7.9: Monitoring, Logging, and Observability**
   - Implement comprehensive logging for Background Agent execution
   - Add execution metrics collection (success rate, duration, retry count)
   - Create monitoring dashboard or CLI commands for execution status
   - Implement debug mode with verbose logging
   - Add execution trace/audit log for troubleshooting
   - Create health check system for Background Agent availability
   - Acceptance criteria: Logging comprehensive, metrics collected, monitoring available, debug mode works, audit trail complete

10. **Story 7.10: Testing and Documentation**
    - Create comprehensive unit tests for all auto-execution components
    - Add integration tests for workflow executor integration
    - Implement end-to-end tests for complete workflow execution
    - Create test fixtures and mocks for Background Agent simulation
    - Write user documentation (setup guide, troubleshooting, examples)
    - Add developer documentation (architecture, API reference)
    - Create troubleshooting guide with common issues and solutions
    - Acceptance criteria: Test coverage >80%, all tests pass, documentation complete and accurate, examples work

## Compatibility Requirements

- [ ] Existing manual execution continues to work (backward compatible)
- [ ] Command file format remains unchanged
- [ ] Worktree isolation maintained
- [ ] Background Agent configuration is optional (opt-in feature)
- [ ] No breaking changes to existing workflow execution

## Risk Mitigation

- **Primary Risk**: Background Agents may not have access to command files
  - **Mitigation**: Clear documentation of Background Agent setup, file permissions check, fallback to manual execution
- **Primary Risk**: Execution may hang or fail silently
  - **Mitigation**: Timeout mechanisms, status tracking, error detection, retry logic
- **Primary Risk**: Multiple Background Agents may conflict
  - **Mitigation**: Worktree isolation, command queue, status file locking
- **Rollback Plan**: 
  - Disable Background Agent auto-execution via configuration
  - Fall back to manual execution mode
  - Remove status files to reset state

## Definition of Done

- [ ] All 10 stories completed with acceptance criteria met
- [ ] Background Agent configuration setup and validation working
- [ ] Background Agents automatically read and execute command files
- [ ] Execution status tracking works correctly
- [ ] Artifact detection and completion detection reliable
- [ ] Error handling and retry logic implemented
- [ ] Workflow executor integration complete and tested
- [ ] Configuration management system functional
- [ ] Monitoring and observability tools available
- [ ] Comprehensive test coverage (>80% for new code)
- [ ] Documentation complete (setup guide, API reference, troubleshooting, examples)
- [ ] No regression in existing workflow execution
- [ ] Manual execution mode still works (backward compatible)
- [ ] Example Background Agent configuration provided
- [ ] All integration tests passing
- [ ] Performance benchmarks meet requirements

## Story Dependencies and Recommended Order

Following BMAD methodology, stories should be implemented in this order to respect dependencies:

1. **Story 7.1** (Configuration Setup) - **Foundation** - Must be done first
2. **Story 7.2** (Command File Reader) - Depends on 7.1
3. **Story 7.3** (Automatic Execution) - Depends on 7.2
4. **Story 7.4** (Status Tracking) - Can be done in parallel with 7.3
5. **Story 7.5** (Artifact Detection) - Depends on 7.4
6. **Story 7.6** (Error Handling) - Depends on 7.3, 7.4
7. **Story 7.7** (Workflow Executor Integration) - Depends on 7.2-7.6
8. **Story 7.8** (Configuration Management) - Can be done in parallel with 7.7
9. **Story 7.9** (Monitoring & Observability) - Depends on 7.3-7.6
10. **Story 7.10** (Testing & Documentation) - **Final** - Depends on all others

**Parallel Work Opportunities:**
- Stories 7.4 and 7.3 can be done in parallel
- Story 7.8 can be done in parallel with 7.7
- Story 7.9 can start after 7.3-7.6 are complete

## Implementation Status

**Last Updated:** 2025-01-27

**Overall Status:** ✅ Completed

**Story Status:**
- Story 7.1 (Configuration Setup): ✅ Completed
- Story 7.2 (Command File Reader): ✅ Completed
- Story 7.3 (Automatic Execution): ✅ Completed
- Story 7.4 (Status Tracking): ✅ Completed
- Story 7.5 (Artifact Detection): ✅ Completed
- Story 7.6 (Error Handling): ✅ Completed
- Story 7.7 (Workflow Executor Integration): ✅ Completed
- Story 7.8 (Configuration Management): ✅ Completed
- Story 7.9 (Monitoring & Observability): ✅ Completed
- Story 7.10 (Testing & Documentation): ✅ Completed

**Story Count:** 10 stories (5 original + 5 new stories added per BMAD methodology)

**Notes:**
- Original epic had 5 stories covering core functionality
- Added 5 additional stories following BMAD methodology to ensure completeness:
  - Story 7.1: Configuration setup (foundational, should be first)
  - Story 7.7: Workflow executor integration (critical integration point)
  - Story 7.8: Configuration management (operational requirement)
  - Story 7.9: Monitoring and observability (production readiness)
  - Story 7.10: Testing and documentation (quality assurance)

