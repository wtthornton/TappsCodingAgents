# Story 2.6: Agent Contract Tests & Backward Compatibility Harness

<!-- Source: implementation/cursor/EPIC_02_Core_Agents.md -->
<!-- Context: Brownfield hardening via contract tests + golden workflows -->

## Status

Draft

## Story

**As a** maintainer of the workflow engine,
**I want** contract tests and a backward-compatibility harness for agent inputs/outputs,
**so that** we can evolve agents and orchestration safely without breaking existing workflows or artifact expectations.

## Acceptance Criteria

1. For each agent class (and/or each workflow-relevant command), there is a contract test that validates:
   - required inputs are accepted (including existing aliases)
   - output is JSON-serializable
   - output includes `schema_version` and stable required fields
   - errors are returned in a consistent, machine-readable way
2. Workflow execution writes required artifacts/status/errors in agreed schemas (best-effort in fallback paths).
3. A golden-path workflow test exercises a mixed set of agents and verifies step chaining and artifact passing works.
4. Backward compatibility is enforced: existing workflows and current tests continue to pass.
5. Contract tests are structured so real external calls are gated (e.g., Context7 real API tests remain guarded by env vars, as in `tests/integration/test_context7_real.py`).

## Tasks / Subtasks

- [ ] Task 1: Inventory existing test coverage and gaps (AC: 1–4)
  - [ ] Review `tests/unit/test_agent_base.py` (base behavior)
  - [ ] Review `tests/unit/test_workflow_executor.py` (workflow state + expert consult)
  - [ ] Review existing agent integration tests under `tests/integration/`

- [ ] Task 2: Define contract requirements per agent (AC: 1)
  - [ ] Define required output envelope: `schema_version`, `status`, `artifacts`, `errors` (as applicable)
  - [ ] Define agent-specific required fields (reviewer scoring, planner plans, etc.)

- [ ] Task 3: Implement contract test suite (AC: 1, 5)
  - [ ] Add unit-style contract tests per agent in `tests/unit/` with mocked MAL where needed
  - [ ] Add JSON-schema-like assertions (shape checks) and serialization checks

- [ ] Task 4: Add golden-path workflow harness (AC: 2–4)
  - [ ] Execute a minimal workflow through `WorkflowExecutor.execute()` and/or Cursor executor path in a controlled environment
  - [ ] Assert artifacts are created and state transitions are correct

- [ ] Task 5: Enforce backwards compatibility (AC: 4)
  - [ ] Ensure existing workflow presets remain compatible
  - [ ] Add regression assertions for key outputs used by gating/aggregation

## Dev Notes

### Existing System Context

- Base agent behavior is tested in `tests/unit/test_agent_base.py`.
- Workflow executor behavior is tested in `tests/unit/test_workflow_executor.py`.
- There are many integration tests per agent under `tests/integration/` (e.g., `test_reviewer_agent.py`, `test_planner_agent.py`, `test_enhancer_agent.py`).
- Real Context7 tests already follow an env-var gating pattern (`tests/integration/test_context7_real.py`).

### Integration Approach

- Prefer “shape + serialization” contract tests over brittle snapshot tests.
- Keep contracts additive during migration (don’t remove existing keys; add `schema_version` and required envelopes).

### Risk Assessment

- **Primary risk**: contract suite becomes too strict and slows iteration.
- **Mitigation**: define a minimal required envelope and allow agent-specific optional fields.

### Rollback Plan

- If needed, downgrade strictness (warnings instead of failures) temporarily while migrating legacy outputs, then re-enable hard checks.

### Testing

- Unit tests: fast, mocked dependencies.
- Integration tests: limited scope, focused on verifying artifact creation and workflow chaining.

## Change Log

| Date       | Version | Description                           | Author      |
| ---------- | ------- | ------------------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 2.6            | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
