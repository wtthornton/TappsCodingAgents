# Story 2.5: Parallel Execution & Result Aggregation

<!-- Source: implementation/cursor/EPIC_02_Core_Agents.md -->
<!-- Context: Enable bounded parallel agent execution and deterministic aggregation -->

## Status

Draft

## Story

**As a** workflow/orchestrator runner,
**I want** to run up to 8 agent tasks in parallel with deterministic aggregation and conflict reporting,
**so that** workflows complete faster while remaining reproducible and safe under concurrent execution.

## Acceptance Criteria

1. The workflow execution path supports bounded parallelism (target max concurrency: 8) with cancellation and per-task timeouts.
2. Parallel runs operate in isolated worktrees and do not corrupt shared state.
3. Aggregation is deterministic:
   - stable ordering rules
   - explicit merge policies
   - clear conflict detection/reporting for overlapping outputs
4. Executor/orchestrator records lifecycle events and results per task/step into persisted workflow state without breaking existing persistence.
5. On failure, the workflow ends in a clear terminal state and includes per-task errors; partial results remain accessible.
6. Tests cover parallel scheduling, deterministic aggregation ordering, and conflict detection.

## Tasks / Subtasks

- [ ] Task 1: Identify current execution entrypoints (AC: 1, 4)
  - [ ] Review `tapps_agents/workflow/executor.py` (headless + routing)
  - [ ] Review `tapps_agents/workflow/cursor_executor.py` (Cursor mode)
  - [ ] Review `tapps_agents/agents/orchestrator/agent.py` for orchestration commands

- [ ] Task 2: Implement bounded parallel scheduling (AC: 1)
  - [ ] Use structured concurrency (`asyncio.TaskGroup`) for parallel runs
  - [ ] Add per-task timeout and cancellation propagation

- [ ] Task 3: Ensure worktree isolation integration (AC: 2)
  - [ ] Ensure each parallel task receives its own worktree (Epic 1 worktree manager)
  - [ ] Verify artifacts are copied/extracted per task without cross-contamination

- [ ] Task 4: Deterministic aggregation + conflict reporting (AC: 3, 5)
  - [ ] Define merge rules for common artifact types (JSON, markdown summaries, reports)
  - [ ] Detect conflicting modifications and emit a structured conflict report artifact

- [ ] Task 5: Persist task-level results and errors (AC: 4â€“5)
  - [ ] Record per-task status/result/error in workflow state structures

- [ ] Task 6: Tests (AC: 6)
  - [ ] Unit tests for scheduling + aggregation determinism
  - [ ] Regression tests for sequential mode unchanged behavior

## Dev Notes

### Existing System Context

- Headless execution is implemented by `tapps_agents/workflow/executor.py`.
- Cursor-mode execution is implemented by `tapps_agents/workflow/cursor_executor.py` and currently executes steps sequentially with polling.
- Workflow state persistence is under `.tapps-agents/workflow-state/` and is handled (when enabled) by `tapps_agents/workflow/state_manager.py` via `AdvancedStateManager`.

### Integration Approach

- Add a parallel execution primitive that can be enabled incrementally while preserving the existing sequential flow.
- Keep all shared state updates deterministic by applying task results in a stable order.

### Risk Assessment

- **Primary risk**: concurrency bugs when multiple tasks update shared workflow state.
- **Mitigation**: isolate execution in worktrees; funnel all state mutations through a single coordination point.

### Rollback Plan

- Disable parallel execution flag and revert to sequential execution without changing workflow definitions.

### Testing

- Extend `tests/unit/test_workflow_executor.py` with deterministic ordering assertions.
- Add focused tests that simulate parallel completion and conflict scenarios.

## Change Log

| Date       | Version | Description                           | Author      |
| ---------- | ------- | ------------------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 2.5            | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
