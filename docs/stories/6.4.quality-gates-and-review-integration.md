# Story 6.4: Quality Gates & Review Integration

<!-- Source: implementation/cursor/EPIC_06_Quality_Testing.md -->
<!-- Context: Enforce thresholds in workflows + integrate with Review Agent decisions -->

## Status

Draft

## Story

**As a** workflow orchestrator,
**I want** configurable quality gates that evaluate scoring thresholds (overall + metric minimums) and integrate with the Reviewer agent,
**so that** workflows can automatically route (pass/fail) based on objective quality signals.

## Acceptance Criteria

1. Workflow steps can declare scoring thresholds (e.g., `scoring.thresholds.overall_min`, `security_min`, `maintainability_min`, etc.) and gates can evaluate them consistently.
2. Gate evaluation supports at least:
   - `scoring.passed == true/false`
   - direct threshold checks on `overall_score` and specific metric minimums
3. The Reviewer agent returns enough structured scoring data for gate evaluation:
   - overall score
   - the canonical five metrics
   - (optional) additional metrics, without breaking the gate contract
4. Workflow execution uses gate outcomes to route to `on_pass` / `on_fail` step targets deterministically.
5. Quality reports are generated for gate-related review steps (machine-readable + human-readable), and included in workflow artifacts when requested.
6. Tests cover gate evaluation logic and end-to-end workflow routing decisions in a lightweight manner (mocked agent outputs).

## Tasks / Subtasks

- [ ] Task 1: Align workflow schema with gate/scoring contract (AC: 1)
  - [ ] Ensure parser validates gate routing targets and scoring threshold shapes
  - [ ] Define which threshold keys are supported and their types

- [ ] Task 2: Implement threshold-based gate evaluation (AC: 2, 4)
  - [ ] Extend orchestrator gate evaluation to handle metric thresholds (not just `overall_score`)
  - [ ] Ensure gate evaluation is deterministic and produces actionable errors for unsupported expressions

- [ ] Task 3: Ensure Reviewer outputs are compatible (AC: 3)
  - [ ] Confirm `ReviewerAgent` output contains the required keys and types

- [ ] Task 4: Produce quality reports as artifacts (AC: 5)
  - [ ] Leverage existing `ReviewerAgent.generate_reports()` and/or report generator for markdown/json outputs
  - [ ] Ensure workflows can include report paths in `creates`

- [ ] Task 5: Tests (AC: 6)
  - [ ] Add unit tests for gate evaluation and threshold checks
  - [ ] Add a workflow routing test (mock scoring payloads) to ensure `on_pass`/`on_fail` branching works

## Dev Notes

### Existing System Context

- Workflows already declare thresholds and gates in YAML presets (examples under `tapps_agents/resources/workflows/presets/`), e.g.:
  - `full-sdlc.yaml` uses `scoring.thresholds` and `gate.condition: "scoring.passed == true"`.
- Gate evaluation exists today but is limited/simplified:
  - `tapps_agents/agents/orchestrator/agent.py::_make_gate_decision()` supports `scoring.passed` and a basic `overall_score >= N` parse.
- Workflow executor supports gate routing targets:
  - `tapps_agents/workflow/executor.py` reads `gate.on_pass` / `gate.on_fail` for reviewer steps.
- Reviewer scoring already exists:
  - `tapps_agents/agents/reviewer/agent.py` computes `scores = CodeScorer.score_file(...)` and sets `passed` using `quality_threshold`.

### Integration Approach

- Make the YAML `scoring.thresholds` the single source of truth for gate thresholds inside workflows.
- Ensure gate evaluation uses structured scoring data from the reviewer step (not brittle string parsing).

### Risk Assessment

- **Risk**: Inconsistent thresholds between config and workflow YAML cause confusion.
- **Mitigation**: Document precedence rules (workflow step thresholds override global defaults for that run) and include them in generated reports.

### Rollback Plan

- Fall back to the current simple gate behavior (`scoring.passed` only), while preserving any schema validation and tests.

### Testing

- Use `pytest`.
- Add new unit tests around gate evaluation and routing.

## Change Log

| Date       | Version | Description                | Author      |
| ---------- | ------- | -------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 6.4 | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
