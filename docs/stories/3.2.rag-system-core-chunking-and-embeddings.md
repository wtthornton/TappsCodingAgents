# Story 3.2: RAG System Core (Chunking & Embeddings)

<!-- Source: implementation/cursor/EPIC_03_Expert_System.md -->
<!-- Context: Add optional vector RAG backend while preserving SimpleKnowledgeBase fallback -->

## Status

Draft

## Story

**As an** expert agent providing domain guidance,
**I want** a pluggable RAG backend with deterministic chunking and embeddings,
**so that** expert knowledge retrieval is accurate, fast (<2s), and can degrade gracefully when vector tooling is unavailable.

## Acceptance Criteria

1. RAG remains optional and backward compatible: if vector dependencies are unavailable, experts continue using the existing file-based `SimpleKnowledgeBase` retrieval.
2. A chunking component exists that can split markdown knowledge sources into chunks targeting ~512 tokens with ~50 token overlap (or equivalent approximation), preserving file/line provenance for citations.
3. An embeddings component exists behind an interface (so the project can swap providers), and it can be invoked to embed all chunks for indexing.
4. Index build artifacts are persisted deterministically under a project-local directory (e.g., `.tapps-agents/knowledge_index/`), including an explicit `schema_version` / metadata (source set fingerprint, chunk params).
5. Index build and query are time-bounded; retrieval completes in <2s average for the built-in knowledge set on typical developer hardware (measured and reported).
6. Tests cover chunking determinism and the “deps missing → fallback” behavior.

## Tasks / Subtasks

- [ ] Task 1: Audit current RAG implementation and extension points (AC: 1)
  - [ ] Review `tapps_agents/experts/simple_rag.py` and `BaseExpert._initialize_rag`
  - [ ] Identify where to add a pluggable backend without breaking expert APIs

- [ ] Task 2: Define RAG interfaces (AC: 2–4)
  - [ ] Define `Chunker` interface (input: markdown text + source, output: chunks with provenance)
  - [ ] Define `Embedder` interface (batch embed, deterministic output ordering)
  - [ ] Define `VectorIndex` interface (build, persist, load)

- [ ] Task 3: Implement chunking (AC: 2, 6)
  - [ ] Implement markdown-aware chunking with overlap
  - [ ] Ensure stable chunk IDs and reproducible ordering

- [ ] Task 4: Implement embeddings + index build (AC: 3–5)
  - [ ] Implement embeddings behind an adapter; document required optional deps
  - [ ] Implement an index builder + persistence format with metadata + schema_version
  - [ ] Add timeout/cancellation boundaries for indexing

- [ ] Task 5: Fallback and performance instrumentation (AC: 1, 5)
  - [ ] Add explicit “backend selected” and latency metrics/logs
  - [ ] Ensure <2s target is measurable (basic benchmark test or harness)

- [ ] Task 6: Tests (AC: 6)
  - [ ] Add unit tests for chunking determinism
  - [ ] Add tests that skip when optional deps are absent and assert fallback to `SimpleKnowledgeBase`

## Dev Notes

### Existing System Context

- Current RAG is keyword/context extraction in `tapps_agents/experts/simple_rag.py`.
- Experts use it via `tapps_agents/experts/base_expert.py::_initialize_rag` and `_build_domain_context`.
- RAG size/limits are configured in `tapps_agents/core/config.py::ExpertConfig` (`rag_max_length`, `rag_max_results`).

### Integration Approach

- Introduce a **pluggable** retrieval backend (vector vs simple) behind a narrow interface and keep `BaseExpert` as the single integration point.
- Persist indexes under `.tapps-agents/` so they are project-local and don’t pollute the package tree.

### Risk Assessment

- **Risk**: heavy dependencies (FAISS/transformers) increase install friction.
- **Mitigation**: make vector RAG optional (extras), retain the existing `SimpleKnowledgeBase` path, and skip vector tests when deps are absent.

### Rollback Plan

- Disable vector backend selection and keep `SimpleKnowledgeBase` as the only backend.

### Testing

- Follow patterns in `tests/unit/experts/test_simple_rag.py`.

### Context7 Note

- Epic work that introduces external libraries should be documented via KB-first calls; current Context7 API access may be unavailable (Unauthorized), so implementation should handle missing Context7 gracefully.

## Change Log

| Date       | Version | Description                    | Author      |
| ---------- | ------- | ------------------------------ | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 3.2     | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
