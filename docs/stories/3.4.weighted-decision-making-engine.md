# Story 3.4: Weighted Decision-Making Engine

<!-- Source: implementation/cursor/EPIC_03_Expert_System.md -->
<!-- Context: Make aggregation deterministic, explainable, and driven by the 51/49 weighting model -->

## Status

Draft

## Story

**As a** workflow agent receiving multiple expert recommendations,
**I want** a deterministic weighted decision-making engine with measurable agreement,
**so that** primary experts (51%) guide outcomes while other experts contribute in a transparent and auditable way.

## Acceptance Criteria

1. Weighted aggregation honors the 51% primary expert model and remaining weights for supporting experts, using the configured weight matrix when available.
2. Aggregation output is deterministic and includes machine-readable fields for:
   - selected primary expert
   - weights used per expert
   - per-expert responses and any errors
   - aggregated answer
3. Agreement calculation is improved beyond naive token overlap:
   - uses semantic similarity when vector embeddings are available
   - falls back to the current simple similarity when not
4. Confidence computation remains consistent with `tapps_agents/core/config.py::ExpertConfig` weights and thresholds.
5. Unit tests cover weighting correctness, determinism, and agreement behavior.

## Tasks / Subtasks

- [ ] Task 1: Audit current aggregation + agreement implementation (AC: 1â€“4)
  - [ ] Review `tapps_agents/experts/expert_registry.py::_aggregate_responses` and `_calculate_agreement`
  - [ ] Review `tapps_agents/experts/weight_distributor.py` and domain weight matrix generation
  - [ ] Review `tapps_agents/experts/confidence_calculator.py` (confidence weighting inputs)

- [ ] Task 2: Define machine-readable aggregation contract (AC: 2)
  - [ ] Extend `ConsultationResult` or add a parallel structured payload for weights and decisions
  - [ ] Ensure stable field names and ordering

- [ ] Task 3: Implement semantic agreement (AC: 3)
  - [ ] Reuse the embeddings backend from Story 3.2 when available
  - [ ] Implement fallback to `_simple_similarity` when not

- [ ] Task 4: Tests (AC: 5)
  - [ ] Extend `tests/unit/experts/test_weight_distributor.py` and `tests/unit/experts/test_dual_layer_registry.py`
  - [ ] Add deterministic aggregation tests (ordering, stable output)

## Dev Notes

### Existing System Context

- Weight matrix logic exists in `tapps_agents/experts/weight_distributor.py` and `tapps_agents/experts/domain_config.py`.
- Aggregation + agreement are implemented in `tapps_agents/experts/expert_registry.py`.
- Confidence calculation uses agreement and RAG quality in `tapps_agents/experts/confidence_calculator.py` with config from `tapps_agents/core/config.py::ExpertConfig`.

### Integration Approach

- Keep `ExpertRegistry.consult()` as the public API and enhance internals to:
  - compute weights consistently
  - emit machine-readable metadata
  - optionally compute semantic agreement via vector embeddings

### Risk Assessment

- **Risk**: semantic similarity adds latency.
- **Mitigation**: cache embeddings for expert answers per consultation and apply tight timeouts.

### Rollback Plan

- Revert semantic similarity and keep existing `_simple_similarity` logic.

### Testing

- Use existing async test patterns in `tests/unit/experts/test_dual_layer_registry.py`.

## Change Log

| Date       | Version | Description                    | Author      |
| ---------- | ------- | ------------------------------ | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 3.4     | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
