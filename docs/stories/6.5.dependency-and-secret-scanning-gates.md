# Story 6.5: Dependency & Secret Scanning Gates

<!-- Source: implementation/cursor/EPIC_06_Quality_Testing.md -->
<!-- Context: Dependency vuln scanning + secret scanning + auditable overrides -->

## Status

Draft

## Story

**As a** security-conscious workflow pipeline,
**I want** dependency vulnerability scanning and secret scanning to run as quality gates with an auditable override process,
**so that** high-risk issues are caught early without blocking legitimate urgent fixes indefinitely.

## Acceptance Criteria

1. Dependency vulnerability scanning is available as part of the quality pipeline:
   - Produces a machine-readable report (json) and a human-readable summary (markdown).
   - Can gate workflows on high/critical (configurable) vulnerabilities.
2. Secret scanning is available as part of the quality pipeline:
   - Detects common secret patterns (API keys, tokens, private keys) in code + generated artifacts.
   - Supports allowlisting/suppressions with justification and audit trail.
3. Both gates are configurable and can run in **soft** (warn) or **hard** (fail) mode.
4. Workflows/presets can include these scans and route on results.
5. Tests cover:
   - dependency audit parsing + gating behavior
   - secret scan rule evaluation on synthetic fixtures

## Tasks / Subtasks

- [ ] Task 1: Dependency audit gate (AC: 1, 3)
  - [ ] Use existing `DependencyAnalyzer.run_security_audit()` (pip-audit) as the primary mechanism
  - [ ] Define severity mapping and gate decision rules (block on configurable min severity)
  - [ ] Emit JSON + markdown outputs

- [ ] Task 2: Secret scanning gate (AC: 2–3)
  - [ ] Implement a deterministic secret scanner for:
    - high-signal regex patterns (JWTs, AWS keys, private keys, generic tokens)
    - known file types to include/exclude
  - [ ] Add allowlist/suppression file (with reason + expiry)
  - [ ] Ensure the scan includes generated artifacts (e.g., reports, docs) and not just source code

- [ ] Task 3: Workflow integration (AC: 4)
  - [ ] Provide workflow-step-compatible outputs (`passed`, `issues`, `counts`) so orchestrator gate evaluation can branch
  - [ ] Update preset workflows to include dependency/secret scans where appropriate

- [ ] Task 4: Tests (AC: 5)
  - [ ] Unit tests for pip-audit result parsing and gate threshold behavior
  - [ ] Unit tests for secret scanner detection and suppression behavior

## Dev Notes

### Existing System Context

- Dependency auditing exists today:
  - `tapps_agents/agents/ops/dependency_analyzer.py::DependencyAnalyzer.run_security_audit()` runs pip-audit and normalizes output.
  - `tapps_agents/agents/ops/agent.py` exposes `*audit-dependencies` and `*check-vulnerabilities`.
  - `ReviewerAgent` already blends dependency health into security scoring (`dependency_security_score`).
- Secret scanning is not currently implemented as a deterministic gate:
  - Ops `*security-scan` prompt includes “hardcoded secrets” as a category, but it is LLM-driven and not a strict CI-style gate.

### Integration Approach

- Keep dependency scanning tool-driven (pip-audit) with clear, structured outputs.
- Implement secret scanning with deterministic rules first; optionally add external-tool integrations later.
- Ensure all outputs are safe (no leaking detected secrets into logs/artifacts beyond redacted fingerprints).

### Risk Assessment

- **Risk**: False positives from secret scanning.
- **Mitigation**: Allowlist/suppressions with audit trail + expiry; prefer high-precision detectors initially.

### Rollback Plan

- Run scans in soft mode (warn-only) or disable gates via configuration.

### Testing

- Use `pytest`.
- Add synthetic fixtures containing dummy tokens/keys for detection tests.

## Change Log

| Date       | Version | Description                | Author      |
| ---------- | ------- | -------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 6.5 | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
