# Story 3.5: Expert Consultation Integration

<!-- Source: implementation/cursor/EPIC_03_Expert_System.md -->
<!-- Context: Ensure Design/Code agents consult experts safely and measurably -->

## Status

Draft

## Story

**As a** user running Design and Code workflows,
**I want** the Designer and Implementer agents to consult relevant experts using the registry,
**so that** architecture, security, privacy, UX, and performance guidance is incorporated when confidence is sufficient.

## Acceptance Criteria

1. Designer and Implementer agents consult experts through the shared registry integration (no ad-hoc expert wiring) and do not crash when experts are unavailable.
2. Expert guidance is only applied when the returned confidence meets the agent-specific threshold (`tapps_agents/core/config.py::ExpertConfig.agent_confidence_thresholds`).
3. Agent outputs clearly indicate:
   - whether expert consultation ran
   - which expert domains were consulted
   - citations/sources where available
4. At least 2–3 customer/industry experts can be configured per project via `.tapps-agents/experts.yaml` (or domains.md-driven generation) and are queryable.
5. Integration tests validate that:
   - consultation happens when configured
   - consultation is skipped when registry is missing
   - confidence gating works

## Tasks / Subtasks

- [ ] Task 1: Audit current integration in Design/Code agents (AC: 1–2)
  - [ ] Review `tapps_agents/agents/designer/agent.py` expert consultation usage
  - [ ] Review `tapps_agents/agents/implementer/agent.py` expert consultation usage
  - [ ] Ensure both rely on `ExpertSupportMixin` initialization (`activate()` path)

- [ ] Task 2: Standardize confidence gating + output reporting (AC: 2–3)
  - [ ] Use `ConsultationResult.confidence` vs `confidence_threshold` consistently
  - [ ] Add a standard “expert_consultation” result payload (domains consulted, confidence, sources)

- [ ] Task 3: Project-level expert configs (AC: 4)
  - [ ] Provide example `.tapps-agents/experts.yaml` with 2–3 customer experts
  - [ ] Ensure project knowledge location is consistent with `BaseExpert._initialize_rag` (currently `.tapps-agents/knowledge/...`)

- [ ] Task 4: Integration tests (AC: 5)
  - [ ] Add tests under `tests/unit/experts/` and/or `tests/integration/` for agent consultation behavior
  - [ ] Mock expert responses to assert gating and output fields

## Dev Notes

### Existing System Context

- Agents already include `ExpertSupportMixin`:
  - `tapps_agents/agents/designer/agent.py` consults data privacy, UX, and accessibility domains.
  - `tapps_agents/agents/implementer/agent.py` consults security and performance domains.
- Expert mixin and init logic: `tapps_agents/experts/agent_integration.py`.
- Confidence gating configuration: `tapps_agents/core/config.py::ExpertConfig`.

### Integration Approach

- Consolidate “how to consult” into common helpers (mixin/registry) so every agent uses the same gating and result reporting.

### Risk Assessment

- **Risk**: excessive expert calls increase latency.
- **Mitigation**: limit consultations to high-impact steps, reuse cached advice where possible (see `tapps_agents/core/best_practice_consultant.py`).

### Rollback Plan

- Disable expert consultation via config/feature flag and fall back to agent-only prompts.

### Testing

- Reuse patterns from existing expert tests (e.g., `tests/unit/experts/test_dual_layer_registry.py`).

## Change Log

| Date       | Version | Description                    | Author      |
| ---------- | ------- | ------------------------------ | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 3.5     | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
