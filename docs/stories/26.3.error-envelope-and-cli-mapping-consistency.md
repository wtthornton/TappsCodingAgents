# Story 26.3: Error envelope and CLI mapping consistency

<!-- Source: implementation/cursor/EPIC_26_Core_Maintainability_Unify_Errors_And_Validation.md -->
<!-- Context: Ensure consistent structured errors and stable CLI exit-code mapping across agents and commands -->

## Status

Draft

## Story

**As a** CLI user and automation author,  
**I want** consistent structured error envelopes and predictable exit codes,  
**so that** failures are machine-detectable, stable across releases, and easy for humans to diagnose.

## Acceptance Criteria

1. All relevant errors map to structured envelopes with stable **error codes** and **categories**.
2. CLI consistently converts failures into **non-zero exit codes** and preserves a stable JSON output contract for errors (align with Epic 22).
3. “User-facing” vs “internal” errors are clearly distinguished and mapped consistently (e.g., validation/usage errors vs unexpected internal failures).
4. Error mapping preserves existing behavior/semantics; changes are limited to standardization and clarity (no scope expansion).

## Tasks / Subtasks

- [ ] Task 1: Audit current error envelope + CLI mapping behaviors (AC: 1–3)
  - [ ] Identify where errors are enveloped today (core utilities, base agent, CLI)
  - [ ] Inventory error codes/categories in use (and gaps/duplicates)
  - [ ] Identify where exit codes are set (and whether mappings differ across commands)

- [ ] Task 2: Define the canonical mapping rules (AC: 1–3)
  - [ ] Define “user-facing” vs “internal” classification rules and examples
  - [ ] Define stable codes/categories for validation, filesystem, config, and unexpected errors
  - [ ] Define CLI exit-code mapping for those categories (documented)

- [ ] Task 3: Implement/centralize mapping and adopt everywhere (AC: 1–4)
  - [ ] Ensure agent exceptions map into stable envelopes
  - [ ] Ensure CLI entrypoint uses a single mapping path for:
    - JSON output envelope
    - text error output
    - exit code selection
  - [ ] Remove ad-hoc error formatting/mapping code paths where feasible

- [ ] Task 4: Contract tests for stability (AC: 1–2)
  - [ ] Add tests validating representative failure cases produce stable envelope fields/codes
  - [ ] Add tests validating exit codes across a small set of representative CLI commands

## Dev Notes

### Existing System Context

- An “error envelope” system exists for structured error reporting.
- Epic 26 explicitly references aligning CLI behavior with Epic 22’s contract expectations.

### Integration Approach

- Prefer a single mapping module/helper used by both `BaseAgent` error conversion and CLI command wrappers.
- Keep envelope shape additive/backwards-compatible where possible.

### Risk Assessment

- **Risk**: Subtle output changes break scripts depending on exact message text/shape.
- **Mitigation**: Preserve existing fields; add contract tests; document any intentional, minimal changes.

### Rollback Plan

- Revert to previous mapping rules while keeping centralized validation improvements from Story 26.2.

### Testing

- Subprocess/contract-style tests for CLI error output + exit codes (reuse existing patterns from Epic 22 stories).

## Change Log

| Date       | Version | Description                         | Author      |
| ---------- | ------- | ----------------------------------- | ----------- |
| 2025-12-16 | 0.1     | Initial draft for Epic 26.3         | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_


