# Story 21.3: Eliminate Dependency Drift Between Sources

<!-- Source: implementation/cursor/EPIC_21_Dependency_And_Packaging_Alignment.md -->
<!-- Context: Prevent setup.py/requirements.txt from diverging from pyproject.toml; add drift guardrails -->

## Status

Complete

## Story

**As a** maintainer,
**I want** drift between dependency definitions to be impossible or immediately detected,
**so that** packaging changes cannot silently break installs or CI over time.

## Acceptance Criteria

1. `setup.py` cannot define a dependency set that differs from `pyproject.toml` (either by removing dependency definitions from `setup.py`, or enforcing strict consistency).
2. If `requirements.txt` is retained, its role is non-authoritative and drift is prevented (generated from `pyproject.toml` or validated against it).
3. A “dependency drift” check is documented and runs in CI, failing when sources disagree per the project policy.
4. The drift check is fast and deterministic and provides an actionable error message (what differed and how to fix).
5. The check covers both:
   - runtime dependencies
   - extras (`dev`/`test`/`e2e` as defined)

## Tasks / Subtasks

- [x] Task 1: Choose drift strategy consistent with the policy (AC: 1–2)
  - [x] Option A: remove dependency declarations from `setup.py` and keep it minimal (or eliminate if not needed)
  - [x] Option B: enforce `setup.py` reads from `pyproject.toml` and cannot drift
  - [x] For `requirements.txt`: decide remove vs generated artifact (kept as convenience, validated)

- [x] Task 2: Implement drift detection (AC: 3–5)
  - [x] Add a script/tooling that compares expected dependency sets to actual sources
  - [x] Ensure it validates runtime + extras
  - [x] Ensure output is actionable (diff-like)

- [x] Task 3: Wire drift check into CI + document (AC: 3–4)
  - [x] Add to `.github/workflows/ci.yml` (and/or shared workflow)
  - [x] Document in `docs/DEVELOPER_GUIDE.md` and `CONTRIBUTING.md`

## Dev Notes

### Existing System Context

- Multiple dependency sources exist today (`pyproject.toml`, `setup.py`, `requirements.txt`), which can drift.
- CI and contributor workflows currently rely on different install patterns.

### Integration Approach

- Prefer eliminating duplication rather than validating duplication where possible.
- If duplication must remain, enforce it with a CI drift gate so “source of truth” remains real in practice.

### Risk Assessment

- **Risk**: drift check becomes flaky or too strict, blocking legitimate changes.
- **Mitigation**: keep checks deterministic, narrowly scoped to declared policy, and produce clear fix instructions.

### Rollback Plan

- Remove the CI gate and revert scripts if it blocks work, keeping documentation updates and revisiting scope.

### Testing

- Validate drift check behavior with representative cases:
  - clean pass case
  - intentional mismatch (runtime)
  - mismatch in extras

## Change Log

| Date       | Version | Description                           | Author      |
| ---------- | ------- | ------------------------------------- | ----------- |
| 2025-12-16 | 0.1     | Initial draft for Epic 21.3           | bmad-master |
| 2025-01-XX | 1.0     | Completed - drift detection implemented and CI check added | Auto |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- Updated `setup.py` to be minimal stub (no dependency definitions, reads from pyproject.toml)
- Created `scripts/validate_dependencies.py` to detect drift between sources
- Added dependency drift check job to `.github/workflows/ci.yml`
- Validation script checks: setup.py doesn't define install_requires, requirements.txt matches pyproject.toml
- All acceptance criteria met: setup.py cannot drift, requirements.txt validated, CI check runs, actionable error messages

### File List

- `setup.py` (updated - minimal stub)
- `scripts/validate_dependencies.py` (new)
- `.github/workflows/ci.yml` (updated - added drift check job)
- `docs/DEVELOPER_GUIDE.md` (updated)
- `CONTRIBUTING.md` (updated)

## QA Results

_TBD_


