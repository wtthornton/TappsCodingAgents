# Story 7.2: Robust Error Handling

<!-- Source: implementation/cursor/EPIC_07_Documentation_Polish.md -->
<!-- Context: Standardize errors, graceful degradation, and recovery across agents + workflows -->

## Status

Draft

## Story

**As a** workflow operator,
**I want** consistent error handling and user-friendly failure modes across agents and the workflow engine,
**so that** runs fail predictably, can be resumed when possible, and are easy to troubleshoot.

## Acceptance Criteria

1. A consistent **error envelope** is defined for agent results and workflow step failures (machine-readable fields + human-readable message) and used across major agent entry points.
2. Error handling supports **graceful degradation** for common “optional dependency” scenarios (e.g., Context7 unavailable/disabled, MAL disabled in Cursor mode, missing optional tools) without corrupting workflow state.
3. Workflow step execution records enough failure context for debugging while remaining safe:
   - error type/category (e.g., configuration, external dependency, validation, execution)
   - sanitized error message (no secrets)
   - correlation identifiers (workflow_id/step_id/agent)
4. Workflow state persistence remains recoverable on failures:
   - failed steps are recorded deterministically
   - state history/recovery mechanisms remain functional
5. CLI error output is actionable (points to next steps and relevant docs), and exits with non-zero status codes for failure conditions.
6. Tests cover representative failure modes (agent error result, workflow step exception, and a recoverable resume path).

## Tasks / Subtasks

- [ ] Task 1: Define standard error schema/envelope (AC: 1, 3)
  - [ ] Define fields such as `error.code`, `error.message`, `error.details` (optional), and correlation fields
  - [ ] Decide how errors propagate: agent returns `{"error": ...}` vs raising typed exceptions vs both

- [ ] Task 2: Normalize agent-side error handling (AC: 1, 2)
  - [ ] Apply consistent patterns to core agents’ `run()` dispatch (returning structured errors)
  - [ ] Ensure optional dependencies fail gracefully with clear messages

- [ ] Task 3: Normalize workflow step failure recording (AC: 3, 4)
  - [ ] Ensure step failure stores a safe error summary + category
  - [ ] Verify state persistence and recovery remain intact

- [ ] Task 4: Improve CLI UX for errors (AC: 5)
  - [ ] Map common exceptions to actionable messages
  - [ ] Ensure exit codes reflect failure

- [ ] Task 5: Tests (AC: 6)
  - [ ] Add unit tests for error envelope creation and redaction
  - [ ] Add/extend workflow tests for step failure capture + resume

## Dev Notes

### Existing System Context

- Custom exception taxonomy exists in `tapps_agents/core/exceptions.py` (e.g., `WorkflowExecutionError`, `ConfigurationError`, `Context7UnavailableError`, `MALDisabledInCursorModeError`).
- Workflow execution already records per-step status and error strings:
  - `tapps_agents/workflow/executor.py` sets `StepExecution.status = "failed"` and `StepExecution.error = str(e)` on exceptions.
  - `tapps_agents/workflow/state_manager.py` supports versioned state files and recovery from history.
- Some areas already avoid hard-failing startup on auxiliary tasks:
  - `tapps_agents/core/startup.py` catches exceptions and returns a failure result without failing process startup.

### Integration Approach

- Prefer a single helper for shaping errors (including redaction) so all agents and the workflow engine can reuse it.
- Align error categories with existing exception types in `tapps_agents/core/exceptions.py`.

### Risk Assessment

- **Risk**: Over-standardizing hides useful debugging data.
- **Mitigation**: Keep a sanitized summary in user-facing outputs and preserve full stack traces only in debug logs (never in artifacts by default).

### Rollback Plan

- Keep existing behavior (string error field) while adding the structured envelope alongside it; downstream consumers can gradually adopt the structured form.

### Testing

- Use `pytest`.
- Focus on deterministic tests for:
  - error envelope content
  - workflow step failure recording
  - state load/recovery after a failed run

## Change Log

| Date       | Version | Description                                 | Author      |
| ---------- | ------- | ------------------------------------------- | ----------- |
| 2025-12-15 | 0.1     | Initial draft for Epic 7.2                  | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
