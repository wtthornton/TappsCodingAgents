# Story 6.1: 5-Metric Code Scoring System

<!-- Source: implementation/cursor/EPIC_06_Quality_Testing.md -->
<!-- Context: Complexity/Security/Maintainability/Coverage/Performance scoring + stable overall score -->

## Status

Draft

## Story

**As a** user (and reviewer/quality pipeline),
**I want** a consistent 5-metric code scoring system with configurable weights and clear tool/fallback behavior,
**so that** quality gates can make reliable, reproducible pass/fail decisions.

## Acceptance Criteria

1. The system computes the **five canonical metrics** for a given file:
   - complexity (0–10, lower complexity is better but represented consistently)
   - security (0–10)
   - maintainability (0–10)
   - test coverage (0–10)
   - performance (0–10)
2. The system produces a deterministic `overall_score` (0–100) from those five metrics using configured weights (`ScoringWeightsConfig`) and documents the exact formula.
3. Tooling integration is robust and “2025-standards pragmatic”:
   - Uses Radon for complexity/maintainability when available; otherwise uses deterministic heuristics.
   - Uses Bandit for security when available; otherwise uses deterministic heuristics.
   - Coverage metric uses real coverage artifacts when available; otherwise uses deterministic heuristics.
   - Missing tools do **not** crash scoring; they yield a documented fallback value.
4. Scores and metrics are surfaced through the Reviewer flow:
   - `ReviewerAgent *score` and `*review` return the five metrics + overall score.
5. Unit tests validate:
   - metric ranges
   - overall-score calculation
   - fallback behavior when tools are unavailable

## Tasks / Subtasks

- [ ] Task 1: Define/lock the 5-metric contract (AC: 1–2)
  - [ ] Document which fields are canonical and how they are interpreted (including complexity inversion for overall score)
  - [ ] Ensure output schema is stable for downstream consumers (workflow gates, reports)

- [ ] Task 2: Harden tool detection + deterministic fallbacks (AC: 3)
  - [ ] Ensure Radon/Bandit/Coverage absence yields deterministic scoring (no random/unstable behavior)
  - [ ] Ensure tool execution failures are handled (timeouts, parsing errors)

- [ ] Task 3: Ensure Reviewer outputs include the 5 metrics consistently (AC: 4)
  - [ ] Confirm `ReviewerAgent.review_file()` and reporting paths preserve the 5-metric subset as the canonical gate inputs

- [ ] Task 4: Tests (AC: 5)
  - [ ] Extend/keep `tests/unit/test_scoring.py` for the 5-metric contract + fallback scenarios

## Dev Notes

### Existing System Context

- Scoring is already implemented in `tapps_agents/agents/reviewer/scoring.py::CodeScorer`:
  - Complexity: Radon `cc_visit` if available; else heuristic.
  - Maintainability: Radon `mi_visit` if available; else heuristic.
  - Security: Bandit API if available; else heuristic.
  - Test coverage: parses `coverage.xml` or `.coverage` when available; else heuristic.
  - Performance: AST-based static heuristics.
  - Also includes additional metrics beyond the Epic’s 5 (ruff linting, mypy type checking, jscpd duplication).
- Weights are already modeled in `tapps_agents/core/config.py::ScoringWeightsConfig` and validated to sum to ~1.0.
- Reviewer exposes scoring via `tapps_agents/agents/reviewer/agent.py` (`*score`, `*review`).
- Tests exist:
  - `tests/unit/test_scoring.py` covers score keys, ranges, overall formula, and tool-unavailable behavior.

### Integration Approach

- Treat the Epic’s 5 metrics as the canonical “gate inputs”.
- Keep extra metrics (linting/type/duplication/dependency health) available, but clearly separate them from the gate-critical 5-metric contract.

### Risk Assessment

- **Risk**: Changing the scoring schema breaks workflow gates and report generation.
- **Mitigation**: Keep a stable output contract; add regression tests asserting keys and ranges.

### Rollback Plan

- Revert scoring contract changes while preserving any additional tests that describe expected behavior.

### Testing

- Use `pytest`.
- Primary tests:
  - `tests/unit/test_scoring.py`

## Change Log

| Date       | Version | Description                | Author      |
| ---------- | ------- | -------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 6.1 | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
