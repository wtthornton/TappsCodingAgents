# Story 14.2: Strict Dependency Validation

<!-- Source: implementation/cursor/EPIC_14_E2E_Test_Reliability.md -->
<!-- Context: Add pre-flight dependency validation that fails tests immediately if required dependencies are missing, instead of skipping tests -->

## Status

**Deferred** - Testing infrastructure improvement, lower priority

## Story

**As a** QA engineer and developer,
**I want** pre-flight dependency validation that fails tests immediately when required dependencies are missing,
**so that** test failures are explicit and debuggable, rather than silently skipping tests when dependencies are missing.

## Acceptance Criteria

1. Pre-flight dependency validation checks exist before test execution:
   - Check workflow files exist before test execution
   - Check scenario templates exist before test setup
   - Check required fixtures are available
   - Validate project structure before execution
2. Tests fail immediately if dependencies are missing (don't skip with `pytest.skip()`)
3. Clear error messages for missing dependencies:
   - What dependency is missing (workflow file, template, fixture, etc.)
   - Expected location/path
   - How to fix (suggested action, required setup)
4. Dependency validation is opt-out (can be disabled for specific tests if needed via marker)
5. Pre-flight validation runs early in test setup (before any workflow execution or test logic)
6. Existing E2E tests updated to use dependency validation (remove `pytest.skip()` calls for missing dependencies)
7. Unit tests exist for dependency validation utilities

## Tasks / Subtasks

- [ ] Task 1: Create dependency validation utilities (AC: 1, 2, 3)
  - [ ] Create `tests/e2e/fixtures/dependency_validator.py` with validation functions
  - [ ] Implement `validate_workflow_file(workflow_path: Path) -> None` (fails if missing)
  - [ ] Implement `validate_scenario_template(template_path: Path) -> None` (fails if missing)
  - [ ] Implement `validate_project_structure(project_path: Path) -> None` (checks required dirs/files)
  - [ ] Implement `validate_required_fixtures(fixtures: List[str]) -> None` (checks pytest fixtures)

- [ ] Task 2: Implement clear error messages (AC: 3)
  - [ ] Error messages include: dependency type, expected path, missing item name
  - [ ] Error messages include suggestions for fixing (e.g., "Ensure workflow file exists at {path}")
  - [ ] Use `pytest.fail()` with descriptive messages

- [ ] Task 3: Add opt-out mechanism (AC: 4)
  - [ ] Add `@pytest.mark.skip_dependency_validation` marker
  - [ ] Check marker in dependency validation to allow skipping validation for specific tests
  - [ ] Document marker usage

- [ ] Task 4: Integrate pre-flight validation into test fixtures (AC: 5)
  - [ ] Add dependency validation to `e2e_project` fixture (validate project structure)
  - [ ] Add dependency validation to workflow runner setup (validate workflow files)
  - [ ] Add dependency validation to scenario test setup (validate templates)

- [ ] Task 5: Update existing E2E tests (AC: 6)
  - [ ] Remove `pytest.skip()` calls for missing workflow files in scenario tests
  - [ ] Remove `pytest.skip()` calls for missing templates
  - [ ] Add dependency validation calls before test execution
  - [ ] Update `tests/e2e/scenarios/test_*.py` files
  - [ ] Update `tests/e2e/workflows/test_*.py` files
  - [ ] Update `tests/e2e/smoke/test_*.py` files

- [ ] Task 6: Create unit tests (AC: 7)
  - [ ] Create `tests/unit/e2e/test_dependency_validator.py`
  - [ ] Test validation functions fail correctly when dependencies are missing
  - [ ] Test validation passes when dependencies exist
  - [ ] Test error messages are clear and actionable
  - [ ] Test opt-out marker functionality

## Dev Notes

### Existing System Context

- Current pattern in E2E tests:
  ```python
  # tests/e2e/scenarios/test_feature_scenario.py:44-45
  workflow_path = Path(...) / "presets" / "feature-implementation.yaml"
  if not workflow_path.exists():
      pytest.skip(f"Workflow file not found: {workflow_path}")
  ```
- Workflow files location: `workflows/` and `workflows/presets/`
- Scenario templates: created by `create_small_scenario_template()`, `create_medium_scenario_template()` in `tests/e2e/fixtures/scenario_templates.py`
- E2E fixtures: `tests/e2e/conftest.py` contains `e2e_project`, `e2e_correlation_id`, etc.
- Integration points:
  - Scenario tests: `tests/e2e/scenarios/test_*.py`
  - Workflow tests: `tests/e2e/workflows/test_*.py`
  - Smoke tests: `tests/e2e/smoke/test_*.py`
  - Test fixtures: `tests/e2e/conftest.py`

### Integration Approach

- Create new `dependency_validator.py` module in `tests/e2e/fixtures/`
- Add validation functions that raise `pytest.fail()` or `FileNotFoundError` with clear messages
- Integrate validation into existing fixtures where appropriate
- Update tests to call validation before execution instead of skipping
- Use pytest markers for opt-out mechanism

### Technology Research

- Use `pathlib.Path` for path operations
- Use `pytest.fail()` for test failures with clear messages
- Use `pytest.mark` for opt-out marker
- Use `pytest.fixture` for integration into fixtures

### Risk Assessment

- **Primary risk**: Tests may fail more often, requiring proper dependency setup
- **Mitigation**: This is expected - failures are now visible. Ensure CI/CD properly sets up dependencies.
- **Secondary risk**: Some tests may legitimately need to skip if dependencies are truly optional
- **Mitigation**: Use opt-out marker for truly optional dependencies

### Testing

- Test file location: `tests/unit/e2e/test_dependency_validator.py`
- Test standards: Use `pytest`, follow existing unit test patterns
- Testing frameworks: `pytest`
- Specific requirements:
  - Test validation fails when workflow file is missing
  - Test validation fails when template is missing
  - Test validation fails when project structure is invalid
  - Test validation passes when all dependencies exist
  - Test error messages are clear and actionable
  - Test opt-out marker works correctly

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 14.2       | bmad-master |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_

