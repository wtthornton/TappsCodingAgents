# Story 8.3: Smoke E2E Tests (Mocked / Deterministic)

<!-- Source: implementation/cursor/EPIC_08_E2E_Testing_Foundation.md -->
<!-- Context: Create deterministic smoke E2E tests that validate vertical slices without real services -->

## Status

Complete

## Story

**As a** developer and QA engineer,
**I want** deterministic smoke E2E tests that validate critical vertical slices of the system without requiring real LLM or Context7 services,
**so that** I can quickly verify core functionality works end-to-end in PR checks and local development without external dependencies.

## Acceptance Criteria

1. Smoke E2E tests exist in `tests/e2e/smoke/` that validate:
   - Workflow YAML parsing and validation (using real YAML files from `workflows/`)
   - Workflow executor initialization and step advancement (mocked agents)
   - Workflow state persistence and resume (save/load state)
   - Agent activation lifecycle (activate/run/close) using mocked MAL
   - Worktree creation and cleanup invariants
2. All smoke tests are fully deterministic:
   - No network calls (no real LLM, no real Context7)
   - Use fixed fixtures and seeded randomness where needed
   - Use stable clocks/mocks for time-dependent operations
   - Tests produce identical results on repeated runs
3. Smoke tests use the E2E harness from Story 8.1:
   - Use project templates for isolated test environments
   - Use artifact capture utilities for failure debugging
   - Use correlation IDs for test traceability
4. Smoke tests are marked with `e2e_smoke` and can run without any external services.
5. Smoke tests validate stable "contracts" rather than brittle text:
   - Exit codes, JSON shape validation, required artifact existence
   - State transition validation (workflow state, step state)
   - File system invariants (worktree structure, artifact locations)
6. Smoke tests include explicit timeouts and produce actionable failure artifacts.
7. Smoke tests run in under 30 seconds total (fast enough for PR gating).
8. Unit tests exist for smoke test utilities if any are created.

## Tasks / Subtasks

- [x] Task 1: Create workflow parsing smoke test (AC: 1, 2, 3, 4)
  - [x] Test: Parse all shipped workflows from `workflows/` directory
  - [x] Test: Validate workflow schema and cross-references
  - [x] Test: Handle invalid workflow YAML gracefully
  - [x] Use E2E harness for project setup
  - [x] Mark with `e2e_smoke`
  - [x] Add timeout and artifact capture

- [x] Task 2: Create workflow executor smoke test (AC: 1, 2, 3, 4, 5)
  - [x] Test: Initialize workflow executor with minimal workflow
  - [x] Test: Advance workflow steps with mocked agents
  - [x] Test: Validate state transitions (start → step → complete)
  - [x] Test: Validate step execution order
  - [x] Use mocked MAL and agents (no real LLM calls)
  - [x] Use E2E harness for isolated project
  - [x] Mark with `e2e_smoke`
  - [x] Validate contracts (state shape, step IDs, transitions)

- [x] Task 3: Create workflow persistence smoke test (AC: 1, 2, 3, 4, 5)
  - [x] Test: Save workflow state to `.tapps-agents/workflow-state/`
  - [x] Test: Load workflow state from persisted file
  - [x] Test: Resume workflow from saved state
  - [x] Test: Validate state consistency (checksums, version)
  - [x] Use E2E harness for project setup
  - [x] Mark with `e2e_smoke`
  - [x] Validate state contract (required fields, structure)

- [x] Task 4: Create agent lifecycle smoke test (AC: 1, 2, 3, 4)
  - [x] Test: Agent activation (activate method)
  - [x] Test: Agent execution (run method with mocked MAL)
  - [x] Test: Agent cleanup (close method)
  - [x] Test: Multiple agents can run in sequence
  - [x] Use mocked MAL (no real LLM calls)
  - [x] Use E2E harness for isolated project
  - [x] Mark with `e2e_smoke`
  - [x] Validate agent contract (activation state, execution results)

- [x] Task 5: Create worktree cleanup smoke test (AC: 1, 2, 3, 4, 5)
  - [x] Test: Worktree creation under `.tapps-agents/worktrees/`
  - [x] Test: Worktree cleanup (idempotent removal)
  - [x] Test: Multiple worktrees can coexist
  - [x] Test: Cleanup doesn't affect main working tree
  - [x] Use E2E harness for project setup
  - [x] Mark with `e2e_smoke`
  - [x] Validate filesystem invariants (worktree structure, cleanup)

- [x] Task 6: Optimize smoke test performance (AC: 7)
  - [x] Review test execution time
  - [x] Optimize slow tests (reduce fixture complexity, use faster mocks)
  - [x] Ensure total smoke suite runs in under 30 seconds
  - [x] Add performance benchmarks if needed

- [x] Task 7: Add failure artifact capture (AC: 6)
  - [x] Ensure all smoke tests use artifact capture on failure
  - [x] Validate failure bundles include: logs, state, artifacts, timeline
  - [x] Test artifact capture in a failing scenario

- [x] Task 8: Documentation and validation (AC: 8)
  - [x] Document smoke test coverage in `tests/e2e/smoke/README.md`
  - [x] Document how to run smoke tests locally
  - [x] Verify all smoke tests are deterministic (run twice, compare results)
  - [x] Add unit tests for any smoke test utilities created

## Dev Notes

### Existing System Context

- Workflow system:
  - `tapps_agents/workflow/parser.py` - workflow YAML parsing
  - `tapps_agents/workflow/executor.py` - workflow execution
  - `tapps_agents/workflow/worktree_manager.py` - worktree management
  - Workflows in `workflows/` directory
- Agent system:
  - `tapps_agents/core/agent_base.py` - base agent interface
  - `tapps_agents/core/mal.py` - Model Abstraction Layer
  - Agents in `tapps_agents/agents/`
- Existing test patterns:
  - `tests/conftest.py` - `mock_mal` fixture for mocking LLM
  - `tests/integration/test_e2e_workflow_real.py` - real E2E example (use as reference for structure)
  - Unit tests for workflow parser in `tests/unit/test_workflow_parser.py`
- E2E harness (from Story 8.1):
  - `tests/e2e/fixtures/e2e_harness.py` - harness utilities
  - `tests/e2e/fixtures/project_templates.py` - project templates
  - E2E fixtures in `tests/e2e/conftest.py`

### Integration Approach

- Build on existing `mock_mal` fixture from `tests/conftest.py`
- Reuse workflow parser and executor from `tapps_agents/workflow/`
- Use E2E harness utilities from Story 8.1
- Follow patterns from `tests/integration/test_e2e_workflow_real.py` but with mocks

### Technology Research

- Use `pytest` with `pytest-asyncio` for async tests
- Use `pytest-timeout` for explicit timeouts
- Use `unittest.mock` for mocking MAL and agents
- Use `pathlib.Path` for filesystem operations
- Use `yaml` library for workflow parsing (already in use)

### Risk Assessment

- **Primary risk**: Smoke tests become flaky or slow
- **Mitigation**: Ensure full determinism (no network, seeded randomness, stable clocks); optimize performance
- **Rollback plan**: Smoke tests are additive; can be disabled via markers without affecting other tests

### Testing

- Test file location: `tests/e2e/smoke/` (multiple test files)
- Test standards: Use `pytest`, follow E2E conventions from Story 8.1
- Testing frameworks: `pytest`, `pytest-asyncio`, `pytest-timeout`
- Specific requirements:
  - All tests must be deterministic (no external dependencies)
  - All tests must use `e2e_smoke` marker
  - All tests must use E2E harness utilities
  - All tests must capture artifacts on failure
  - All tests must validate contracts, not brittle text
  - Total suite must run in under 30 seconds

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 8.3        | bmad-master |

## Dev Agent Record

### Agent Model Used

Auto (Cursor AI)

### Debug Log References

N/A - Implementation completed successfully

### Completion Notes List

- Created 5 smoke test files with 27 total tests:
  - `test_workflow_parsing.py` (4 tests): Parse workflows, validate schema, handle invalid YAML
  - `test_workflow_executor.py` (6 tests): Executor initialization, step advancement, state transitions
  - `test_workflow_persistence.py` (5 tests): Save/load/resume workflow state, state consistency
  - `test_agent_lifecycle.py` (5 tests): Agent activation, execution with mocked MAL, cleanup, sequential execution
  - `test_worktree_cleanup.py` (7 tests): Worktree creation, cleanup, multiple worktrees, isolation
- All tests are deterministic (no network calls, mocked services, fixed fixtures)
- All tests use `e2e_smoke` marker and E2E harness utilities
- All tests validate stable contracts (exit codes, JSON shape, state transitions, filesystem invariants)
- Smoke test documentation created in `tests/e2e/smoke/README.md`
- Total suite runs in under 30 seconds (fast enough for PR gating)

### File List

- `tests/e2e/smoke/test_workflow_parsing.py`
- `tests/e2e/smoke/test_workflow_executor.py`
- `tests/e2e/smoke/test_workflow_persistence.py`
- `tests/e2e/smoke/test_agent_lifecycle.py`
- `tests/e2e/smoke/test_worktree_cleanup.py`
- `tests/e2e/smoke/README.md`

## QA Results

✅ All acceptance criteria met. All tasks completed. 27 smoke tests covering all critical vertical slices. All tests are deterministic and run without external dependencies.
