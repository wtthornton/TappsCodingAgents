# Story 30.3: Expert Registry Priority Integration

<!-- Source: implementation/EPIC_02_Tech_Stack_Specific_Expert_Prioritization.md -->
<!-- Context: Brownfield enhancement - Apply priorities in expert registry consultation -->

## Status

**Ready for Review**

## Story

**As a** framework user,
**I want** expert registry to apply tech stack priorities during consultation,
**so that** the most relevant experts are consulted first, improving response quality and reducing token usage.

## Acceptance Criteria

1. Expert registry reads tech stack config (from Story 30.2) and loads priorities
2. `_get_experts_for_domain()` method is modified to consider priorities when ordering experts
3. Expert ordering reflects priorities (higher priority experts appear first in consultation list)
4. Priority system works with existing domain-based expert matching (priorities enhance, don't replace)
5. Expert consultation uses prioritized expert list
6. System works correctly without priorities (backward compatible)
7. Priority overrides from config file are applied correctly

## Tasks / Subtasks

- [x] Task 1: Load priorities in expert registry (AC: 1)
  - [x] Read `.tapps-agents/tech-stack.yaml` in expert registry
  - [x] Parse expert priorities from config
  - [x] Cache priorities for performance
  - [x] Handle missing config file gracefully

- [x] Task 2: Modify expert selection (AC: 2, 3)
  - [x] Update `_get_experts_for_domain()` to consider priorities
  - [x] Sort experts by priority (higher first)
  - [x] Maintain domain matching (priorities reorder, don't filter)
  - [x] Combine domain match + priority for final ordering

- [x] Task 3: Integrate with consultation (AC: 5)
  - [x] Ensure consultation methods use prioritized list
  - [x] Verify expert ordering in consultation results
  - [x] Test consultation with priorities

- [x] Task 4: Maintain domain matching (AC: 4)
  - [x] Ensure domain-based matching still works
  - [x] Priorities are weights, not filters
  - [x] All domain-matched experts still included

- [x] Task 5: Ensure backward compatibility (AC: 6)
  - [x] Test without tech-stack.yaml (no priorities)
  - [x] Test with empty priorities
  - [x] Verify default behavior unchanged

- [x] Task 6: Support overrides (AC: 7)
  - [x] Read override section from config
  - [x] Apply overrides to default priorities
  - [x] Override takes precedence

## Dev Notes

### Existing System Context

- Expert registry in `tapps_agents/experts/expert_registry.py`
- `_get_experts_for_domain()` method exists with domain matching logic
- Expert consultation methods exist
- Domain-based expert matching is working

### Integration Approach

- Extend expert registry to load priorities
- Modify `_get_experts_for_domain()` to apply priorities to ordering
- Maintain existing domain matching logic
- Priorities are additive (weights), not filtering

### Risk Assessment

- **Primary risk**: Priority system may exclude relevant experts
  - **Mitigation**: Priorities are weights, not filters - all experts still available, just reordered
- **Primary risk**: Performance impact of priority sorting
  - **Mitigation**: Cache priorities, efficient sorting, minimal overhead

### Rollback Plan

- Remove priority loading from expert registry
- Revert `_get_experts_for_domain()` changes
- Expert registry reverts to domain-only matching

### Testing

- Unit tests for priority loading
- Unit tests for expert ordering with priorities
- Test domain matching + priorities together
- Test backward compatibility (no priorities)
- Test override functionality
- Integration tests for consultation with priorities

## Change Log

| Date       | Version | Description                     | Author      |
| ---------- | ------- | ------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 30.3     | bmad-master |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5

### Debug Log References

_TBD_

### Completion Notes List

- Added `_load_tech_stack_priorities()` method to load priorities from `.tapps-agents/tech-stack.yaml`
- Priorities are cached in `_tech_stack_priorities` instance variable
- Added `_apply_priorities()` method to sort experts by priority (higher first)
- Modified `_get_experts_for_domain()` to apply priorities after domain matching
- Overrides from config file take precedence over default priorities
- All changes are backward compatible (works without priorities)
- Comprehensive unit tests (9 tests, all passing)

### File List

- `tapps_agents/experts/expert_registry.py` - Added priority loading and application logic
- `tests/unit/experts/test_expert_registry_priorities.py` - Unit tests for priority integration

## QA Results

_TBD_

