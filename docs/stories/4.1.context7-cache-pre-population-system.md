# Story 4.1: Context7 Cache Pre-Population System

<!-- Source: implementation/cursor/EPIC_04_Context7_Integration.md -->
<!-- Context: Brownfield extension of existing Context7 KB cache + prepopulation script -->

## Status

Draft

## Story

**As a** developer or CI pipeline setting up a project,
**I want** a first-class, cache-first Context7 KB pre-population command,
**so that** common library documentation is available offline with high hit rates before agents start work.

## Acceptance Criteria

1. A supported pre-population entrypoint exists that can be run non-interactively (local + CI) and uses the existing Context7 KB-first stack (`tapps_agents/context7/`), not ad-hoc fetching.
2. The pre-population entrypoint supports:
   - `--project-root` (defaults to CWD)
   - `--requirements` path (defaults to `requirements.txt`)
   - `--libraries` (one or more)
   - `--topics` (when enabled, cache known topics per library)
3. The command reports an explicit summary including: total libraries attempted, successful, failed, and current cache metrics (entries/libraries/size) using `Context7Commands.cmd_status()`.
4. Failure modes are actionable and safe:
   - If Context7 is disabled in config, the command exits non-zero with an enablement hint.
   - If Context7 is enabled but credentials/MCP are unavailable, the command exits non-zero with a clear remediation message (no stacktrace by default).
5. Unit tests cover requirements parsing + the “no Context7 enabled” / “Context7 enabled but unavailable” behaviors (best-effort; real API calls remain in the existing integration test suite).

## Tasks / Subtasks

- [ ] Task 1: Align the repo-supported pre-population entrypoint (AC: 1–3)
  - [ ] Confirm existing behavior in `scripts/prepopulate_context7_cache.py`
  - [ ] Add a first-class CLI surface in `tapps_agents/cli.py` (e.g., `tapps-agents context7-prepopulate ...`) that delegates to the script logic or shares an implementation module
  - [ ] Ensure output includes cache metrics via `tapps_agents/context7/commands.py::Context7Commands.cmd_status`

- [ ] Task 2: Harden error handling and exit codes (AC: 4)
  - [ ] Ensure `Context7Commands` enablement checks produce actionable errors
  - [ ] Ensure missing credential / MCP gateway scenarios produce clear remediation guidance (env vars / setup docs)

- [ ] Task 3: Add tests (AC: 5)
  - [ ] Add/extend tests for `parse_requirements_file` in `scripts/prepopulate_context7_cache.py`
  - [ ] Add/extend tests for CLI wrapper behavior (no Context7 enabled, disabled config)

## Dev Notes

### Existing System Context

- Context7 KB cache system is already implemented in `tapps_agents/context7/`:
  - Cache entry storage: `tapps_agents/context7/kb_cache.py::KBCache`
  - KB-first lookup workflow (cache → fuzzy → MCP resolve → MCP docs): `tapps_agents/context7/lookup.py::KBLookup`
  - Commands wrapper for docs/status/search/refresh/cleanup: `tapps_agents/context7/commands.py::Context7Commands`
  - Metrics persistence and cache hit/miss counters: `tapps_agents/context7/analytics.py::Analytics` (writes `.metrics.yaml`)
  - Refresh queue + policies: `tapps_agents/context7/refresh_queue.py`, `tapps_agents/context7/staleness_policies.py`
- A dedicated pre-population script already exists:
  - `scripts/prepopulate_context7_cache.py` parses `requirements.txt`, supports `--libraries` and optional topic warming, and uses `Context7Commands.cmd_docs()`.

### Integration Approach

- Prefer **wrapping the existing script** with a stable CLI command (via `tapps_agents/cli.py`) rather than creating a second implementation.
- Keep KB-first semantics: pre-pop should call `Context7Commands.cmd_docs()` so cache hits don’t trigger unnecessary API calls.
- Keep the cache location consistent with config defaults: `Context7KnowledgeBaseConfig.location` defaults to `.tapps-agents/kb/context7-cache` (see `tapps_agents/core/config.py`).

### Risk Assessment

- **Risk**: the pre-population command becomes brittle if Context7 is not configured.
- **Mitigation**: treat Context7 as optional; fail fast for pre-pop, but do not destabilize agent activation paths.

### Rollback Plan

- If the new CLI wrapper causes issues, fall back to running `python scripts/prepopulate_context7_cache.py` directly.

### Testing

- Unit tests already exist for Context7 modules in `tests/unit/context7/`.
- Real API tests already exist and are opt-in via markers in `tests/integration/test_context7_real.py`.

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 4.1        | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
