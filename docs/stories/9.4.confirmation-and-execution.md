# Story 9.4: Confirmation and Execution

<!-- Source: implementation/EPIC_09_Natural_Language_Workflow_Triggers.md -->
<!-- Context: Brownfield enhancement - Confirmation step before workflow execution -->

## Status

**✅ Completed**

**Last Updated:** 2025-01-27

## Story

**As a** framework user,
**I want** to see a confirmation with workflow details before execution,
**so that** I can verify the correct workflow is being run and avoid accidental executions.

## Acceptance Criteria

1. Confirmation step displays workflow details before execution (name, description, step count, estimated time)
2. Confirmation message is formatted clearly for Cursor chat (plain text, easy to read)
3. User can confirm execution (yes/y/proceed) or cancel (no/n/cancel)
4. Workflow execution proceeds after user confirmation
5. System handles cancellation gracefully (no execution, clear message)
6. Confirmation includes extracted parameters (target file, options) if any
7. System shows confidence score if intent detection confidence is below threshold (e.g., < 0.8)
8. Confirmation can be bypassed for high-confidence matches in auto mode (if configured)

## Tasks / Subtasks

- [ ] Task 1: Create confirmation formatter (AC: 1, 2, 6, 7)
  - [ ] Create function to format workflow details for display
  - [ ] Include workflow name, description, number of steps
  - [ ] Include estimated time (if available)
  - [ ] Include extracted parameters (target file, options)
  - [ ] Show confidence score if below threshold
  - [ ] Format for Cursor chat (plain text, no markdown)

- [ ] Task 2: Implement confirmation handler (AC: 3, 5)
  - [ ] Create function to prompt user for confirmation
  - [ ] Parse user response (yes/y/proceed, no/n/cancel)
  - [ ] Handle case-insensitive input
  - [ ] Handle cancellation gracefully (return without execution)
  - [ ] Provide clear feedback on cancellation

- [ ] Task 3: Integrate with workflow executor (AC: 4)
  - [ ] Pass confirmed workflow to executor
  - [ ] Pass extracted parameters to executor
  - [ ] Handle execution errors gracefully
  - [ ] Provide execution status feedback

- [ ] Task 4: Implement auto-mode bypass (AC: 8)
  - [ ] Check if auto mode is enabled
  - [ ] Check confidence threshold for bypass
  - [ ] Skip confirmation for high-confidence matches in auto mode
  - [ ] Log when confirmation is bypassed

- [ ] Task 5: Create confirmation workflow (AC: 1-8)
  - [ ] Integrate parser, intent detection, and confirmation
  - [ ] Create end-to-end flow: parse → confirm → execute
  - [ ] Handle all edge cases (low confidence, ambiguous, cancellation)
  - [ ] Add error handling and user feedback

## Dev Notes

### Existing System Context

- Natural language parser from Story 9.1 provides workflow matching
- Intent detection from Story 9.2 provides intent and parameters
- Workflow executor in `tapps_agents/workflow/executor.py` handles execution
- Workflow models in `tapps_agents/workflow/models.py` provide workflow structure
- Cursor chat interface is where confirmation is displayed
- Auto mode exists in workflow executor (`auto_mode` parameter)

### Integration Approach

- Create confirmation handler in `tapps_agents/workflow/nlp_parser.py` or separate module
- Integrate with existing workflow executor
- Use workflow models for displaying workflow details
- Format output for Cursor chat (plain text, no markdown per BMad Master persona)
- Respect auto mode settings from executor

### Risk Assessment

- **Primary risk**: Users may find confirmation annoying for common workflows
  - **Mitigation**: Support auto mode bypass, learn from user patterns, allow configuration
- **Primary risk**: Confirmation may block automated workflows
  - **Mitigation**: Auto mode bypass, configurable thresholds, non-blocking option
- **Primary risk**: Execution may fail after confirmation
  - **Mitigation**: Handle errors gracefully, provide clear error messages, allow retry

### Rollback Plan

- Confirmation step is additive, can be disabled
- Direct workflow execution remains available
- No breaking changes to executor

### Testing

- Unit tests for confirmation formatting
- Unit tests for confirmation handler (yes/no parsing)
- Unit tests for auto mode bypass logic
- Integration tests with workflow executor
- Test cancellation flow
- Test error handling during execution
- Test with various confidence levels
- Test with various parameter combinations

## Change Log

| Date       | Version | Description                     | Author      |
| ---------- | ------- | ------------------------------- | ----------- |
| 2025-01-27 | 0.1     | Initial draft for Epic 9.4      | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

- `tapps_agents/workflow/confirmation_handler.py` (new)
- `tapps_agents/workflow/nlp_executor.py` (new - orchestrates parse → confirm → execute)
- `tests/workflow/test_confirmation_handler.py` (new)

## QA Results

_TBD_

