# Story 2.4: Foreground Agents - Review, Planning, Enhancement

<!-- Source: implementation/cursor/EPIC_02_Core_Agents.md -->
<!-- Context: Brownfield enhancement to standardize review/planning/enhancement agents for aggregation -->

## Status

Draft

## Story

**As a** user running SDLC workflows in Cursor IDE,
**I want** Review, Planning, and Prompt/Enhancement agents to produce consistent, machine-readable artifacts with stable aggregation behavior,
**so that** the orchestrator can gate on quality, generate plans/stories, and enhance prompts deterministically.

## Acceptance Criteria

1. Review agent outputs include a machine-readable scoring artifact (with `schema_version`) and a stable “pass/fail” decision that can be used for workflow gates.
2. Planning outputs (plans/stories/estimates) include a machine-readable artifact (with `schema_version`) plus optional markdown.
3. Enhancement outputs include a machine-readable artifact (with `schema_version`) capturing the enhanced prompt + transformation metadata.
4. These agents integrate with existing workflow gating and expert consultation mechanisms where present (e.g., expert consult hooks in the workflow executor).
5. Results are aggregation-friendly (stable ordering, explicit merge rules).
6. Tests verify:
   - reviewer gate decision remains stable
   - planning output artifact is produced
   - enhancement output artifact is produced

## Tasks / Subtasks

- [ ] Task 1: Standardize Reviewer outputs (AC: 1, 5)
  - [ ] Review existing reviewer capabilities in `tapps_agents/agents/reviewer/agent.py`
  - [ ] Normalize result keys for gating (e.g., `passed`, `threshold`, `scoring`)
  - [ ] Emit a versioned JSON artifact in deterministic location (worktree)

- [ ] Task 2: Standardize Planning outputs (AC: 2, 5)
  - [ ] Review `tapps_agents/agents/planner/agent.py`
  - [ ] Emit plan/story outputs in versioned JSON + optional markdown

- [ ] Task 3: Standardize Enhancement outputs (AC: 3, 5)
  - [ ] Review `tapps_agents/agents/enhancer/agent.py`
  - [ ] Emit enhanced prompt artifacts with transformation metadata

- [ ] Task 4: Ensure workflow integration points are respected (AC: 4)
  - [ ] Confirm gating usage in workflow execution (see `tapps_agents/workflow/executor.py` gate handling)
  - [ ] Ensure expert consult outputs can be attached without breaking schemas

- [ ] Task 5: Tests (AC: 6)
  - [ ] Extend integration tests (see `tests/integration/test_reviewer_agent.py`, `tests/integration/test_planner_agent.py`, `tests/integration/test_enhancer_agent.py`)

## Dev Notes

### Existing System Context

- `ReviewerAgent` already supports scoring, linting, type-checking, duplication checks, and reporting (`tapps_agents/agents/reviewer/agent.py`).
- Workflow gating exists in the MAL-based executor (see `tapps_agents/workflow/executor.py`, gate handling around reviewer execution).
- Planning and enhancement agents exist under `tapps_agents/agents/planner/` and `tapps_agents/agents/enhancer/`.

### Integration Approach

- Do not rewrite core logic; add a normalization layer so each agent always emits:
  - versioned JSON (primary)
  - optional markdown summary (secondary)
- Keep gate fields stable to avoid breaking workflows.

### Risk Assessment

- **Primary risk**: changing reviewer output shape breaks existing gate logic.
- **Mitigation**: preserve existing keys (`passed`, `scoring`, `threshold`) and only add versioned artifact emission.

### Rollback Plan

- Continue to return current in-memory dictionaries while disabling artifact emission via config if needed.

### Testing

- Use existing integration tests per agent and add small regression assertions on artifact production.

## Change Log

| Date       | Version | Description                           | Author      |
| ---------- | ------- | ------------------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 2.4            | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
