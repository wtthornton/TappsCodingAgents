# Story 1.5: Worktree Merge & Conflict Resolution

<!-- Source: implementation/cursor/EPIC_01_Foundation.md -->
<!-- Context: Brownfield enhancement to safely integrate worktree changes -->

## Status

✅ **Completed** - 2025-12-14

## Story

**As a** workflow orchestrator,
**I want** a safe merge mechanism for worktree-produced changes,
**so that** results from isolated worktrees can be integrated back to the main branch with clear conflict detection and rollback.

## Acceptance Criteria

1. There is a supported path to merge worktree branch changes back into the main working tree (best-effort automation; manual conflict resolution is acceptable).
2. Merge process detects conflicts and produces a clear conflict report (files + guidance) without leaving the repo in an unknown state.
3. On merge failure, the system can abort/rollback the merge attempt cleanly.
4. Merge logic is scoped to worktrees created under `.tapps-agents/worktrees/` and does not affect unrelated branches.
5. Tests cover the “clean merge” case and a synthetic “conflict” case.

## Tasks / Subtasks

- [ ] Task 1: Identify merge ownership and integration points (AC: 1)
  - [ ] Review `tapps_agents/workflow/worktree_manager.py` and `tapps_agents/core/worktree.py`
  - [ ] Decide where merge logic belongs (workflow vs core)

- [ ] Task 2: Implement merge helper (AC: 1–4)
  - [ ] Determine the worktree branch naming used for workflow steps (e.g., `workflow/<worktree_name>` or `agent/<id>`)
  - [ ] Implement best-effort merge into the target branch (likely current branch)
  - [ ] Detect conflicts and write a conflict report artifact under `.tapps-agents/` (or `reports/`)

- [ ] Task 3: Rollback/abort behavior (AC: 3)
  - [ ] Implement merge abort path (best-effort) and ensure working tree is clean afterwards

- [ ] Task 4: Tests (AC: 5)
  - [ ] Add tests that create a temp git repo, generate branches, and verify clean merge
  - [ ] Add tests that intentionally conflict and verify report + clean rollback

## Dev Notes

### Existing System Context

- Workflow step worktrees are created by `CursorWorkflowExecutor` using `tapps_agents/workflow/worktree_manager.py`.
- A separate worktree utility exists for background agents in `tapps_agents/core/worktree.py`.

### Integration Approach

- Keep merge operations conservative:
  - do not auto-resolve conflicts
  - always produce a report
  - prefer aborting safely over forcing merges

### Risk Assessment

- **Primary risk**: accidental merge into wrong branch / leaving repo in conflicted state
- **Mitigation**: explicit target branch selection, checks for clean working tree, and best-effort abort on failure.

### Rollback Plan

- Abort merge attempt; reset working tree to pre-merge state; remove worktree branches if needed.

### Testing

- Use `pytest` with temporary git repos.

## Change Log

| Date       | Version | Description                | Author      |
| ---------- | ------- | -------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 1.5 | bmad-master |
| 2025-12-14 | 1.0     | ✅ Story completed - All AC met | Auto        |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- ✅ All 5 acceptance criteria met
- ✅ `merge_worktree()` method implemented in `WorktreeManager`
- ✅ `abort_merge()` method implemented with fallback to `git reset --hard HEAD`
- ✅ Conflict detection using `git diff --name-only --diff-filter=U`
- ✅ Conflict reports generated as JSON in `.tapps-agents/reports/`
- ✅ All 9 unit tests passing (including clean merge, conflicts, abort, timeout scenarios)

### File List

**Modified Files:**
- `tapps_agents/workflow/worktree_manager.py` - Added `merge_worktree()`, `abort_merge()`, and helper methods
- `tests/unit/workflow/test_worktree_manager.py` - Added 6 merge-related tests

## QA Results

✅ **All Tests Passing**
- 9/9 unit tests for worktree manager passing (including 6 new merge tests)
- Clean merge scenario tested
- Conflict detection and reporting tested
- Merge abort functionality tested
- No linter errors
