# Story 28.1: Expert Engine Runtime Component

<!-- Source: docs/prd/epic-2-dynamic-expert-rag-engine.md -->
<!-- Context: Dynamic Expert & RAG Engine - Foundation -->

## Status

**In Progress** - Core Implementation Complete

**Last Updated:** 2025-01-XX

**Implementation Notes:**
- Expert Engine orchestrator implemented (`tapps_agents/experts/expert_engine.py`)
- Knowledge need detection implemented
- Expert routing plan generation implemented
- Knowledge retrieval plan generation implemented
- Controlled knowledge writes interface implemented (validation)
- Metrics collection implemented
- Basic tests created (`tests/unit/test_expert_engine.py`)
- Integration with ExpertRegistry and UnifiedCache complete
- Ready for integration with workflow executor (next step)

## Story

**As a** SDLC workflow system,
**I want** an Expert Engine runtime component that automatically orchestrates expert consultation and knowledge retrieval,
**so that** agents receive the best available, project-relevant information with minimal manual configuration.

## Acceptance Criteria

1. Expert Engine orchestrator implemented that detects domain knowledge needs
2. Expert routing plan generation created (which domains to consult for each step)
3. Knowledge retrieval plan implemented (what to fetch from Context7 vs local KB)
4. Controlled knowledge writes added (new KB entries for project)
5. Metrics collection created (cache hit rate, retrieval quality, confidence trends)
6. Engine detects knowledge needs automatically
7. Engine routes to correct experts based on context
8. Engine retrieves from appropriate sources (Context7 vs local KB)
9. Knowledge writes are safe and controlled
10. Metrics are collected and accessible

## Tasks / Subtasks

- [x] Task 1: Design Expert Engine Architecture (AC: 1)
  - [x] Define Expert Engine interface and responsibilities
  - [x] Design knowledge need detection logic
  - [x] Design integration points with existing expert registry
  - [x] Document Expert Engine architecture

- [x] Task 2: Implement Knowledge Need Detection (AC: 1, 6)
  - [x] Create signal analysis from workflow step context
  - [x] Implement domain knowledge gap detection
  - [x] Add context-aware knowledge need identification
  - [x] Integrate with workflow executor signals

- [x] Task 3: Implement Expert Routing Plan (AC: 2, 7)
  - [x] Create routing plan generator
  - [x] Implement domain-to-expert mapping logic
  - [x] Add routing plan optimization
  - [x] Integrate with existing expert registry

- [x] Task 4: Implement Knowledge Retrieval Plan (AC: 3, 8)
  - [x] Create retrieval plan generator
  - [x] Implement Context7 vs local KB decision logic
  - [x] Add retrieval source prioritization
  - [x] Integrate with Context7 KB cache and Unified Cache

- [x] Task 5: Implement Controlled Knowledge Writes (AC: 4, 9)
  - [x] Create knowledge write interface
  - [x] Implement write validation and safety checks
  - [x] Add knowledge entry formatting
  - [x] Integrate with RAG backends (interface ready, full implementation in Story 28.4)

- [x] Task 6: Implement Metrics Collection (AC: 5, 10)
  - [x] Create metrics data models
  - [x] Implement cache hit rate tracking
  - [x] Add retrieval quality metrics
  - [x] Implement confidence trend tracking
  - [x] Create metrics storage and retrieval

- [ ] Task 7: Integration & Testing (AC: 6, 7, 8, 9, 10)
  - [ ] Integration tests with workflow executor
  - [ ] Test knowledge need detection
  - [ ] Test expert routing accuracy
  - [ ] Test knowledge retrieval source selection
  - [ ] Test knowledge write safety
  - [ ] Test metrics collection

## Dev Notes

**Integration Points:**
- Expert registry: `tapps_agents/experts/expert_registry.py`
- Workflow executor: `tapps_agents/workflow/executor.py` (consult_experts_for_step method)
- Context7 KB: Existing Context7 helper utilities
- Unified Cache: Existing unified cache system
- RAG backends: VectorKnowledgeBase/SimpleKnowledgeBase
- Project profile: `tapps_agents/core/project_profile.py`

**Technology Stack:**
- Python 3.13+
- Existing expert consultation infrastructure
- Existing Context7 KB cache
- Existing Unified Cache

**Key Constraints:**
- Must integrate seamlessly with existing expert registry
- Must not break existing expert consultation workflows
- Knowledge writes must be safe and validated
- Metrics must be lightweight and non-intrusive

**Testing Standards:**
- Test file location: `tests/unit/test_expert_engine.py`
- Test with real workflow steps
- Test knowledge need detection accuracy
- Test routing plan generation
- Test retrieval source selection

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | BMad Master |
| 2025-01-XX | 1.1 | Core implementation complete - Expert Engine orchestrator, routing, retrieval, metrics | BMad Master |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_

