# Story 3.3: RAG Query & Retrieval System

<!-- Source: implementation/cursor/EPIC_03_Expert_System.md -->
<!-- Context: Provide a consistent semantic retrieval API for experts (vector backend when available) -->

## Status

Draft

## Story

**As an** expert consultation consumer (registry/agent),
**I want** a consistent retrieval API that returns relevant knowledge with citations and filtering,
**so that** expert answers can cite sources and stay within latency and safety constraints.

## Acceptance Criteria

1. A retrieval API exists (sync/async as appropriate) that supports:
   - query string
   - top-k
   - similarity/relevance threshold filtering
   - returning provenance (source file + chunk identifier and/or line span)
2. Retrieval returns a bounded context string suitable for prompts, respecting `ExpertConfig.rag_max_length` and `ExpertConfig.rag_max_results`.
3. Retrieval is time-bounded and cancellable; on timeout it returns an empty/partial context with an explicit status (no hard failures).
4. Retrieval for the built-in knowledge corpus completes in <2s average on typical developer hardware (measured and reported).
5. Unit tests cover threshold behavior, max-length bounds, and deterministic ordering.

## Tasks / Subtasks

- [ ] Task 1: Define the retrieval result contract (AC: 1–2)
  - [ ] Define a `RetrievedChunk` structure (text, source, score, provenance)
  - [ ] Define formatting rules for prompt context (source labeling, separators)

- [ ] Task 2: Implement query execution (AC: 1–3)
  - [ ] Implement for vector backend when available
  - [ ] Implement for `SimpleKnowledgeBase` as a fallback adapter

- [ ] Task 3: Filtering + bounding (AC: 2, 5)
  - [ ] Apply similarity/relevance thresholds
  - [ ] Enforce stable sorting and max result count
  - [ ] Enforce max length with graceful truncation

- [ ] Task 4: Performance + timeouts (AC: 3–4)
  - [ ] Add timing metrics/logs and timeout guards
  - [ ] Add a small benchmark harness/test (non-flaky) to report average latency

- [ ] Task 5: Tests (AC: 5)
  - [ ] Add unit tests for deterministic ordering
  - [ ] Add unit tests for thresholding and truncation

## Dev Notes

### Existing System Context

- `tapps_agents/experts/simple_rag.py` implements keyword search and returns chunks with scores + line spans.
- Experts pull context via `tapps_agents/experts/base_expert.py::_build_domain_context`.
- Similarity threshold is currently used for response agreement in `tapps_agents/core/config.py::ExpertConfig.similarity_threshold`.

### Integration Approach

- Add a narrow retrieval API and adapt `SimpleKnowledgeBase` to it; have `BaseExpert` call the API instead of calling `SimpleKnowledgeBase` directly.

### Risk Assessment

- **Risk**: threshold tuning makes retrieval too sparse or too noisy.
- **Mitigation**: make thresholds configurable and add evaluation metrics in Story 3.6.

### Rollback Plan

- Revert to `SimpleKnowledgeBase.get_context()` and `get_sources()` directly.

### Testing

- Extend/align with `tests/unit/experts/test_simple_rag.py` patterns.

## Change Log

| Date       | Version | Description                    | Author      |
| ---------- | ------- | ------------------------------ | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 3.3     | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
