# Story 5.2: Dependency Graph Resolver

<!-- Source: implementation/cursor/EPIC_05_Workflow_Engine.md -->
<!-- Context: Deterministic dependency resolution + cycle detection -->

## Status

Draft

## Story

**As a** workflow execution engine,
**I want** a deterministic dependency graph resolver with cycle detection,
**so that** workflows can safely execute in parallel without deadlocks and with reproducible ordering.

## Acceptance Criteria

1. A dependency graph is constructed from a parsed `Workflow` that captures execution ordering constraints from:
   - step-to-step routing (`next`)
   - gate routing (`gate.on_pass` / `gate.on_fail`)
   - artifact dependencies (`requires` matched to steps that `creates` the artifact)
2. The resolver produces a deterministic execution plan:
   - When multiple steps are simultaneously eligible (“ready”), ordering is stable and reproducible (e.g., sorted by `step.id`).
3. Cycles and deadlocks are detected before execution begins:
   - Circular dependencies (via routing or artifact edges) fail fast with an actionable error including the cycle path and file context.
4. The resolver can provide a debuggable representation of the graph (e.g., adjacency list or DOT output) for troubleshooting.
5. Unit tests cover:
   - cycle detection
   - deterministic ordering
   - artifact dependency resolution (including the case where a required artifact is never produced)

## Tasks / Subtasks

- [ ] Task 1: Inventory current dependency behavior (AC: 1)
  - [ ] Review `tapps_agents/workflow/executor.py::WorkflowExecutor.execute` and `ParallelStepExecutor.find_ready_steps`
  - [ ] Document which fields currently affect readiness (primarily `requires` vs available artifacts)

- [ ] Task 2: Implement graph builder + resolver (AC: 1–4)
  - [ ] Create a `DependencyGraph` model (nodes=steps, edges=constraints) in `tapps_agents/workflow/`
  - [ ] Build edges from `next`, `gate.on_pass`, `gate.on_fail` routing
  - [ ] Build edges from artifact production (`creates`) to artifact consumers (`requires`)
  - [ ] Implement stable topological ordering and “ready set” selection (sorted by `step.id`)
  - [ ] Implement cycle detection and return actionable diagnostics (cycle path)

- [ ] Task 3: Integrate resolver into execution start-up (AC: 2–3)
  - [ ] Run resolver during workflow load/start (prior to execution)
  - [ ] Ensure failures surface as clear errors (workflow file + step ids)

- [ ] Task 4: Tests (AC: 5)
  - [ ] Add unit tests for graph building and cycle detection under `tests/unit/workflow/`
  - [ ] Extend existing executor/parser tests to cover “missing required artifact producer”

## Dev Notes

### Existing System Context

- Readiness/parallelism exists today but is artifact-driven:
  - `tapps_agents/workflow/parallel_executor.py::ParallelStepExecutor.find_ready_steps` currently selects ready steps based on `step.requires` presence in `state.artifacts` (available artifact names).
  - `tapps_agents/workflow/executor.py::WorkflowExecutor.execute` repeatedly calls `find_ready_steps`, runs them, then merges artifacts into `state.artifacts`.
- Routing exists in the YAML model via `WorkflowStep.next` and optionally via reviewer `gate` config.
- Current parser validation checks `next` and `optional_steps` references, but does not validate gate routing target ids.

### Integration Approach

- Keep the existing artifact-based readiness behavior, but add a pre-flight resolver to validate and compute a deterministic plan.
- The resolver should be used for:
  - early failure (cycles, missing producers)
  - deterministic ordering of ready tasks (when multiple are ready)

### Risk Assessment

- **Risk**: Mis-modeling dependencies changes execution semantics.
- **Mitigation**: Keep the artifact readiness checks as the ground truth for runtime readiness, and use the graph primarily for validation + ordering.

### Rollback Plan

- Disable graph pre-flight validation and revert to artifact-only readiness if unexpected regressions occur.

### Testing

- Use `pytest`.
- Existing relevant tests:
  - `tests/unit/workflow/test_parallel_executor.py` (readiness selection)
  - `tests/unit/test_workflow_parser.py` (reference validation)
- Add focused tests for cycle detection and artifact dependency resolution.

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 5.2        | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
