# Story 2.3: Foreground Agents - Code & Design

<!-- Source: implementation/cursor/EPIC_02_Core_Agents.md -->
<!-- Context: Brownfield enhancement to standardize Code + Design agents for Cursor IDE foreground -->

## Status

Draft

## Story

**As a** developer using Cursor IDE workflows,
**I want** Code and Design agents to produce typed, validated outputs and consistent artifacts when run in the foreground,
**so that** the orchestrator can reliably chain steps and aggregate results across multiple agents.

## Acceptance Criteria

1. Code-generation steps (implement/refactor) and design steps (architecture/API design) have **explicit input/output contracts** (typed + validated) and produce machine-readable JSON artifacts with `schema_version`.
2. Foreground agent execution remains compatible with existing invocation patterns:
   - CLI invocation (`tapps-agents ...`)
   - Python API invocation (instantiate → `activate()` → `run()` → `close()`), as documented in `docs/ARCHITECTURE.md`.
3. Each agent run emits deterministic artifacts in the worktree (JSON primary + optional markdown human summary) and avoids unbounded writes.
4. Agent outputs are safe for aggregation: stable ordering for lists, explicit merge rules for overlapping fields.
5. Tests verify at least one golden-path “design → implement” chain can execute with these contracts without breaking existing workflows.

## Tasks / Subtasks

- [ ] Task 1: Identify existing Code + Design agent entrypoints and behaviors (AC: 2)
  - [ ] Review `tapps_agents/agents/implementer/agent.py` and related helpers
  - [ ] Review `tapps_agents/agents/architect/agent.py` and `tapps_agents/agents/designer/agent.py`

- [ ] Task 2: Define versioned contracts and artifact outputs (AC: 1, 3)
  - [ ] Define JSON schema fields per agent (inputs, outputs, status, errors, timings)
  - [ ] Define deterministic artifact paths under worktrees

- [ ] Task 3: Implement validation at boundaries (AC: 1)
  - [ ] Validate incoming parameters at `run()` boundary
  - [ ] Validate outgoing result dictionaries before writing artifacts

- [ ] Task 4: Ensure aggregation-friendly outputs (AC: 4)
  - [ ] Stabilize ordering in output lists
  - [ ] Document merge/override rules for overlapping keys

- [ ] Task 5: Golden-path tests (AC: 5)
  - [ ] Add/extend integration tests that execute a minimal design→implement chain

## Dev Notes

### Existing System Context

- Agents share a common base (`tapps_agents/core/agent_base.py`) and are located under `tapps_agents/agents/`.
- Cursor-mode workflow execution uses `tapps_agents/workflow/cursor_executor.py`, which currently invokes Skills via `SkillInvoker`.
- Architecture docs list agent invocation patterns and the current agent roster (`docs/ARCHITECTURE.md`).

### Integration Approach

- Keep existing agent logic, but standardize **artifact emission** and **contract validation** so orchestrated execution can depend on stable structures.
- Emit both:
  - machine-readable JSON (primary, versioned)
  - optional markdown (human-friendly summary)

### Risk Assessment

- **Primary risk**: tightening contracts breaks existing workflows that pass loose parameters.
- **Mitigation**: validate with clear error messages and keep backward-compatible aliases where already supported (e.g., action name normalization).

### Rollback Plan

- Allow contract validation to be disabled via configuration during transition; continue emitting artifacts best-effort.

### Testing

- Use existing unit/integration structure under `tests/`.
- Prefer tests that exercise `activate()`/`run()` for these agents in a temp project root.

## Change Log

| Date       | Version | Description                           | Author      |
| ---------- | ------- | ------------------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 2.3            | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
