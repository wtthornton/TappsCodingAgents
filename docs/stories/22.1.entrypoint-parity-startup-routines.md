# Story 22.1: Entrypoint Parity for Startup Routines

<!-- Source: implementation/cursor/EPIC_22_CLI_Reliability_And_Entrypoint_Parity.md -->
<!-- Context: Ensure startup routines (Context7 refresh / initialization) behave identically for console script and module invocation -->

## Status

**Deferred** - CLI maintenance item, lower priority

## Story

**As a** CLI user and maintainer,
**I want** startup routines to execute consistently no matter how the CLI is invoked (`tapps-agents` vs `python -m tapps_agents.cli`),
**so that** behavior is predictable and scripts/CI donâ€™t accidentally diverge based on entrypoint.

## Acceptance Criteria

1. `tapps-agents <cmd> ...` and `python -m tapps_agents.cli <cmd> ...` execute the **same** startup routines under the same conditions.
2. Startup routines are **explicit and bounded**:
   - Default behavior does **not** block normal commands for long-running work.
   - Startup work runs in the background (best-effort) unless explicitly configured otherwise.
3. Startup routines do **not** cause nested event loop issues (no double `asyncio.run()` boundaries).
4. Startup behavior is clearly documented:
   - what runs,
   - when it runs,
   - what it writes under `.tapps-agents/`,
   - how to disable it (e.g., via config/flag/env) for CI or constrained environments.
5. Regression coverage exists demonstrating parity across both entrypoints.

## Tasks / Subtasks

- [ ] Task 1: Audit current entrypoint behavior and identify divergence (AC: 1)
  - [ ] Confirm how `pyproject.toml`/`setup.py` console script calls `tapps_agents.cli:main`
  - [ ] Confirm current `__main__` path behavior in `tapps_agents/cli.py` (startup routines run only there)

- [ ] Task 2: Centralize startup execution so both entrypoints share it (AC: 1, 3)
  - [ ] Refactor so startup routines are invoked from a single shared entry function
  - [ ] Remove/avoid startup logic living only under `if __name__ == "__main__"` (or ensure it delegates to the same path)
  - [ ] Ensure there is a single event-loop boundary for startup + command execution

- [ ] Task 3: Bound and make startup explicit (AC: 2, 4)
  - [ ] Ensure background refresh is the default, best-effort path
  - [ ] Add clear documentation for side effects (files/dirs created under `.tapps-agents/`)
  - [ ] Document (and implement if missing) a supported way to disable startup routines for CI/scripts

- [ ] Task 4: Add parity regression tests (AC: 5)
  - [ ] Add a test that runs the CLI via module invocation and console-script entrypoint and asserts identical startup indicators/side effects
  - [ ] Ensure tests are Windows-friendly (path handling, subprocess quoting)

## Dev Notes

### Existing System Context

- Console script entrypoint:
  - `tapps-agents=tapps_agents.cli:main` (see `pyproject.toml` and `setup.py`)
- Module invocation:
  - `python -m tapps_agents.cli ...`
- Startup routines:
  - `tapps_agents/core/startup.py` (`startup_routines`, `refresh_stale_documentation`)
- Current divergence:
  - `tapps_agents/cli.py` runs startup routines only in the `__main__` block, so console script bypasses startup.

### Integration Approach

- Introduce a single shared entry function that:
  - decides whether startup routines run,
  - executes startup (background by default),
  - runs the CLI command handler,
  - returns a process exit code.

### Risk Assessment

- **Primary risk**: startup side effects unexpectedly run in more environments (console script) and surprise users.
- **Mitigation**: make behavior explicit + documented; keep background/non-blocking default; provide an explicit disable mechanism.

### Testing

- Add parity checks across entrypoints using subprocess-based CLI tests.

## Change Log

| Date       | Version | Description                                   | Author      |
| ---------- | ------- | --------------------------------------------- | ----------- |
| 2025-12-16 | 0.1     | Initial draft for Epic 22.1                   | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_


