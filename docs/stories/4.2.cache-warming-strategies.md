# Story 4.2: Cache Warming Strategies

<!-- Source: implementation/cursor/EPIC_04_Context7_Integration.md -->
<!-- Context: Brownfield enhancements to Context7 refresh + warm-up behavior -->

## Status

Draft

## Story

**As a** workflow agent running on a project,
**I want** automatic Context7 KB cache warming based on project dependencies and usage patterns,
**so that** library documentation lookups are fast and mostly offline during agent execution.

## Acceptance Criteria

1. Project-based library detection exists and is used for warming:
   - Python dependencies from `requirements.txt` and/or `pyproject.toml`
   - Optional JS dependencies from `package.json` when present
2. A cache warming priority system exists that queues warm/refresh work with clear ordering (e.g., “project deps” > “common libs” > “popular by analytics”).
3. Warming behavior is controlled by existing config flags (no hardcoding):
   - `context7.enabled`
   - `context7.knowledge_base.enabled`
   - `context7.refresh.enabled`, `auto_queue`, and `auto_process_on_startup`
4. Warming is safe under partial capability:
   - When MCP/credentials are unavailable, warming is skipped (with a clear debug signal), but agents still run.
5. Unit tests cover dependency detection and queueing/priority behavior (no real API calls required).

## Tasks / Subtasks

- [ ] Task 1: Implement dependency discovery utilities (AC: 1)
  - [ ] Reuse/extend `scripts/prepopulate_context7_cache.py::parse_requirements_file`
  - [ ] Add optional parsing for `pyproject.toml` and `package.json` (best-effort; ignore malformed files)

- [ ] Task 2: Implement warming/queue strategy (AC: 2–3)
  - [ ] Use `tapps_agents/context7/refresh_queue.py::RefreshQueue` to enqueue warm/refresh tasks
  - [ ] Use `tapps_agents/context7/staleness_policies.py::StalenessPolicyManager` to derive refresh urgency
  - [ ] Implement prioritization rules (e.g., project deps priority 8–10; common libs priority 6–7; analytics top libs priority 4–6)

- [ ] Task 3: Wire warming into startup/activation (AC: 3–4)
  - [ ] Add a single integration point (e.g., in `tapps_agents/core/startup.py` or `BaseAgent.activate`) that:
    - [ ] auto-queues warm tasks when enabled
    - [ ] optionally processes a bounded number of queued tasks on startup when `auto_process_on_startup` is true

- [ ] Task 4: Add tests (AC: 5)
  - [ ] Add unit tests for parsing `requirements.txt`/`pyproject.toml`/`package.json` inputs
  - [ ] Add unit tests for refresh queue priority ordering using `RefreshQueue.get_next_task()`

## Dev Notes

### Existing System Context

- Refresh controls already exist in config:
  - `tapps_agents/core/config.py::Context7RefreshConfig` defines `enabled`, `auto_queue`, `auto_process_on_startup`, and `check_on_access`.
- Refresh queue and prioritization infrastructure already exists:
  - `tapps_agents/context7/refresh_queue.py` stores tasks in a durable YAML/JSON queue file and prioritizes by `priority` + `added_at`.
- Staleness policies already exist:
  - `tapps_agents/context7/staleness_policies.py::StalenessPolicyManager` provides default “stable/active/critical” policies and a `get_refresh_recommendation()`.
- Warming inputs already exist for Python requirements:
  - `scripts/prepopulate_context7_cache.py` extracts libraries from `requirements.txt` and can optionally include topic warming.

### Integration Approach

- Prefer using the existing `RefreshQueue` for warm work so warming and staleness refresh share a single mechanism.
- Keep warming bounded and non-blocking: process only a small number of queued tasks per startup to avoid delaying agent response.

### Risk Assessment

- **Risk**: warming creates noisy background work and slows activation.
- **Mitigation**: strict bounds + config gating; warming is optional and should degrade gracefully if Context7 is unavailable.

### Rollback Plan

- Disable warming via config (`context7.refresh.auto_queue=false`, `auto_process_on_startup=false`).

### Testing

- Use the existing patterns in `tests/unit/context7/test_refresh_queue.py` and `tests/unit/context7/test_staleness_policies.py`.

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 4.2        | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
