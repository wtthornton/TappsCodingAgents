# Story 8.4: Step-Level Progress Details

<!-- Source: implementation/EPIC_08_Real_Time_Progress_Updates.md -->

## Status

**Ready for Review**

## Story

**As a** user running workflows,
**I want** detailed step-level progress information,
**so that** I understand what each agent is doing and how long steps take.

## Acceptance Criteria

1. Step details include agent name, action, and target information
2. Step duration is tracked and displayed for completed steps
3. Step status indicators clearly show pending, running, completed, and failed states
4. Step summary messages describe what the agent is currently doing
5. Step details are included in progress update messages sent to Cursor chat

## Tasks / Subtasks

- [x] Task 1: Extract step detail information (AC: 1)
  - [x] Parse agent name from step definition (step.agent field)
  - [x] Extract action from step definition (step.action field)
  - [x] Extract target from step definition (step.target or variables)
  - [x] Format step details for display in progress updates

- [x] Task 2: Implement step duration tracking (AC: 2)
  - [x] Track step start time when step execution begins
  - [x] Calculate duration when step completes (completed_at - started_at)
  - [x] Format duration for display (seconds, minutes, hours)
  - [x] Show elapsed time for running steps (current_time - started_at)

- [x] Task 3: Create step status indicators (AC: 3)
  - [x] Define status indicators for each state: pending (‚è≥), running (üîÑ), completed (‚úÖ), failed (‚ùå)
  - [x] Update status indicators in real-time as steps transition
  - [x] Ensure status indicators are visually distinct and clear
  - [x] Add status text labels alongside emoji indicators

- [x] Task 4: Generate step summary messages (AC: 4)
  - [x] Create StepSummaryGenerator class
  - [x] Generate human-readable summary from step details (agent + action + target)
  - [x] Format summary for display: "Agent {name} is {action} {target}"
  - [x] Handle edge cases (no target, complex actions, variable interpolation)

- [x] Task 5: Integrate step details into progress updates (AC: 5)
  - [x] Extend ProgressUpdateGenerator to include step details
  - [x] Add current step information to progress update messages
  - [x] Include step summary in update message body
  - [x] Show step duration in completed step summaries

## Dev Notes

### Existing System Context

- Step execution data in `WorkflowState.step_executions` list
- Step definitions in workflow YAML with agent, action, target fields
- Step execution tracking in `StepExecution` objects (started_at, completed_at, status, error)
- Progress update system from Story 8.1 formats updates
- Status monitoring from Story 8.2 detects step state changes

### Integration Approach

- Extend ProgressUpdateGenerator from Story 8.1 with step detail methods
- Create StepDetailExtractor class to parse step information
- Enhance StepExecution tracking to include more detail (already has most fields)
- Integrate step details into update message templates
- Step duration calculation uses existing StepExecution timestamps

### Technical Considerations

- Step details extraction must handle various step definition formats
- Variable interpolation needed for target fields (e.g., `{file_path}`)
- Duration formatting should be human-readable (1m 30s vs 90s)
- Step summaries should be concise but informative
- Current step display needs to update as execution progresses
- Handle parallel step execution (multiple steps running simultaneously)

### Risk Assessment

- **Primary risk**: Step target extraction may fail for complex variable interpolation
  - **Mitigation**: Graceful fallback, show raw target if interpolation fails, log interpolation errors
- **Primary risk**: Step duration may be inaccurate if step_executions not updated correctly
  - **Mitigation**: Use WorkflowState timestamps, handle missing timestamp fields gracefully
- **Primary risk**: Step summaries may be too verbose for chat display
  - **Mitigation**: Configurable verbosity, truncate long targets, show essential info only

### Rollback Plan

- Step details are enhancement to progress updates
- Can disable detailed step info via configuration
- Falls back to basic progress (step number, percentage) if step details fail
- No changes to step execution or state tracking

### Testing

- Unit tests for StepDetailExtractor (agent, action, target parsing)
- Unit tests for StepSummaryGenerator (summary generation, formatting)
- Unit tests for duration formatting (seconds, minutes, hours, edge cases)
- Integration tests with WorkflowState to verify step detail extraction
- Test step status transitions (pending ‚Üí running ‚Üí completed/failed)
- Test variable interpolation in step targets
- Test parallel step execution (multiple current steps)
- Visual testing in Cursor chat to verify step detail display

## Change Log

| Date       | Version | Description                     | Author      |
| ---------- | ------- | ------------------------------- | ----------- |
| 2025-01-27 | 0.1     | Initial draft for Epic 8.4      | bmad-master |

## Dev Agent Record

_TBD_

## QA Results

_TBD_

