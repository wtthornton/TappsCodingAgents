# Story 1.1: Git Worktree Management

<!-- Source: implementation/cursor/EPIC_01_Foundation.md -->
<!-- Context: Brownfield enhancement to existing workflow + worktree infrastructure -->

## Status

✅ **Completed** - 2025-12-14

## Story

**As a** workflow/orchestration runner,
**I want** reliable git worktree creation/cleanup for each workflow step,
**so that** multiple agents/steps can run in isolated workspaces without corrupting the repo or colliding with each other.

## Acceptance Criteria

1. Worktrees for workflow steps are created under `.tapps-agents/worktrees/` with deterministic, collision-resistant naming.
2. Worktree creation uses git worktrees when available; when git worktree fails, a safe fallback workspace is created with the **correct repo content** for this project (e.g., `tapps_agents/`, `tests/`, `docs/`, `workflows/`, `pyproject.toml`).
3. Worktree removal is safe and idempotent (removing a missing/partially-created worktree does not raise or leave the repo in a worse state).
4. Cleanup supports removing all workflow/agent worktrees without affecting the main working tree.
5. Existing Cursor-mode workflow execution that creates worktrees per step continues to work (`tapps_agents/workflow/cursor_executor.py`).
6. Unit tests cover create/remove/cleanup paths, including a “branch already exists” scenario and the fallback path.

## Tasks / Subtasks

- [ ] Task 1: Audit current worktree implementations (AC: 1)
  - [ ] Review `tapps_agents/workflow/worktree_manager.py` (async, workflow-step oriented)
  - [ ] Review `tapps_agents/core/worktree.py` (sync, background-agent oriented)
  - [ ] Decide/implement a single clear ownership boundary (or shared helper) to avoid divergent behavior

- [ ] Task 2: Harden workflow-step worktree creation (AC: 1, 2, 5)
  - [ ] Ensure unique naming strategy for `CursorWorkflowExecutor` step worktrees (currently `workflow-{workflow_id}-step-{step.id}`)
  - [ ] Handle branch collisions deterministically (existing code attempts `-b workflow/<name>` then retries)
  - [ ] Ensure all worktree paths are created under `.tapps-agents/worktrees/`

- [ ] Task 3: Fix fallback copy behavior (AC: 2)
  - [ ] Replace the current fallback “essential items” list with this repo’s actual structure (`tapps_agents/`, `tests/`, `docs/`, `workflows/`, `pyproject.toml`, etc.)
  - [ ] Verify fallback still allows Skills/agents to run from within the worktree

- [ ] Task 4: Make cleanup robust + safe (AC: 3, 4)
  - [ ] Ensure `remove_worktree()` handles partially-created worktrees and git failures
  - [ ] Add optional `git worktree prune` safety pass (best-effort)
  - [ ] Ensure cleanup never deletes outside `.tapps-agents/worktrees/`

- [ ] Task 5: Tests (AC: 6)
  - [ ] Add unit tests using `tmp_path` and an isolated temp git repo where needed
  - [ ] Add a test that simulates a git worktree failure and validates the fallback workspace content

## Dev Notes

### Existing System Context

- Worktrees are currently created for Cursor-mode workflow steps in:
  - `tapps_agents/workflow/cursor_executor.py` (creates worktrees per step)
- Workflow-step worktree logic currently lives in:
  - `tapps_agents/workflow/worktree_manager.py`
- Separate background-agent worktree utilities exist in:
  - `tapps_agents/core/worktree.py`

### Integration Approach

- Prefer keeping `CursorWorkflowExecutor` as the caller and hardening the underlying worktree creation/removal paths.
- Ensure both worktree managers do not drift (either share a helper or define non-overlapping responsibilities).

### Risk Assessment

- **Primary risk**: repository corruption / worktree detritus (stale branches, broken worktree refs)
- **Mitigation**: strict path scoping, idempotent cleanup, best-effort prune, and tests around failure cases.

### Rollback Plan

- Revert the worktree changes and remove worktrees via `git worktree prune` + deleting `.tapps-agents/worktrees/` entries.

### Testing

- Use existing `pytest` suite under `tests/`.
- Focus tests on:
  - create/remove idempotency
  - fallback behavior
  - Cursor executor integration (mocked)

## Change Log

| Date       | Version | Description                     | Author      |
| ---------- | ------- | ------------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 1.1      | bmad-master |
| 2025-12-14 | 1.0     | ✅ Story completed - All AC met  | Auto        |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- ✅ All 6 acceptance criteria met
- ✅ `WorktreeManager` class implemented in `tapps_agents/workflow/worktree_manager.py`
- ✅ Worktrees created under `.tapps-agents/worktrees/` with deterministic naming
- ✅ Safe cleanup and removal methods implemented
- ✅ Integration with `CursorWorkflowExecutor` working

### File List

**Modified Files:**
- `tapps_agents/workflow/worktree_manager.py` - Core worktree management implementation
- `tapps_agents/workflow/cursor_executor.py` - Integration with workflow execution
- `tests/unit/workflow/test_worktree_manager.py` - Comprehensive test coverage

## QA Results

✅ **Implementation Complete**
- Worktree creation, removal, and cleanup tested
- Integration with workflow executor verified
- No linter errors
