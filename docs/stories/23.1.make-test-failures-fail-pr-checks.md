# Story 23.1: Make test failures fail PR checks

<!-- Source: implementation/cursor/EPIC_23_CI_Gating_And_Workflow_Consolidation.md -->
<!-- Context: CI must be enforceable (no "false green") while preserving always-on artifact upload for debugging -->

```yaml
story_id: 23.1
title: Make test failures fail PR checks
description: Ensure PR-gating CI jobs fail reliably when tests fail, while still uploading diagnostics artifacts and producing actionable job summaries.
epic: EPIC_23_CI_Gating_And_Workflow_Consolidation
domain: CI/CD
priority: high
complexity: 3
status: draft
created_at: 2025-12-16
created_by: planner
```

## Acceptance Criteria

- [ ] PR workflows return non-zero when tests fail (no “continue-on-error” masking on required checks).
- [ ] Artifact upload still occurs on failures via `if: always()`, without changing the final job conclusion to success.
- [ ] CI produces a clear job summary identifying which phase failed (lint/type/unit/e2e), with concrete reproduction steps.
- [ ] PR gating remains fast and deterministic (deep suites remain scheduled/nightly; no secrets required for PRs).

## Tasks

1. Audit existing CI gating behavior
   - Identify any `continue-on-error: true`, `|| true`, or equivalent patterns in CI jobs that are intended to gate PRs.
   - Identify where artifacts are uploaded and whether uploads are conditional on success.

2. Implement strict failure propagation for PR-gating jobs
   - Ensure test steps fail the job when the test runner fails (no masking).
   - Where artifacts/logs are needed, move them to dedicated steps that run with `if: always()`.

3. Add job summary output for failure diagnosis
   - Emit a concise summary including failing command(s), links to artifacts, and “run locally” instructions.
   - Ensure summaries are present both on success and failure (with failure detail when failing).

4. Add verification scenario(s) for “known failing test”
   - Document how to intentionally trigger a failing test in CI (or add a temporary/controlled failing test approach) to validate gating.
   - Confirm CI status reflects failure (Definition of Done IV1).

## Technical Notes

- EPIC_23 references GitHub Actions workflows at `.github/workflows/{ci.yml,test.yml,e2e.yml}`; those files may need to be created in this repo if not present.
- Avoid “false green” patterns:
  - `continue-on-error: true` on gating steps
  - `command || true`
  - unconditional `exit 0` wrappers
- Preserve diagnostic capture using `if: always()` for uploads and summaries without masking failure state.

## Dependencies

- Related stories: ["23.2", "23.4"]
- Blocks: ["23.2", "23.4"]
- Blocked by: []


