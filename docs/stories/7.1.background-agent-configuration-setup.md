# Story 7.1: Background Agent Configuration Setup and Validation

<!-- Source: implementation/EPIC_07_Background_Agent_Auto_Execution.md -->

## Status

**âœ… Completed**

**Last Updated:** 2025-01-27

## Story

**As a** framework user,
**I want** a Background Agent configuration template and validation system for auto-execution setup,
**so that** I can easily configure Background Agents to automatically execute workflow commands without manual intervention.

## Acceptance Criteria

1. Background Agent configuration template created for `.cursor/background-agents.yaml` with auto-execution support
2. Configuration schema validation implemented (YAML structure, required fields, valid values)
3. Configuration generator/initializer tool created for auto-execution setup
4. Configuration validation tool verifies Background Agent setup and reports issues
5. Configuration documentation and examples provided

## Tasks / Subtasks

- [x] Task 1: Create configuration template (AC: 1)
  - [x] Define YAML schema for Background Agent auto-execution
  - [x] Create template file with all required fields
  - [x] Add optional fields for customization
  - [x] Include comments and examples in template

- [x] Task 2: Implement schema validation (AC: 2)
  - [x] Create YAML schema validator using PyYAML or similar
  - [x] Validate required fields (name, type, commands, watch_paths)
  - [x] Validate field types and formats
  - [x] Add validation error messages with clear guidance
  - [x] Test validation with valid and invalid configurations

- [x] Task 3: Create configuration generator (AC: 3)
  - [x] Implement CLI command or function to generate initial config
  - [x] Auto-detect project structure and suggest configuration
  - [x] Generate configuration with sensible defaults
  - [x] Support interactive and non-interactive modes
  - [x] Create configuration in `.cursor/background-agents.yaml`

- [x] Task 4: Create validation tool (AC: 4)
  - [x] Implement validation command/function
  - [x] Check file existence and permissions
  - [x] Validate YAML syntax and schema
  - [x] Verify Background Agent accessibility
  - [x] Report validation results with actionable feedback

- [x] Task 5: Write documentation (AC: 5)
  - [x] Document configuration format and fields
  - [x] Provide setup guide with step-by-step instructions
  - [x] Create example configurations for common scenarios
  - [x] Document troubleshooting common issues
  - [x] Add configuration reference documentation

## Dev Notes

### Existing System Context

- Background Agent configuration file location: `.cursor/background-agents.yaml`
- Existing configuration format from `docs/BACKGROUND_AGENTS_GUIDE.md`:
  ```yaml
  agents:
    - name: "TappsCodingAgents Quality Analyzer"
      type: "background"
      description: "Analyze project quality, generate reports"
      commands:
        - "python -m tapps_agents.cli reviewer analyze-project --format json"
      context7_cache: ".tapps-agents/kb/context7-cache"
      triggers:
        - "Analyze project quality"
        - "Generate quality report"
  ```
- Command file format: `.cursor-skill-command.txt` (JSON format with `command`, `workflow_id`, `step_id`, `worktree_path`)
- Worktree management: `tapps_agents/workflow/worktree_manager.py`
- Project root detection: `tapps_agents/core/config.py`

### Integration Approach

- Create configuration template in `templates/background_agents/` directory
- Implement validation in `tapps_agents/workflow/background_agent_config.py`
- Add CLI commands to `tapps_agents/cli/` for config generation and validation
- Follow existing YAML configuration patterns from project
- Use PyYAML for YAML parsing and validation
- Integrate with existing Background Agent infrastructure

### Technical Details

**Configuration Schema:**
- Required fields: `name`, `type` (must be "background"), `commands` (list), `watch_paths` (list of paths to watch for command files)
- Optional fields: `description`, `context7_cache`, `triggers`, `timeout_seconds`, `retry_count`, `enabled`
- Watch paths should support patterns like `**/.cursor-skill-command.txt`

**File Locations:**
- Template: `templates/background_agents/auto-execution-template.yaml`
- Config validator: `tapps_agents/workflow/background_agent_config.py`
- CLI commands: `tapps_agents/cli/config.py` (add commands)
- Documentation: `docs/BACKGROUND_AGENTS_GUIDE.md` (update with auto-execution section)

### Risk Assessment

- **Primary risk**: Configuration format may conflict with existing Background Agent configs
  - **Mitigation**: Make auto-execution features optional, backward compatible with existing configs
- **Primary risk**: Validation may be too strict or miss edge cases
  - **Mitigation**: Comprehensive testing, clear error messages, allow warnings vs errors

### Rollback Plan

- Configuration is optional (opt-in feature)
- Can disable auto-execution via configuration flag
- No breaking changes to existing Background Agent functionality

### Testing

- Unit tests for configuration schema validation
- Unit tests for configuration generator
- Integration tests for validation tool
- Test with valid and invalid configurations
- Test backward compatibility with existing configs
- Test configuration generation in different project structures

## Change Log

| Date       | Version | Description                     | Author      |
| ---------- | ------- | ------------------------------- | ----------- |
| 2025-01-27 | 0.1     | Initial draft for Epic 7.1     | bmad-master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Completion Notes

- Created configuration template at `templates/background_agents/auto-execution-template.yaml`
- Implemented `BackgroundAgentConfigValidator` class with comprehensive validation
- Implemented `BackgroundAgentConfigGenerator` class for configuration generation
- Added CLI commands: `background-agent-config generate` and `background-agent-config validate`
- Updated `docs/BACKGROUND_AGENTS_GUIDE.md` with auto-execution configuration section
- All acceptance criteria met

### File List

- `templates/background_agents/auto-execution-template.yaml` (new)
- `tapps_agents/workflow/background_agent_config.py` (new)
- `tapps_agents/cli/parsers/top_level.py` (modified - added background-agent-config parser)
- `tapps_agents/cli/commands/top_level.py` (modified - added handle_background_agent_config_command)
- `tapps_agents/cli/main.py` (modified - added routing for background-agent-config)
- `docs/BACKGROUND_AGENTS_GUIDE.md` (modified - added auto-execution section)

## QA Results

_TBD_

