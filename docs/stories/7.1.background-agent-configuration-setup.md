# Story 7.1: Background Agent Configuration Setup and Validation

<!-- Source: implementation/EPIC_07_Background_Agent_Auto_Execution.md -->

## Status

**Draft**

## Story

**As a** framework user,
**I want** a Background Agent configuration template and validation system for auto-execution setup,
**so that** I can easily configure Background Agents to automatically execute workflow commands without manual intervention.

## Acceptance Criteria

1. Background Agent configuration template created for `.cursor/background-agents.yaml` with auto-execution support
2. Configuration schema validation implemented (YAML structure, required fields, valid values)
3. Configuration generator/initializer tool created for auto-execution setup
4. Configuration validation tool verifies Background Agent setup and reports issues
5. Configuration documentation and examples provided

## Tasks / Subtasks

- [ ] Task 1: Create configuration template (AC: 1)
  - [ ] Define YAML schema for Background Agent auto-execution
  - [ ] Create template file with all required fields
  - [ ] Add optional fields for customization
  - [ ] Include comments and examples in template

- [ ] Task 2: Implement schema validation (AC: 2)
  - [ ] Create YAML schema validator using PyYAML or similar
  - [ ] Validate required fields (name, type, commands, watch_paths)
  - [ ] Validate field types and formats
  - [ ] Add validation error messages with clear guidance
  - [ ] Test validation with valid and invalid configurations

- [ ] Task 3: Create configuration generator (AC: 3)
  - [ ] Implement CLI command or function to generate initial config
  - [ ] Auto-detect project structure and suggest configuration
  - [ ] Generate configuration with sensible defaults
  - [ ] Support interactive and non-interactive modes
  - [ ] Create configuration in `.cursor/background-agents.yaml`

- [ ] Task 4: Create validation tool (AC: 4)
  - [ ] Implement validation command/function
  - [ ] Check file existence and permissions
  - [ ] Validate YAML syntax and schema
  - [ ] Verify Background Agent accessibility
  - [ ] Report validation results with actionable feedback

- [ ] Task 5: Write documentation (AC: 5)
  - [ ] Document configuration format and fields
  - [ ] Provide setup guide with step-by-step instructions
  - [ ] Create example configurations for common scenarios
  - [ ] Document troubleshooting common issues
  - [ ] Add configuration reference documentation

## Dev Notes

### Existing System Context

- Background Agent configuration file location: `.cursor/background-agents.yaml`
- Existing configuration format from `docs/BACKGROUND_AGENTS_GUIDE.md`:
  ```yaml
  agents:
    - name: "TappsCodingAgents Quality Analyzer"
      type: "background"
      description: "Analyze project quality, generate reports"
      commands:
        - "python -m tapps_agents.cli reviewer analyze-project --format json"
      context7_cache: ".tapps-agents/kb/context7-cache"
      triggers:
        - "Analyze project quality"
        - "Generate quality report"
  ```
- Command file format: `.cursor-skill-command.txt` (JSON format with `command`, `workflow_id`, `step_id`, `worktree_path`)
- Worktree management: `tapps_agents/workflow/worktree_manager.py`
- Project root detection: `tapps_agents/core/config.py`

### Integration Approach

- Create configuration template in `templates/background_agents/` directory
- Implement validation in `tapps_agents/workflow/background_agent_config.py`
- Add CLI commands to `tapps_agents/cli/` for config generation and validation
- Follow existing YAML configuration patterns from project
- Use PyYAML for YAML parsing and validation
- Integrate with existing Background Agent infrastructure

### Technical Details

**Configuration Schema:**
- Required fields: `name`, `type` (must be "background"), `commands` (list), `watch_paths` (list of paths to watch for command files)
- Optional fields: `description`, `context7_cache`, `triggers`, `timeout_seconds`, `retry_count`, `enabled`
- Watch paths should support patterns like `**/.cursor-skill-command.txt`

**File Locations:**
- Template: `templates/background_agents/auto-execution-template.yaml`
- Config validator: `tapps_agents/workflow/background_agent_config.py`
- CLI commands: `tapps_agents/cli/config.py` (add commands)
- Documentation: `docs/BACKGROUND_AGENTS_GUIDE.md` (update with auto-execution section)

### Risk Assessment

- **Primary risk**: Configuration format may conflict with existing Background Agent configs
  - **Mitigation**: Make auto-execution features optional, backward compatible with existing configs
- **Primary risk**: Validation may be too strict or miss edge cases
  - **Mitigation**: Comprehensive testing, clear error messages, allow warnings vs errors

### Rollback Plan

- Configuration is optional (opt-in feature)
- Can disable auto-execution via configuration flag
- No breaking changes to existing Background Agent functionality

### Testing

- Unit tests for configuration schema validation
- Unit tests for configuration generator
- Integration tests for validation tool
- Test with valid and invalid configurations
- Test backward compatibility with existing configs
- Test configuration generation in different project structures

## Change Log

| Date       | Version | Description                     | Author      |
| ---------- | ------- | ------------------------------- | ----------- |
| 2025-01-27 | 0.1     | Initial draft for Epic 7.1     | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

_TBD_

## QA Results

_TBD_

