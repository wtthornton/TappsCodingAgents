# Story 5.4: Workflow State Management (Resumable) + Append-Only Event Log

<!-- Source: implementation/cursor/EPIC_05_Workflow_Engine.md -->
<!-- Context: Resumability, auditability, and deterministic replay -->

## Status

Draft

## Story

**As a** user running long or multi-step workflows,
**I want** workflow state to persist across runs with an append-only event log,
**so that** I can resume execution, audit what happened, and debug failures reliably.

## Acceptance Criteria

1. Workflow state persists across runs and supports resume:
   - The last workflow state can be reloaded and execution can continue from the last known step.
2. An append-only workflow event log is recorded for every workflow run:
   - Events include workflow start/end and step start/finish/fail/skip.
   - Events include enough context for audit (workflow_id, step_id, agent, timestamps, status, and artifact summaries).
3. Event logging is durable and safe under interruption:
   - Writes are atomic/best-effort durable and do not corrupt existing logs.
   - Event ordering is deterministic (or can be deterministically sorted on read) and includes monotonic sequence ids.
4. The engine can generate a human-readable execution history from persisted data (state history and/or event log), suitable for debugging and timeline creation.
5. Tests cover persistence/resume and event log correctness without breaking existing persistence tests.

## Tasks / Subtasks

- [ ] Task 1: Confirm state persistence/resume behavior (AC: 1)
  - [ ] Review `tapps_agents/workflow/state_manager.py::AdvancedStateManager` and `WorkflowExecutor.load_last_state`
  - [ ] Identify gaps for Epic 5 requirements (auditability/event stream)

- [ ] Task 2: Define event log format and storage location (AC: 2–3)
  - [ ] Choose JSONL (one JSON object per line) or similar append-only format
  - [ ] Define event schema (event_type, workflow_id, seq, timestamp, step_id, agent, action, status, error, artifacts)
  - [ ] Store under `.tapps-agents/workflow-state/events/` (or under the existing state dir)

- [ ] Task 3: Implement event emission hooks (AC: 2–4)
  - [ ] Emit workflow start/end events in `WorkflowExecutor.start` / completion
  - [ ] Emit step lifecycle events from `WorkflowExecutor.execute` / `ParallelStepExecutor.execute_parallel`
  - [ ] Ensure event emission does not crash workflows (best-effort)

- [ ] Task 4: Provide history/report generation (AC: 4)
  - [ ] Add a helper to load/format event log and produce a readable summary
  - [ ] Integrate with existing timeline generation (`tapps_agents/workflow/timeline.py`) if appropriate

- [ ] Task 5: Tests (AC: 5)
  - [ ] Extend persistence tests to validate event log creation
  - [ ] Add unit tests for event ordering and schema

## Dev Notes

### Existing System Context

- Advanced persistence already exists:
  - `tapps_agents/workflow/state_manager.py::AdvancedStateManager` supports:
    - versioning and migration (`CURRENT_STATE_VERSION`, `StateMigrator`)
    - integrity checks (`StateValidator` checksum)
    - history snapshots (`state/history/`)
    - last pointer (`last.json`)
- WorkflowExecutor integrates persistence:
  - `tapps_agents/workflow/executor.py::WorkflowExecutor.save_state` uses `AdvancedStateManager` when enabled.
  - Resume path exists via `WorkflowExecutor.load_last_state`.
- Existing tests:
  - `tests/unit/workflow/test_advanced_state_manager.py`
  - `tests/unit/test_workflow_resume_persistence.py`

### Integration Approach

- Keep existing snapshot persistence as-is, add an append-only event log alongside it for audit/debug.
- Event log should be used for:
  - debugging “why did this run do X?”
  - producing summaries / timelines even if snapshots are missing

### Risk Assessment

- **Risk**: Event log write overhead impacts runtime.
- **Mitigation**: Keep events small, write best-effort, and avoid expensive serialization in hot loops.

### Rollback Plan

- Disable event log emission while keeping snapshot persistence and resume features.

### Testing

- Use `pytest`.
- Maintain existing resume/persistence tests:
  - `tests/unit/test_workflow_resume_persistence.py`
  - `tests/unit/workflow/test_advanced_state_manager.py`

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 5.4        | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
