# Story 29.2: Customization Loader Implementation

<!-- Source: implementation/EPIC_01_Update_Safe_Agent_Customization_Layer.md -->
<!-- Context: Brownfield enhancement - Core customization loading logic -->

## Status

**Ready for Review**

## Story

**As a** framework user,
**I want** a customization loader that finds and merges my customizations with base agent configurations,
**so that** my customizations are applied correctly without breaking base agent functionality.

## Acceptance Criteria

1. Customization loader checks for `{agent-id}-custom.yaml` in `.tapps-agents/customizations/` directory
2. Loader successfully reads and parses valid YAML customization files
3. Merge logic correctly applies persona_overrides (additions and overrides)
4. Merge logic correctly applies command_overrides (additions and modifications)
5. Merge logic correctly applies dependency_overrides (additions to tasks, templates, data)
6. Error handling gracefully handles missing customization files (no error, uses base config)
7. Error handling gracefully handles invalid YAML (logs error, uses base config)
8. Error handling gracefully handles missing referenced files (warns user, continues with available files)

## Tasks / Subtasks

- [x] Task 1: Implement file discovery (AC: 1)
  - [x] Create function to check for customization file by agent_id
  - [x] Handle case-insensitive agent_id matching
  - [x] Support both `{agent-id}-custom.yaml` and `{agent_id}-custom.yaml` formats

- [x] Task 2: Implement YAML loading (AC: 2)
  - [x] Load and parse YAML customization files
  - [x] Handle YAML parsing errors
  - [x] Validate loaded structure matches schema

- [x] Task 3: Implement persona merge logic (AC: 3)
  - [x] Merge `additional_principles` (append to base)
  - [x] Merge `communication_style` (override base values)
  - [x] Merge `expertise_areas.add` (append to base)
  - [x] Merge `expertise_areas.emphasize` (prioritize in responses)
  - [x] Merge `custom_instructions` (append to base instructions)

- [x] Task 4: Implement command merge logic (AC: 4)
  - [x] Merge `command_overrides.add` (add new commands)
  - [x] Merge `command_overrides.modify` (modify existing commands)
  - [x] Preserve base commands not in override

- [x] Task 5: Implement dependency merge logic (AC: 5)
  - [x] Merge `dependency_overrides.tasks.add` (add tasks)
  - [x] Merge `dependency_overrides.templates.add` (add templates)
  - [x] Merge `dependency_overrides.data.add` (add data files)
  - [x] Preserve base dependencies

- [x] Task 6: Implement error handling (AC: 6, 7, 8)
  - [x] Handle missing customization file (return base config)
  - [x] Handle invalid YAML (log error, return base config)
  - [x] Handle missing referenced files (warn, continue)
  - [x] Handle invalid agent_id (log error, ignore customization)

## Dev Notes

### Existing System Context

- Agent base configuration loading exists in `tapps_agents/core/agent_base.py`
- YAML parsing likely available via existing dependencies
- BMAD merge pattern exists in `.bmad-core/utils/agent-customization-loader.md`

### Integration Approach

- Create `tapps_agents/core/customization_loader.py` module
- Implement merge functions that work with agent config structure
- Follow BMAD merge rules: customizations override defaults, not replace
- Use deep merge for nested structures

### Risk Assessment

- **Primary risk**: Merge logic may incorrectly override base config
  - **Mitigation**: Comprehensive testing of merge scenarios, clear merge rules, validation
- **Primary risk**: Circular dependencies or infinite loops in merge
  - **Mitigation**: Validate merge depth, prevent circular references

### Rollback Plan

- Disable customization loading via feature flag
- Remove customization loader module
- Agents revert to base config only

### Testing

- Unit tests for file discovery (found, not found, case variations)
- Unit tests for YAML loading (valid, invalid, malformed)
- Unit tests for merge logic (persona, commands, dependencies)
- Unit tests for error handling (missing files, invalid YAML, missing references)
- Integration tests with actual agent configs

## Change Log

| Date       | Version | Description                     | Author      |
| ---------- | ------- | ------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 29.2     | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

- `tapps_agents/core/customization_loader.py` - Customization loader with merge logic

## QA Results

_TBD_

