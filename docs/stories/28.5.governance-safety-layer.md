# Story 28.5: Governance & Safety Layer

<!-- Source: docs/prd/epic-2-dynamic-expert-rag-engine.md -->
<!-- Context: Dynamic Expert & RAG Engine - Security & Safety -->

## Status

**In Progress** - Core Implementation Complete

**Last Updated:** 2025-01-XX

**Implementation Notes:**
- Governance & Safety Layer implemented (`tapps_agents/experts/governance.py`)
- Do-not-index filters implemented (secrets, tokens, credentials, PII detection and redaction)
- Prompt-injection handling implemented (treat as untrusted, label sources)
- Retention & scope policies implemented (project-local only, avoid committing runtime state)
- Human approval mode implemented (approval queue system)
- Content filtering with pattern matching implemented
- Knowledge entry validation implemented
- Basic tests created (`tests/unit/test_governance.py`)
- Ready for integration with Knowledge Ingestion Pipeline (Story 28.4)

## Story

**As a** Knowledge Ingestion Pipeline,
**I want** a governance and safety layer that prevents sensitive data from entering the KB,
**so that** secrets, PII, and other sensitive information are protected and the KB remains secure.

## Acceptance Criteria

1. Do-not-index filters implemented (secrets, tokens, credentials, PII)
2. Prompt-injection handling implemented (retrieved text treated as untrusted, labeled with sources)
3. Retention & scope policies created (project-local KB remains local, avoid committing runtime state)
4. Human approval mode implemented (optional: new experts/KB entries require approval before writing)
5. Filters prevent secrets/PII indexing
6. Prompt-injection handled safely
7. Retention policies enforced
8. Approval mode works when enabled

## Tasks / Subtasks

- [ ] Task 1: Design Governance Architecture (AC: 1, 2, 3, 4)
  - [ ] Define governance layer architecture
  - [ ] Design filter system
  - [ ] Design approval workflow
  - [ ] Document governance architecture

- [ ] Task 2: Implement Do-Not-Index Filters (AC: 1, 5)
  - [ ] Create secret detection patterns
  - [ ] Create token detection patterns
  - [ ] Create credential detection patterns
  - [ ] Create PII detection patterns
  - [ ] Implement filter application logic
  - [ ] Add filter configuration
  - [ ] Create filter violation reporting

- [ ] Task 3: Implement Prompt-Injection Handling (AC: 2, 6)
  - [ ] Create prompt-injection detection
  - [ ] Implement untrusted text labeling
  - [ ] Add source labeling for retrieved text
  - [ ] Implement safe text handling
  - [ ] Add prompt-injection prevention

- [ ] Task 4: Implement Retention & Scope Policies (AC: 3, 7)
  - [ ] Create retention policy system
  - [ ] Implement project-local KB enforcement
  - [ ] Add runtime state exclusion
  - [ ] Implement scope validation
  - [ ] Add policy configuration

- [ ] Task 5: Implement Human Approval Mode (AC: 4, 8)
  - [ ] Create approval workflow
  - [ ] Implement approval queue
  - [ ] Add approval notifications
  - [ ] Implement approval/rejection handling
  - [ ] Add approval mode configuration
  - [ ] Create approval UI/CLI interface

- [ ] Task 6: Integration with Ingestion Pipeline (AC: 5, 6, 7, 8)
  - [ ] Integrate filters with ingestion pipeline
  - [ ] Integrate approval mode with expert creation
  - [ ] Integrate approval mode with KB writes
  - [ ] Add governance checks to all write operations

- [ ] Task 7: Testing & Validation (AC: 5, 6, 7, 8)
  - [ ] Unit tests for filter detection
  - [ ] Test prompt-injection handling
  - [ ] Test retention policy enforcement
  - [ ] Test approval mode workflow
  - [ ] Security testing for filter effectiveness

## Dev Notes

**Integration Points:**
- Knowledge ingestion pipeline: Story 28.4 output
- Expert synthesizer: Story 28.3 output
- RAG backends: VectorKnowledgeBase/SimpleKnowledgeBase
- KB storage: `.tapps-agents/knowledge/` directory
- Expert config: `.tapps-agents/experts.yaml`

**Technology Stack:**
- Python 3.13+
- Secret detection libraries (detect-secrets, etc.)
- PII detection libraries
- Pattern matching (regex, etc.)

**Key Constraints:**
- Filters must be comprehensive and accurate
- False positives must be minimized
- Approval mode must be optional and configurable
- Retention policies must be enforceable
- Governance must not significantly impact performance

**Testing Standards:**
- Test file location: `tests/unit/test_governance.py`
- Test filter detection accuracy
- Test prompt-injection handling
- Test retention policy enforcement
- Security testing for filter effectiveness

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | BMad Master |
| 2025-01-XX | 1.1 | Core implementation complete - Governance & Safety Layer with filters, prompt-injection handling, and approval system | BMad Master |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_

