# Story 28.5: Governance & Safety Layer

<!-- Source: docs/prd/epic-2-dynamic-expert-rag-engine.md -->
<!-- Context: Dynamic Expert & RAG Engine - Security & Safety -->

## Status

**âœ… Completed**

**Last Updated:** 2025-01-27

**Implementation Notes:**
- Governance & Safety Layer implemented (`tapps_agents/experts/governance.py`)
- Do-not-index filters implemented (secrets, tokens, credentials, PII detection and redaction)
- Prompt-injection handling implemented (treat as untrusted, label sources)
- Retention & scope policies implemented (project-local only, avoid committing runtime state)
- Human approval mode implemented (approval queue system)
- Content filtering with pattern matching implemented
- Knowledge entry validation implemented
- **INTEGRATED** with Knowledge Ingestion Pipeline (Story 28.4)
- **CLI interface** created for approval queue management (`governance` command)
- **Enhanced tests** added for integration and approval workflow

## Story

**As a** Knowledge Ingestion Pipeline,
**I want** a governance and safety layer that prevents sensitive data from entering the KB,
**so that** secrets, PII, and other sensitive information are protected and the KB remains secure.

## Acceptance Criteria

1. Do-not-index filters implemented (secrets, tokens, credentials, PII)
2. Prompt-injection handling implemented (retrieved text treated as untrusted, labeled with sources)
3. Retention & scope policies created (project-local KB remains local, avoid committing runtime state)
4. Human approval mode implemented (optional: new experts/KB entries require approval before writing)
5. Filters prevent secrets/PII indexing
6. Prompt-injection handled safely
7. Retention policies enforced
8. Approval mode works when enabled

## Tasks / Subtasks

- [x] Task 1: Design Governance Architecture (AC: 1, 2, 3, 4)
  - [x] Define governance layer architecture
  - [x] Design filter system
  - [x] Design approval workflow
  - [x] Document governance architecture

- [x] Task 2: Implement Do-Not-Index Filters (AC: 1, 5)
  - [x] Create secret detection patterns
  - [x] Create token detection patterns
  - [x] Create credential detection patterns
  - [x] Create PII detection patterns
  - [x] Implement filter application logic
  - [x] Add filter configuration
  - [x] Create filter violation reporting

- [x] Task 3: Implement Prompt-Injection Handling (AC: 2, 6)
  - [x] Create prompt-injection detection
  - [x] Implement untrusted text labeling
  - [x] Add source labeling for retrieved text
  - [x] Implement safe text handling
  - [x] Add prompt-injection prevention

- [x] Task 4: Implement Retention & Scope Policies (AC: 3, 7)
  - [x] Create retention policy system
  - [x] Implement project-local KB enforcement
  - [x] Add runtime state exclusion
  - [x] Implement scope validation
  - [x] Add policy configuration

- [x] Task 5: Implement Human Approval Mode (AC: 4, 8)
  - [x] Create approval workflow
  - [x] Implement approval queue
  - [x] Add approval notifications
  - [x] Implement approval/rejection handling
  - [x] Add approval mode configuration
  - [x] Create approval UI/CLI interface

- [x] Task 6: Integration with Ingestion Pipeline (AC: 5, 6, 7, 8)
  - [x] Integrate filters with ingestion pipeline
  - [x] Integrate approval mode with expert creation
  - [x] Integrate approval mode with KB writes
  - [x] Add governance checks to all write operations

- [x] Task 7: Testing & Validation (AC: 5, 6, 7, 8)
  - [x] Unit tests for filter detection
  - [x] Test prompt-injection handling
  - [x] Test retention policy enforcement
  - [x] Test approval mode workflow
  - [x] Security testing for filter effectiveness

## Dev Notes

**Integration Points:**
- Knowledge ingestion pipeline: Story 28.4 output
- Expert synthesizer: Story 28.3 output
- RAG backends: VectorKnowledgeBase/SimpleKnowledgeBase
- KB storage: `.tapps-agents/knowledge/` directory
- Expert config: `.tapps-agents/experts.yaml`

**Technology Stack:**
- Python 3.13+
- Secret detection libraries (detect-secrets, etc.)
- PII detection libraries
- Pattern matching (regex, etc.)

**Key Constraints:**
- Filters must be comprehensive and accurate
- False positives must be minimized
- Approval mode must be optional and configurable
- Retention policies must be enforceable
- Governance must not significantly impact performance

**Testing Standards:**
- Test file location: `tests/unit/test_governance.py`
- Test filter detection accuracy
- Test prompt-injection handling
- Test retention policy enforcement
- Security testing for filter effectiveness

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | BMad Master |
| 2025-01-XX | 1.1 | Core implementation complete - Governance & Safety Layer with filters, prompt-injection handling, and approval system | BMad Master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Completion Notes

- **Core Implementation**: Governance & Safety Layer fully implemented in `tapps_agents/experts/governance.py`
- **Filter System**: Comprehensive pattern matching for secrets, tokens, credentials, and PII with redaction
- **Prompt Injection Handling**: Untrusted content labeling and source verification
- **Retention Policies**: Project-local KB enforcement and runtime state exclusion
- **Approval System**: Queue-based approval workflow with JSON file storage
- **Integration**: Fully integrated with Knowledge Ingestion Pipeline - all entries go through governance checks
- **CLI Interface**: Created `governance` command with subcommands: `list`, `show`, `approve`, `reject`
- **Testing**: Enhanced test suite with integration tests and approval workflow tests
- **All acceptance criteria met**

### File List

- `tapps_agents/experts/governance.py` (existing - enhanced)
- `tapps_agents/experts/knowledge_ingestion.py` (modified - integrated governance layer)
- `tapps_agents/cli/parsers/top_level.py` (modified - added governance parser)
- `tapps_agents/cli/commands/top_level.py` (modified - added handle_governance_command)
- `tapps_agents/cli/main.py` (modified - added routing for governance command)
- `tests/unit/test_governance.py` (modified - enhanced with integration tests)

## QA Results

_To be populated by QA agent_

