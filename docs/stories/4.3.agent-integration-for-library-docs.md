# Story 4.3: Agent Integration for Library Docs

<!-- Source: implementation/cursor/EPIC_04_Context7_Integration.md -->
<!-- Context: Expand Context7 helper usage across all agents with cache-first behavior -->

## Status

Draft

## Story

**As a** user running any TappsCodingAgents agent,
**I want** consistent, cache-first Context7 documentation retrieval across all agents,
**so that** library/framework questions are answered with fast, versioned docs and minimal token usage.

## Acceptance Criteria

1. All agents have access to Context7 KB-first documentation retrieval via `Context7AgentHelper` (or a BaseAgent-provided wrapper) when `context7.enabled` is true.
2. Agents follow a consistent “KB-first” pattern:
   - Prefer `KBLookup` cache results
   - Allow fuzzy match where configured
   - Fall back to MCP Context7 tools when available
3. Integration is safe and optional:
   - If Context7 is disabled, agents behave unchanged.
   - If Context7 is enabled but MCP/credentials are unavailable, agents do not crash and return a clear “Context7 unavailable” signal while continuing work.
4. Agent output that incorporates Context7 docs includes provenance fields returned by `Context7AgentHelper.get_documentation()` (at minimum: `source`, `library`, `topic`, and `response_time_ms`).
5. Unit tests cover at least one additional agent integration beyond the currently wired set (architect/implementer/tester) and ensure no regressions to existing Context7 unit tests.

## Tasks / Subtasks

- [ ] Task 1: Standardize Context7 initialization in agent activation (AC: 1, 3)
  - [ ] Identify current integrations (`tapps_agents/agents/architect/agent.py`, `implementer/agent.py`, `tester/agent.py`)
  - [ ] Choose one integration strategy:
    - [ ] Option A: initialize `self.context7 = get_context7_helper(...)` in `BaseAgent.activate()` for all agents
    - [ ] Option B: add to each missing agent class consistently

- [ ] Task 2: Add a shared helper method for retrieval + heuristics (AC: 2, 4)
  - [ ] Use `tapps_agents/context7/agent_integration.py::Context7AgentHelper.should_use_context7()` to decide when to fetch docs
  - [ ] Provide a small wrapper (e.g., `BaseAgent.maybe_get_library_docs(...)`) that returns a structured dict or None

- [ ] Task 3: Integrate into remaining agents (AC: 1)
  - [ ] Wire Context7 into: analyst, debugger, designer, documenter, enhancer, improver, ops, orchestrator, planner, reviewer

- [ ] Task 4: Add tests (AC: 5)
  - [ ] Extend `tests/unit/context7/test_agent_integration.py` or add agent-specific tests verifying:
    - [ ] Context7 disabled → helper is None / not used
    - [ ] Context7 enabled → helper initializes

## Dev Notes

### Existing System Context

- Cache-first helper already exists:
  - `tapps_agents/context7/agent_integration.py::Context7AgentHelper`
  - `get_context7_helper(...)` returns None when Context7 is disabled.
- KB-first behavior is implemented in `tapps_agents/context7/lookup.py::KBLookup`.
- Current agent integrations are partial:
  - Present: `architect`, `implementer`, `tester` (see `tapps_agents/agents/*/agent.py`).

### Integration Approach

- Prefer a single integration point (BaseAgent) to avoid drift.
- When integrating retrieval into agent outputs, return the same fields that `Context7AgentHelper.get_documentation()` already produces: `content`, `library`, `topic`, `source`, `fuzzy_score`, `matched_topic`, `response_time_ms`.

### Risk Assessment

- **Risk**: adding Context7 wiring across all agents creates subtle side effects during activation.
- **Mitigation**: keep Context7 optional; the helper already no-ops when disabled.

### Rollback Plan

- Revert to the previous subset of agents; Context7 remains available via direct `Context7Commands` usage and via the existing three agents.

### Testing

- Existing unit tests for the helper live in `tests/unit/context7/test_agent_integration.py`.

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 4.3        | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
