# Story 8.1: E2E Suite Layout + Harness Conventions

<!-- Source: implementation/cursor/EPIC_08_E2E_Testing_Foundation.md -->
<!-- Context: Establish E2E testing foundation with directory structure, fixtures, and conventions -->

## Status

Complete

## Story

**As a** QA engineer and developer,
**I want** a well-organized E2E test suite structure with reusable fixtures and clear conventions for project templates, isolation, and artifact capture,
**so that** E2E tests are maintainable, reliable, and produce actionable debug information when they fail.

## Acceptance Criteria

1. A dedicated `tests/e2e/` directory structure exists with subdirectories: `smoke/`, `workflows/`, `scenarios/`, `cli/`, and `fixtures/`.
2. Project template strategy is defined with three tiers: `minimal` (single file), `small` (basic structure with tests), and `medium` (multi-file project with dependencies).
3. Project templates are deterministic and can be created in isolated temporary directories with consistent structure.
4. E2E harness utilities exist for:
   - Creating isolated test project environments (temp directories with project templates)
   - Capturing artifacts (logs, state snapshots, produced files) on test failure
   - Asserting artifact existence and minimal content validation
   - Cleanup utilities that are idempotent and safe
5. Artifact/state/log capture conventions are documented and consistently applied:
   - Correlation IDs for each E2E run
   - State snapshots captured at key points (workflow start, step transitions, failures)
   - Logs captured with structured format
   - Failure bundles include: logs, state snapshots, produced artifacts, step timeline
6. All fixtures and utilities are Windows-compatible (no bash-isms, proper path handling).
7. Unit tests exist for the E2E harness utilities themselves.

## Tasks / Subtasks

- [x] Task 1: Create E2E directory structure (AC: 1)
  - [x] Create `tests/e2e/` directory
  - [x] Create subdirectories: `smoke/`, `workflows/`, `scenarios/`, `cli/`, `fixtures/`
  - [x] Add `__init__.py` files to make them Python packages
  - [x] Create `tests/e2e/fixtures/__init__.py` for shared fixtures

- [x] Task 2: Define and implement project template strategy (AC: 2, 3)
  - [x] Design minimal template (single Python file, basic structure)
  - [x] Design small template (multiple files, basic test structure, minimal dependencies)
  - [x] Design medium template (multi-file project, tests, dependencies, config files)
  - [x] Implement template creation utilities in `tests/e2e/fixtures/project_templates.py`
  - [x] Ensure templates are deterministic (fixed content, seeded randomness if needed)

- [x] Task 3: Implement E2E harness utilities (AC: 4, 6)
  - [x] Create `tests/e2e/fixtures/e2e_harness.py` with:
    - [x] `create_test_project(template_type, tmp_path)` - creates isolated project
    - [x] `capture_artifacts(project_path, test_name)` - captures logs/state/files
    - [x] `assert_artifact_exists(project_path, artifact_path)` - artifact assertions
    - [x] `cleanup_project(project_path)` - idempotent cleanup
  - [x] Ensure Windows-compatible path handling (use `pathlib.Path`, no shell commands)
  - [x] Add timeout utilities for test/step timeouts

- [x] Task 4: Implement artifact capture and assertion utilities (AC: 5)
  - [x] Create correlation ID generator for each E2E run
  - [x] Implement state snapshot capture (workflow state, step state)
  - [x] Implement log capture with structured format
  - [x] Create failure bundle assembler (logs + state + artifacts + timeline)
  - [x] Add utilities to redact secrets from captured artifacts

- [x] Task 5: Create shared E2E fixtures in conftest.py (AC: 4)
  - [x] Add `e2e_project` fixture that creates isolated test project
  - [x] Add `e2e_correlation_id` fixture for test correlation
  - [x] Add `e2e_artifact_capture` fixture for automatic artifact capture on failure
  - [x] Add `e2e_cleanup` fixture for automatic cleanup

- [x] Task 6: Documentation and tests (AC: 7)
  - [x] Document E2E conventions in `tests/e2e/README.md`
  - [x] Document project template structure and usage
  - [x] Document artifact capture conventions
  - [x] Add unit tests for harness utilities in `tests/unit/e2e/test_e2e_harness.py`

## Dev Notes

### Existing System Context

- Current test structure:
  - `tests/unit/` - unit tests (fast, isolated)
  - `tests/integration/` - integration tests (some E2E-like tests exist here, e.g. `test_e2e_workflow_real.py`)
  - `tests/conftest.py` - shared fixtures (mock_mal, temp_project_dir, etc.)
- Existing fixtures in `tests/conftest.py`:
  - `temp_project_dir` - creates `.tapps-agents` structure
  - `mock_mal` - mock LLM for testing
  - `project_root_path` - project root directory
- Workflow system:
  - Workflows defined in YAML under `workflows/`
  - Workflow state persisted to `.tapps-agents/workflow-state/`
  - Artifacts created under `.tapps-agents/` and project root
- Test markers in `pytest.ini`:
  - `unit`, `integration`, `e2e`, `slow`
  - `requires_llm`, `requires_context7`, `requires_ollama`

### Integration Approach

- Build on existing `tests/conftest.py` fixtures; extend rather than replace
- Reuse `temp_project_dir` pattern but enhance for E2E-specific needs
- Integrate with existing workflow state persistence paths
- Follow existing pytest patterns (async fixtures, markers)

### Technology Research

- Use `pytest` fixtures and `tmp_path` for isolation
- Use `pathlib.Path` for cross-platform path handling
- Use `pytest-timeout` for explicit timeouts (already in use)
- Consider `pytest-xdist` for parallel execution (already documented)
- Use structured logging (Python `logging` module) for correlation IDs

### Risk Assessment

- **Primary risk**: E2E fixtures become complex and hard to maintain
- **Mitigation**: Keep fixtures focused and well-documented; provide clear examples
- **Rollback plan**: E2E suite is additive; can be removed without affecting unit/integration tests

### Testing

- Test file location: `tests/unit/e2e/test_e2e_harness.py`
- Test standards: Use `pytest`, follow existing unit test patterns
- Testing frameworks: `pytest`, `pytest-asyncio` for async fixtures
- Specific requirements:
  - Test project template creation (all three tiers)
  - Test artifact capture and assertion utilities
  - Test cleanup idempotency
  - Test Windows path handling
  - Test correlation ID generation

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 8.1        | bmad-master |

## Dev Agent Record

### Agent Model Used

Auto (Cursor AI)

### Debug Log References

N/A - Implementation completed successfully

### Completion Notes List

- All directory structures created: `tests/e2e/` with subdirectories `smoke/`, `workflows/`, `scenarios/`, `cli/`, `fixtures/`
- Project templates implemented in `tests/e2e/fixtures/project_templates.py` with three tiers (minimal, small, medium)
- E2E harness utilities implemented in `tests/e2e/fixtures/e2e_harness.py` with full artifact capture, correlation IDs, and secret redaction
- Shared fixtures created in `tests/e2e/conftest.py` (e2e_project, e2e_correlation_id, e2e_artifact_capture)
- Comprehensive documentation created in `tests/e2e/README.md`
- Unit tests for harness utilities created in `tests/unit/e2e/test_e2e_harness.py`
- All utilities are Windows-compatible using `pathlib.Path`

### File List

- `tests/e2e/__init__.py`
- `tests/e2e/conftest.py`
- `tests/e2e/README.md`
- `tests/e2e/smoke/__init__.py`
- `tests/e2e/workflows/__init__.py`
- `tests/e2e/scenarios/__init__.py`
- `tests/e2e/cli/__init__.py`
- `tests/e2e/fixtures/__init__.py`
- `tests/e2e/fixtures/project_templates.py`
- `tests/e2e/fixtures/e2e_harness.py`
- `tests/unit/e2e/test_e2e_harness.py`

## QA Results

âœ… All acceptance criteria met. All tasks completed. E2E harness is fully functional and tested.
