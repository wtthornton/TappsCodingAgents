# Story 22.3: Centralize Agent Lifecycle and Async Runner Pattern

<!-- Source: implementation/cursor/EPIC_22_CLI_Reliability_And_Entrypoint_Parity.md -->
<!-- Context: Reduce duplicated agent activate/run/close logic and eliminate repeated asyncio.run patterns while preserving CLI surface -->

## Status

Draft

## Story

**As a** maintainer,
**I want** a shared agent lifecycle runner and a single event-loop boundary for CLI execution,
**so that** the CLI is more reliable (no nested loops), easier to extend, and avoids duplicated logic across commands.

## Acceptance Criteria

1. Agent `activate/run/close` flows are centralized and reused across CLI commands.
2. The CLI has a **single async boundary** (a single `asyncio.run(...)` at the top-level) and does not repeatedly create/tear down event loops per subcommand.
3. Behavior is preserved:
   - command names/aliases unchanged,
   - output remains compatible,
   - side effects unchanged.
4. CLI module complexity is reduced (fewer duplicated blocks for reviewer/planner/etc. command execution).
5. Parity is maintained across entrypoints (shared runner used by both console script and module invocation).

## Tasks / Subtasks

- [ ] Task 1: Identify duplicated patterns and group by command family (AC: 1, 4)
  - [ ] Audit `tapps_agents/cli.py` for repeated `ReviewerAgent()` / `asyncio.run(...)` blocks
  - [ ] Identify other agents with similar patterns (planner, implementer, etc.)

- [ ] Task 2: Introduce a shared lifecycle runner (AC: 1, 2)
  - [ ] Create a helper that:
    - constructs agent
    - activates
    - runs a command with args
    - closes reliably (even on error)
  - [ ] Ensure runner returns a standardized result (ties into Story 22.2)

- [ ] Task 3: Move command dispatch to a single async function (AC: 2)
  - [ ] Parse args in `main()` (sync)
  - [ ] Dispatch execution via `asyncio.run(run_cli_async(args))`
  - [ ] Remove per-branch `asyncio.run(...)` calls

- [ ] Task 4: Refactor command handlers to use the shared runner (AC: 1, 3, 4)
  - [ ] Convert reviewer command handling first (largest surface)
  - [ ] Convert remaining agent command families
  - [ ] Keep output format selection consistent

- [ ] Task 5: Regression tests and smoke checks (AC: 3, 5)
  - [ ] Run existing CLI tests; add/extend tests if needed to cover refactored paths

## Dev Notes

### Existing System Context

- `tapps_agents/cli.py` currently mixes:
  - async command functions that call `sys.exit(...)`, and
  - large synchronous dispatch blocks that repeatedly call `asyncio.run(...)`.
- This creates multiple event-loop boundaries and duplicated agent lifecycle code.

### Integration Approach

- Prefer a “thin sync main + async runner” design:
  - `main()` parses args and calls `asyncio.run(run_cli_async(parsed_args))`
  - `run_cli_async` performs startup (Story 22.1), dispatch, and returns a standardized result (Story 22.2)

### Risk Assessment

- **Primary risk**: refactor accidentally changes output timing/order or error handling.
- **Mitigation**: lock behavior via CLI contract tests (Story 22.4) and keep output schema backward compatible.

### Testing

- Leverage E2E CLI tests and add targeted unit tests for the runner helper.

## Change Log

| Date       | Version | Description                                   | Author      |
| ---------- | ------- | --------------------------------------------- | ----------- |
| 2025-12-16 | 0.1     | Initial draft for Epic 22.3                   | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_


