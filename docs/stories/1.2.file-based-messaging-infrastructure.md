# Story 1.2: File-Based Messaging Infrastructure

<!-- Source: implementation/cursor/EPIC_01_Foundation.md -->
<!-- Context: Brownfield addition to support multi-agent coordination -->

## Status

Draft

## Story

**As a** workflow orchestrator,
**I want** a file-based inbox/outbox messaging mechanism with versioned, validated message contracts,
**so that** agents can coordinate asynchronously and reliably without requiring external queue infrastructure.

## Acceptance Criteria

1. A message directory layout exists under `.tapps-agents/` (e.g., `.tapps-agents/messages/{inbox,outbox,dlq,locks}/`).
2. Task assignment, status update, and completion messages are persisted as JSON with a **schema_version** and required identifiers (at minimum: `workflow_id`, `task_id`, `agent_id`, `message_id`, `created_at`).
3. Message writes are atomic (write-then-rename) and safe under concurrent producers.
4. Consumers are idempotent: reprocessing the same `message_id` does not duplicate side effects.
5. Invalid/unprocessable messages are quarantined to a DLQ directory with a human-readable reason, and there is a minimal replay tool/process.
6. This system works on Windows and POSIX filesystems.

## Tasks / Subtasks

- [ ] Task 1: Define message directory structure + naming conventions (AC: 1, 6)
  - [ ] Choose safe filenames (no colons; avoid long path issues on Windows)
  - [ ] Define per-agent inbox paths and how orchestrator finds them

- [ ] Task 2: Define message contracts (AC: 2)
  - [ ] Create JSON schemas/typed models for: task assignment, status, completion
  - [ ] Ensure schema versioning strategy is explicit (e.g., `1.0`)

- [ ] Task 3: Implement atomic producer utilities (AC: 3)
  - [ ] Implement safe write helper (temp file + atomic rename)
  - [ ] Add optional fsync for durability on critical messages

- [ ] Task 4: Implement consumer utilities (AC: 4, 5)
  - [ ] Implement polling + lock behavior to prevent double-consumption
  - [ ] Record processed message IDs (per workflow/task) to ensure idempotency
  - [ ] Implement DLQ/quarantine move with reason metadata

- [ ] Task 5: Tests (AC: 3, 4, 6)
  - [ ] Concurrency tests (multiple writers)
  - [ ] Idempotency tests (same message twice)
  - [ ] DLQ tests (invalid JSON / invalid schema)

## Dev Notes

### Existing System Context

- Workflow state is already persisted under `.tapps-agents/workflow-state/` via `tapps_agents/workflow/state_manager.py`.
- Cursor-mode workflow execution already polls for step completion artifacts in `tapps_agents/workflow/cursor_executor.py`.

### Integration Approach

- Treat messaging as a coordination layer that complements (not replaces) existing workflow-state persistence.
- Prefer writing a small, dependency-light messaging module under `tapps_agents/workflow/` or `tapps_agents/core/`.

### Technology Research

- BMAD guidance calls for Context7 KB-first lookups when selecting external libraries; however, Context7 MCP auth must be working for that.

### Risk Assessment

- **Primary risk**: file-based queue edge cases (partial writes, races, unbounded growth)
- **Mitigation**: atomic writes, locks, idempotency keys, DLQ + replay, and cleanup/retention policies.

### Rollback Plan

- Disable messaging feature flag / stop producing messages; remove `.tapps-agents/messages/` directory.

### Testing

- Use `pytest` under `tests/`.
- Prefer `tmp_path` filesystem-based tests.

## Change Log

| Date       | Version | Description                | Author      |
| ---------- | ------- | -------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 1.2 | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
