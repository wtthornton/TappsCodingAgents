# Story 22.2: Standardize CLI Exit Codes and Error Output

<!-- Source: implementation/cursor/EPIC_22_CLI_Reliability_And_Entrypoint_Parity.md -->
<!-- Context: Ensure all CLI commands use consistent exit codes and a stable error envelope for JSON/text output -->

## Status

Draft

## Story

**As a** CLI user (and CI/script author),
**I want** consistent exit codes and a stable, structured error contract,
**so that** automation can reliably detect failures and humans get actionable error messages.

## Acceptance Criteria

1. All commands return **exit code 0** on success and **non-zero** on failure.
2. JSON output has a stable envelope:
   - Always includes `success: true|false`.
   - On failure includes a structured error payload (e.g., `error: { code, message, details? }`).
   - Backward compatibility is maintained (existing JSON fields preserved; additive fields allowed).
3. Text output remains readable and includes next steps (e.g., “run with --help”, “check config”, “file not found”).
4. `sys.exit(...)` usage is confined to the **top-level entrypoint**; deeper handlers return values/errors instead of terminating the process.
5. Common failure modes map to consistent exit codes (at minimum: general failure; usage/validation failure; file-not-found).
6. Contract tests cover exit codes + output envelope for representative commands and failure paths.

## Tasks / Subtasks

- [ ] Task 1: Inventory existing exit/print patterns (AC: 1, 4)
  - [ ] Identify all `sys.exit(...)` usage in `tapps_agents/cli.py` and related helpers
  - [ ] Identify commands that print errors to stderr without structured output

- [ ] Task 2: Define the CLI error/exit contract (AC: 1, 2, 5)
  - [ ] Define exit code mapping (documented)
  - [ ] Define JSON envelope shape and required keys
  - [ ] Define minimum error fields (`code`, `message`) and optional `details`

- [ ] Task 3: Implement centralized result/exit handling (AC: 1–4)
  - [ ] Refactor command handlers to return a standardized result object
  - [ ] Ensure `main()` (or the entry wrapper) is responsible for:
    - selecting output format
    - writing stdout/stderr
    - returning the proper exit code

- [ ] Task 4: Add contract tests (AC: 6)
  - [ ] Add subprocess-based tests validating exit code behavior (success vs failure)
  - [ ] Validate JSON envelope keys for failure cases
  - [ ] Validate text output includes actionable guidance

## Dev Notes

### Existing System Context

- `tapps_agents/cli.py` currently calls `sys.exit(1)` inside command handlers (including async ones), which makes behavior hard to centralize and test.
- Multiple commands print ad-hoc error messages and then exit.

### Integration Approach

- Introduce a small “CLI result” abstraction (even a dict) that can represent:
  - success/failure
  - payload
  - error info
  - desired exit code
- Convert handlers to return results; keep `sys.exit()` at the very top.

### Risk Assessment

- **Primary risk**: subtle output changes break dependent scripts.
- **Mitigation**: keep existing JSON fields; add envelope fields additively; lock behavior via contract tests.

### Testing

- Use existing E2E CLI harness patterns to validate exit codes and output contracts.

## Change Log

| Date       | Version | Description                                   | Author      |
| ---------- | ------- | --------------------------------------------- | ----------- |
| 2025-12-16 | 0.1     | Initial draft for Epic 22.2                   | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_


