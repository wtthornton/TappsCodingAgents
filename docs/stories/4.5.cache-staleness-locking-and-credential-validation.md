# Story 4.5: Cache Staleness Policies, Locking, and Credential Validation

<!-- Source: implementation/cursor/EPIC_04_Context7_Integration.md -->
<!-- Context: Hardening Context7 cache under concurrency + fail-fast credential checks -->

## Status

Draft

## Story

**As a** system that runs multiple agents in parallel,
**I want** safe staleness/refresh behavior, concurrency-safe cache writes, and clear Context7 credential validation,
**so that** the Context7 KB cache remains correct and agents degrade gracefully when Context7 is unavailable.

## Acceptance Criteria

1. Staleness policy behavior is configurable via `Context7RefreshConfig` and applied consistently when determining refresh work:
   - Default max age days is configurable
   - Library type policies (stable/active/critical) remain supported
2. Cache write operations are concurrency-safe (best-effort) for:
   - library docs `*.md`
   - `index.yaml`
   - per-library `meta.yaml`
   - `.metrics.yaml`
   - refresh queue file
   using atomic write + replace semantics and lightweight locking to avoid corruption under parallel agents.
3. Cache stampede protection exists for “same library/topic” concurrent refresh attempts (avoid multiple simultaneous API fetches writing the same file).
4. Credential validation is explicit and actionable:
   - When Context7 is enabled but `CONTEXT7_API_KEY` (or equivalent credential path) is missing/invalid, the system surfaces a clear error message with remediation steps.
   - CI and local developer workflows can detect missing credentials early without breaking non-Context7 flows.
5. Tests cover:
   - staleness policy config behavior (unit)
   - refresh queue behavior (unit)
   - “Context7 disabled / missing credentials” paths are handled without crashes (unit)
   - real API validation remains opt-in via existing marked integration tests.

## Tasks / Subtasks

- [ ] Task 1: Align staleness config → policy manager (AC: 1)
  - [ ] Ensure `Context7RefreshConfig.default_max_age_days` drives `StalenessPolicyManager(default_max_age_days=...)`
  - [ ] Ensure staleness checks are applied consistently where refresh work is queued/processed

- [ ] Task 2: Add atomic write helpers for cache artifacts (AC: 2)
  - [ ] Implement an atomic “write temp then `os.replace`” helper for text/YAML/JSON writes
  - [ ] Apply to `KBCache.store` (docs), `MetadataManager.save_cache_index`, `MetadataManager.save_library_metadata`, `Analytics._save_metrics`, and `RefreshQueue._save_queue`

- [ ] Task 3: Add locking/stampede protection (AC: 2–3)
  - [ ] Implement a lockfile strategy scoped per library/topic (e.g., `.locks/{library}/{topic}.lock`) to ensure only one refresher writes at a time
  - [ ] Ensure lock acquisition is bounded (timeout) and failure degrades to “skip refresh” rather than deadlock

- [ ] Task 4: Add credential validation and actionable errors (AC: 4)
  - [ ] Use `tapps_agents/context7/security.py::APIKeyManager` and/or environment variables per `docs/CONTEXT7_API_KEY_MANAGEMENT.md`
  - [ ] Add a validation path in `Context7Commands` / `Context7AgentHelper` (and/or doctor/startup checks) that:
    - [ ] detects missing key
    - [ ] detects auth failures (e.g., Unauthorized) and reports “invalid key”
    - [ ] provides next-step instructions

- [ ] Task 5: Add tests (AC: 5)
  - [ ] Extend `tests/unit/context7/test_staleness_policies.py` for config-driven defaults
  - [ ] Add targeted unit tests for atomic write behavior (simulate partial writes and ensure readers don’t crash)
  - [ ] Extend tests for disabled/missing credentials behavior (keep real API tests under `tests/integration/test_context7_real.py`)

## Dev Notes

### Existing System Context

- Staleness policies exist:
  - `tapps_agents/context7/staleness_policies.py::StalenessPolicyManager` supports stable/active/critical and default max age.
- Refresh queue exists and persists to disk:
  - `tapps_agents/context7/refresh_queue.py::RefreshQueue` writes a YAML/JSON file and prioritizes tasks.
- Cache storage exists but writes are not explicitly atomic/locked:
  - `tapps_agents/context7/kb_cache.py::KBCache.store` writes docs via `Path.write_text(...)`.
  - `tapps_agents/context7/metadata.py` and `analytics.py` write YAML files via direct open/write.
- Credential management tooling exists:
  - `tapps_agents/context7/security.py::APIKeyManager` supports encrypted key storage and env-var workflows.
  - Docs exist: `docs/CONTEXT7_API_KEY_MANAGEMENT.md` and `docs/CONTEXT7_SECURITY_PRIVACY.md`.
- Opt-in real API tests already exist:
  - `tests/integration/test_context7_real.py` is marked and checks `CONTEXT7_API_KEY`.

### Integration Approach

- Implement atomic writes using standard-library primitives (`os.replace`) to avoid adding new dependencies.
- Implement lock files in the cache root (or a `.locks/` folder under it) to coordinate parallel agents.
- Keep validation logic close to where Context7 is actually invoked (`KBLookup` via MCP gateway) and ensure “Context7 unavailable” is always a recoverable state.

### Risk Assessment

- **Risk**: locking mistakes can deadlock or slow down hot paths.
- **Mitigation**: bounded lock acquisition, clear timeouts, and best-effort behavior.

### Rollback Plan

- Disable auto-refresh and locking (config) and rely on cache reads only; keep the existing direct-write behavior as a fallback.

### Testing

- Unit tests exist for policies and queues:
  - `tests/unit/context7/test_staleness_policies.py`
  - `tests/unit/context7/test_refresh_queue.py`
- Real API tests are opt-in:
  - `tests/integration/test_context7_real.py`

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 4.5        | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
