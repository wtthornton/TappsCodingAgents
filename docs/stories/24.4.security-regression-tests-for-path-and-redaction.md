# Story 24.4: Security Regression Tests (Path Safety + Redaction)

<!-- Source: implementation/cursor/EPIC_24_Security_Policy_Reality_And_Path_Enforcement.md -->
<!-- Context: Add tests to prevent regressions in path traversal prevention and CI artifact redaction -->

## Status

**Deferred** - Security testing maintenance, lower priority

## Story

**As a** maintainer and security reviewer,  
**I want** regression tests covering path traversal/out-of-bounds access and redaction behavior,  
**so that** security-critical guarantees remain enforced over time and changes can’t silently weaken protections.

## Acceptance Criteria

1. Tests cover traversal attempts (e.g., `..`, encoded variants) and absolute path escapes across supported platforms.
2. Tests cover symlink edge cases where supported by the OS/filesystem and test environment.
3. Tests confirm worktree/state/artifact paths cannot escape `.tapps-agents/` when hostile input is provided.
4. Tests confirm redaction occurs before uploading/packaging CI artifacts when applicable (consistent with existing CI safety controls).

## Tasks / Subtasks

- [ ] Task 1: Add path safety unit tests for centralized validation (AC: 1–3)
  - [ ] Create/extend unit tests for “within allowed roots” behavior
  - [ ] Add coverage for:
    - [ ] `..` traversal components
    - [ ] absolute paths (Windows + POSIX forms)
    - [ ] encoded/odd path inputs where the system accepts them
  - [ ] Add symlink tests guarded by platform capability

- [ ] Task 2: Add `.tapps-agents/` containment tests (AC: 3)
  - [ ] Ensure state/worktree/report path builders reject escapes
  - [ ] Cover representative hostile inputs used by those code paths

- [ ] Task 3: Add/extend CI artifact redaction tests (AC: 4)
  - [ ] Identify the redaction path used for CI failure bundles/artifacts
  - [ ] Add tests asserting sensitive values are scrubbed before artifact generation
  - [ ] Ensure tests align with `tests/e2e/fixtures/ci_safety.py` behavior and expectations

## Dev Notes

### Existing System Context

- CI safety controls exist for real-service tests in `tests/e2e/fixtures/ci_safety.py`.
- Path validation exists in `tapps_agents/core/agent_base.py` and agent-specific checks (to be centralized in Story 24.3).

### Integration Approach

- Tests should fail deterministically and not rely on external services.
- Use platform guards for symlink tests and Windows path variants where necessary.

### Risk Assessment

- **Risk**: Flaky tests across OS/filesystems (especially symlinks on Windows).
- **Mitigation**: Guard symlink tests behind capability checks and keep core traversal tests symlink-free.

### Rollback Plan

- If symlink tests are unstable, keep core traversal tests and disable symlink-specific tests behind markers/capability checks.

### Testing

- Run unit tests on Windows + Linux in CI matrix where available.

## Change Log

| Date       | Version | Description                     | Author      |
| ---------- | ------- | ------------------------------- | ----------- |
| 2025-12-16 | 0.1     | Initial draft for Epic 24.4     | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_


