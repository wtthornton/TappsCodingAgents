# Story 15.5: Agent Behavior in Workflow Context

<!-- Source: implementation/cursor/EPIC_15_E2E_Agent_Behavior_Testing.md -->
<!-- Context: Add E2E tests that validate agent behavior during workflow execution -->

## Status

Complete

## Story

**As a** QA engineer and developer,
**I want** comprehensive E2E tests that validate agent behavior during actual workflow execution,
**so that** I can ensure agents correctly receive context from workflows, produce expected artifacts, handle workflow-specific errors, and integrate properly with workflow state.

## Acceptance Criteria

1. E2E tests exist in `tests/e2e/workflows/test_agent_behavior_in_workflows.py` that validate agent behavior during workflow execution.
2. Tests validate that agents receive correct context from workflow:
   - Agents receive project context (files, structure, configuration)
   - Agents receive workflow state (previous steps, artifacts, decisions)
   - Agents receive step-specific context (parameters, inputs, requirements)
   - Context is correctly passed to agent execution
3. Tests validate that agents produce artifacts that workflow expects:
   - Agents produce artifacts in expected locations
   - Artifacts match expected structure and content
   - Artifacts are properly registered in workflow state
   - Artifacts are accessible to subsequent workflow steps
4. Tests validate that agents handle workflow-specific errors:
   - Agents handle missing workflow context gracefully
   - Agents handle invalid workflow state gracefully
   - Agents handle workflow step failures gracefully
   - Error messages are workflow-aware and actionable
5. Tests validate that agents integrate correctly with workflow state:
   - Agents read workflow state correctly
   - Agents update workflow state correctly
   - Agents maintain state consistency during execution
   - Agents handle concurrent workflow execution (if applicable)
6. Tests extend existing workflow E2E tests to include agent behavior validation:
   - Extend workflow runner tests from Epic 9 to validate agent behavior
   - Add agent behavior assertions to workflow execution tests
   - Integrate with workflow state capture to validate agent state interactions
7. Tests use behavioral mocks that simulate realistic agent behavior in workflow context:
   - Mocks simulate agents receiving and using workflow context
   - Mocks simulate agents producing workflow artifacts
   - Mocks simulate agents interacting with workflow state
8. Tests validate agent behavior across different workflow scenarios:
   - Simple workflows (single agent, single step)
   - Multi-step workflows (multiple agents, sequential steps)
   - Complex workflows (parallel agents, conditional routing, gates)
   - Workflow failure scenarios (agent errors, step failures)
9. All tests pass consistently and are Windows-compatible.

## Tasks / Subtasks

- [x] Task 1: Extend workflow runner with agent behavior validation (AC: 6)
  - [x] Extend `tests/e2e/fixtures/workflow_runner.py` (from Epic 9)
  - [x] Add `validate_agent_context(agent, workflow_state, step_context)` helper
  - [x] Add `validate_agent_artifacts(artifacts, expected_artifacts)` helper
  - [x] Add `validate_agent_workflow_state_interaction(agent, workflow_state)` helper
  - [x] Integrate agent behavior validation into workflow execution

- [x] Task 2: Implement context validation tests (AC: 2)
  - [x] Create `tests/e2e/workflows/test_agent_behavior_in_workflows.py`
  - [x] Test agents receive project context
  - [x] Test agents receive workflow state
  - [x] Test agents receive step-specific context
  - [x] Test context is correctly passed to agent execution
  - [x] Test for various workflow scenarios

- [x] Task 3: Implement artifact validation tests (AC: 3)
  - [x] Test agents produce artifacts in expected locations
  - [x] Test artifacts match expected structure and content
  - [x] Test artifacts are registered in workflow state
  - [x] Test artifacts are accessible to subsequent steps
  - [x] Test for various workflow scenarios

- [x] Task 4: Implement workflow-specific error handling tests (AC: 4)
  - [x] Test agents handle missing workflow context
  - [x] Test agents handle invalid workflow state
  - [x] Test agents handle workflow step failures
  - [x] Test error messages are workflow-aware
  - [x] Test for various workflow scenarios

- [x] Task 5: Implement workflow state integration tests (AC: 5)
  - [x] Test agents read workflow state correctly
  - [x] Test agents update workflow state correctly
  - [x] Test agents maintain state consistency
  - [x] Test agents handle concurrent execution (if applicable)
  - [x] Test for various workflow scenarios

- [x] Task 6: Extend existing workflow tests (AC: 6)
  - [x] Extend workflow runner tests from Epic 9
  - [x] Add agent behavior assertions to workflow execution tests
  - [x] Integrate with workflow state capture
  - [x] Validate agent behavior in existing workflow test scenarios

- [x] Task 7: Create workflow-aware behavioral mocks (AC: 7)
  - [x] Create mocks that simulate agents receiving workflow context
  - [x] Create mocks that simulate agents producing workflow artifacts
  - [x] Create mocks that simulate agents interacting with workflow state
  - [x] Ensure mocks simulate realistic workflow-aware agent behavior

- [x] Task 8: Implement scenario-based workflow agent tests (AC: 8)
  - [x] Test simple workflows (single agent, single step)
  - [x] Test multi-step workflows (multiple agents, sequential steps)
  - [x] Test complex workflows (parallel agents, conditional routing, gates)
  - [x] Test workflow failure scenarios
  - [x] Validate agent behavior across all scenarios

- [x] Task 9: Documentation and test execution (AC: 9)
  - [x] Document workflow agent behavior test patterns in `tests/e2e/workflows/README.md`
  - [x] Ensure all tests are Windows-compatible
  - [x] Verify tests pass consistently
  - [x] Add test markers appropriately (`@pytest.mark.e2e`)

## Dev Notes

### Existing System Context

- Workflow system (from Epic 5, Epic 9):
  - `tapps_agents/workflow/executor.py` - `WorkflowExecutor` class
  - `tapps_agents/workflow/parser.py` - workflow YAML parsing
  - `tapps_agents/workflow/models.py` - workflow models (Workflow, WorkflowState, WorkflowStep, Artifact)
  - `tapps_agents/workflow/state_manager.py` - state persistence
- Workflow E2E foundation (from Epic 9):
  - `tests/e2e/fixtures/workflow_runner.py` - workflow runner harness
  - `tests/e2e/conftest.py` - workflow fixtures
  - Existing workflow E2E tests in `tests/e2e/workflows/`
- Agent implementations:
  - `tapps_agents/agents/planner/agent.py` - Planner agent
  - `tapps_agents/agents/implementer/agent.py` - Implementer agent
  - `tapps_agents/agents/reviewer/agent.py` - Reviewer agent
  - `tapps_agents/agents/tester/agent.py` - Tester agent (if exists)
- E2E foundation (from Epic 8):
  - `tests/e2e/fixtures/e2e_harness.py` - E2E harness utilities
  - `tests/e2e/fixtures/project_templates.py` - project templates

### Integration Approach

- Build on workflow runner from Epic 9
- Extend workflow runner with agent behavior validation
- Integrate with workflow state capture to validate agent state interactions
- Use E2E harness utilities from Epic 8 for project setup
- Follow existing workflow E2E test patterns
- Create reusable test helpers for workflow agent validation

### Technology Research

- Use `pytest` with `pytest-asyncio` for async workflow execution
- Use `unittest.mock` for creating workflow-aware behavioral mocks
- Use workflow runner utilities from Epic 9
- Use workflow state capture utilities from Epic 9
- Use `pytest.mark.parametrize` for testing multiple workflow scenarios
- Reference `pytest` documentation for test organization patterns

### Risk Assessment

- **Primary risk**: Workflow agent behavior tests may be complex and brittle
- **Mitigation**: Test agent behavior contracts (context reception, artifact production, state interaction), not implementation details
- **Rollback plan**: Workflow agent behavior tests are additive; can be disabled via markers if needed

### Testing

- Test file location: `tests/e2e/workflows/test_agent_behavior_in_workflows.py`
- Test standards: Use `pytest`, follow existing workflow E2E test patterns
- Testing frameworks: `pytest`, `pytest-asyncio` for async tests
- Specific requirements:
  - Test agent behavior in workflow context
  - Test various workflow scenarios (simple, multi-step, complex, failure)
  - Use behavioral mocks that simulate workflow-aware agent behavior
  - Integrate with workflow runner and state capture from Epic 9
  - Windows-compatible (use `pathlib.Path`, no shell commands)

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 15.5      | bmad-master |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_

