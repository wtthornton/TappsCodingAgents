# Story 6.3: Coverage Analysis & Reporting

<!-- Source: implementation/cursor/EPIC_06_Quality_Testing.md -->
<!-- Context: Coverage calculation, reporting, and pragmatic enforcement -->

## Status

Draft

## Story

**As a** developer and quality pipeline,
**I want** reliable line/branch coverage analysis with actionable reports and pragmatic thresholds,
**so that** coverage improves incrementally without blocking all work.

## Acceptance Criteria

1. Coverage reporting supports at least:
   - overall project coverage
   - per-file coverage for targeted files
   - (where supported) branch coverage
2. Tester test runs produce machine-readable coverage artifacts consistently (e.g., `coverage.json`, optionally `coverage.xml`).
3. The scoring system’s coverage metric uses real coverage artifacts when available and clearly indicates the source (artifact vs heuristic).
4. Coverage thresholds are enforceable in a pragmatic way:
   - enforce on changed files/modules first (configurable)
   - allow baseline projects to gradually improve without “big bang” requirements
5. Reports are generated in at least one human-friendly format (markdown) and one machine-friendly format (json).
6. Tests validate:
   - coverage artifact parsing behavior
   - threshold evaluation logic

## Tasks / Subtasks

- [ ] Task 1: Normalize coverage artifact generation (AC: 2)
  - [ ] Ensure `TesterAgent._run_pytest()` produces `coverage.json` in a predictable location
  - [ ] Optionally emit `coverage.xml` if needed for interoperability

- [ ] Task 2: Implement robust coverage parsing (AC: 1, 3)
  - [ ] Add a small coverage parsing module that can read `coverage.json` and/or `coverage.xml`
  - [ ] Provide per-file and total coverage extraction

- [ ] Task 3: Coverage threshold evaluation (AC: 4)
  - [ ] Add configurable policy for “changed files first” enforcement
  - [ ] Add override mechanism (warn vs fail) for urgent paths

- [ ] Task 4: Reporting outputs (AC: 5)
  - [ ] Generate JSON + markdown coverage reports

- [ ] Task 5: Tests (AC: 6)
  - [ ] Add unit tests for parsing `coverage.json` and threshold evaluation

## Dev Notes

### Existing System Context

- `TesterAgent._run_pytest()` already uses pytest-cov flags and attempts to read `coverage.json`.
- `CodeScorer._calculate_test_coverage()` currently prefers `coverage.xml` or `.coverage` and otherwise falls back to heuristics.
- There is existing integration test coverage for the tester agent:
  - `tests/integration/test_tester_agent.py` creates a `coverage.json` stub and exercises the run path.

### Integration Approach

- Make `coverage.json` the primary artifact for internal use (since the tester agent already emits it), and treat `coverage.xml` as optional.
- Align the reviewer coverage metric with the tester artifact to avoid mismatches.

### Risk Assessment

- **Risk**: Coverage artifacts differ across environments/pytest-cov versions.
- **Mitigation**: Support tolerant parsing, and fall back to heuristics with explicit “source=heuristic”.

### Rollback Plan

- Keep heuristic coverage scoring if artifact parsing is unreliable, but preserve tester artifact generation.

### Testing

- Use `pytest`.
- Add/extend tests around coverage parsing and threshold evaluation.

## Change Log

| Date       | Version | Description                | Author      |
| ---------- | ------- | -------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 6.3 | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
