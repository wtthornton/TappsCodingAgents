# Story 5.1: YAML Workflow Parser & Validator

<!-- Source: implementation/cursor/EPIC_05_Workflow_Engine.md -->
<!-- Context: Schema-first YAML workflows with strong validation + clear errors -->

## Status

Draft

## Story

**As a** workflow author,
**I want** YAML workflows to be parsed and validated against a versioned schema with clear, actionable errors,
**so that** invalid workflows fail fast and dependency references are correct before execution starts.

## Acceptance Criteria

1. Workflow parsing continues to load workflows from `workflows/*.y{a,}ml` using `tapps_agents/workflow/parser.py::WorkflowParser`, and all shipped workflows remain parseable without modification.
2. Validation is schema-first and version-aware:
   - A workflow can declare a schema version (e.g., `workflow.schema_version` or top-level `schema_version`), and the parser validates against the selected version.
   - Unknown/unsupported schema versions fail fast with an actionable error.
3. Parser validation includes cross-reference checks needed for orchestration and routing:
   - `next`, `optional_steps`, and gate routing targets (`gate.on_pass`/`gate.on_fail`) reference known step ids.
   - Step fields used by the executor (`requires`, `creates`, `consults`, `context_tier`, `condition`, `repeats`) are validated for type and allowed values.
4. Error messages always include file path and (when applicable) the step id, and explain what to fix (field name + expected type/value).
5. Unit tests cover invalid schemas, invalid references (including gate routing), and regression parsing of shipped workflows.

## Tasks / Subtasks

- [ ] Task 1: Audit current parsing and validations (AC: 1, 4)
  - [ ] Review `tapps_agents/workflow/parser.py` current behavior (wrapped vs legacy formats)
  - [ ] Inventory all fields used by `tapps_agents/workflow/executor.py` and Cursor executor paths

- [ ] Task 2: Define a versioned workflow schema contract (AC: 2–3)
  - [ ] Decide schema location + format (e.g., JSON Schema file(s) under `tapps_agents/workflow/` or an internal Python schema module)
  - [ ] Document required/optional fields per schema version, including gate shape and routing keys

- [ ] Task 3: Implement schema selection + validation in the parser (AC: 2–4)
  - [ ] Parse schema version and validate workflow-level fields and step-level fields
  - [ ] Strengthen cross-reference validation (`next`, `optional_steps`, `gate.on_pass`, `gate.on_fail`)
  - [ ] Ensure errors include `WorkflowParser._err_prefix(file_path, step_id)` context

- [ ] Task 4: Tests (AC: 5)
  - [ ] Extend `tests/unit/test_workflow_parser.py` with schema-version and gate-routing validation cases
  - [ ] Add/extend regression tests to parse all shipped workflows under `workflows/`

## Dev Notes

### Existing System Context

- YAML parsing/validation lives in `tapps_agents/workflow/parser.py::WorkflowParser`.
  - Uses `yaml.safe_load` and already supports both wrapped (`{workflow: {...}}`) and legacy formats.
  - Validates core workflow fields (id/name/description/version/type/settings) and step shape.
  - Validates cross-references for `next` and `optional_steps` today via `_validate_references`.
- Workflow models are dataclasses in `tapps_agents/workflow/models.py`.
- Regression coverage exists:
  - `tests/unit/test_workflow_parser.py` includes parse + invalid reference tests and a repo-workflow parse loop.

### Integration Approach

- Extend `WorkflowParser` to apply a schema contract prior to producing `Workflow`/`WorkflowStep` objects.
- Keep compatibility with the existing `workflows/` YAML files, especially preset workflows under `workflows/presets/`.
- Avoid introducing heavy dependencies if possible; if a schema library is introduced, ensure it is optional and/or lightweight.

### Risk Assessment

- **Risk**: Tightened validation breaks existing workflows.
- **Mitigation**: Keep a regression test that parses every shipped workflow; introduce new validations carefully and ensure error messages are actionable.

### Rollback Plan

- Revert schema-version enforcement while keeping improvements to error context and regression tests.

### Testing

- Use `pytest`.
- Primary unit tests: `tests/unit/test_workflow_parser.py`.
- Add targeted unit tests for schema-version selection and gate routing reference validation.

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 5.1        | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
