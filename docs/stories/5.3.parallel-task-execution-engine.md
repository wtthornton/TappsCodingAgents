# Story 5.3: Parallel Task Execution Engine

<!-- Source: implementation/cursor/EPIC_05_Workflow_Engine.md -->
<!-- Context: Structured concurrency, retries, cancellation, and bounded parallelism -->

## Status

Draft

## Story

**As a** workflow runner,
**I want** independent workflow steps to execute in parallel with bounded concurrency, retries, timeouts, and cancellation propagation,
**so that** workflows complete faster while remaining safe, deterministic, and resilient to transient failures.

## Acceptance Criteria

1. Independent steps execute in parallel with bounded concurrency:
   - Default max parallelism is 8, and can be configured at runtime (executor configuration and/or workflow settings).
2. Per-step timeouts are enforced with cancellation propagation:
   - A timed-out step is marked failed with a clear error.
   - Workflow cancellation stops in-flight steps best-effort and leaves persisted state consistent.
3. Retry behavior exists for retryable failures:
   - Configurable max attempts and backoff strategy (e.g., exponential backoff with jitter).
   - Non-retryable failures fail fast without retry.
4. Determinism is preserved:
   - State updates (step execution records and artifact merges) are applied in a deterministic order (e.g., sorted by `step.id`).
5. Unit tests cover timeouts, bounded concurrency, retry behavior, and deterministic ordering.

## Tasks / Subtasks

- [ ] Task 1: Align configuration surface for parallel execution (AC: 1)
  - [ ] Confirm default `max_parallel=8` and allow override (executor arg, config, and/or workflow settings)
  - [ ] Add per-step overrides (optional) via `WorkflowStep.metadata` or a dedicated field

- [ ] Task 2: Implement structured concurrency and cancellation propagation (AC: 2)
  - [ ] Ensure cancellation propagates to all running tasks when workflow fails/cancels
  - [ ] Ensure partial state is persisted safely (failed steps recorded, workflow status updated)

- [ ] Task 3: Add retries with backoff for retryable failures (AC: 3)
  - [ ] Define retry policy fields (max attempts, backoff, retryable error classification)
  - [ ] Implement retry loop at step execution boundary (so retries are per-step)

- [ ] Task 4: Preserve determinism in merges and state updates (AC: 4)
  - [ ] Ensure results are applied in stable order even when completion order varies

- [ ] Task 5: Tests (AC: 5)
  - [ ] Extend `tests/unit/workflow/test_parallel_executor.py` with retry/backoff tests
  - [ ] Add tests for deterministic ordering of merged results

## Dev Notes

### Existing System Context

- Parallel step execution already exists:
  - `tapps_agents/workflow/parallel_executor.py::ParallelStepExecutor`
    - Bounded concurrency via `asyncio.Semaphore`
    - Per-step timeouts via `asyncio.wait_for`
    - Deterministic result ordering via `results.sort(key=lambda r: r.step.id)`
  - `tapps_agents/workflow/executor.py::WorkflowExecutor.execute` uses `ParallelStepExecutor` and merges artifacts into `state.artifacts`.
- There are unit tests for concurrency and timeouts:
  - `tests/unit/workflow/test_parallel_executor.py`

### Integration Approach

- Extend `ParallelStepExecutor` to support retries/backoff and cancellation semantics without breaking current call sites.
- Keep deterministic ordering guarantees when multiple steps finish out of order.

### Risk Assessment

- **Risk**: Retry logic can mask real failures or prolong runs.
- **Mitigation**: Strict max attempts, clear retryable classification, and explicit reporting in step execution records.

### Rollback Plan

- Disable retries and revert to current one-shot step execution while preserving bounded concurrency and timeouts.

### Testing

- Use `pytest` and `pytest.mark.asyncio`.
- Primary unit tests: `tests/unit/workflow/test_parallel_executor.py`.

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 5.3        | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
