# Story 12.3: Real-Service Safety Controls

<!-- Source: implementation/cursor/EPIC_12_E2E_CI_CD_Execution.md -->
<!-- Context: Implement credential presence gates, token/time budgeting, and scheduled-only enforcement for real LLM/Context7 tests -->

## Status

Draft

## Story

**As a** CI/CD engineer and developer,
**I want** safety controls (credential gates, token/time budgeting, scheduled-only enforcement) for real-service E2E tests,
**so that** real-service tests are cost-effective, reliable, and only run when appropriate (scheduled/manual triggers) with proper safeguards.

## Acceptance Criteria

1. Credential presence gates exist:
   - Tests check for required credentials before execution
   - Tests skip cleanly when credentials are missing (skip, don't fail)
   - Clear skip messages indicate missing credentials
   - Credential gates work for `requires_llm` and `requires_context7` markers
   - Credential validation happens early (before expensive setup)
2. Token/time budgeting exists:
   - Token budgets are enforced per test suite (configurable limits)
   - Time budgets are enforced per test suite (configurable limits)
   - Budget tracking and reporting (tokens used, time elapsed)
   - Budget violations produce warnings or fail tests (configurable)
   - Budgets are reset per CI run
3. Per-suite timeouts exist:
   - Each test suite has explicit timeout (configurable)
   - Timeout violations produce clear error messages
   - Timeout violations trigger artifact capture
   - Timeouts are enforced at job level and suite level
4. Scheduled-only enforcement exists:
   - Real-service tests run only on schedule (nightly) or manual trigger
   - Real-service tests do not run on PR checks
   - Real-service tests do not run on main branch pushes (unless scheduled)
   - Scheduled-only enforcement is configurable and documented
5. Retry policy for transient failures:
   - Bounded retries for transient network failures (real LLM, Context7)
   - Bounded retries for transient service failures (API rate limits, temporary unavailability)
   - Retry configuration (max retries, backoff strategy, retryable error types)
   - Retry counts and reasons recorded in logs
   - Fail fast on deterministic logic errors (no retries)
6. Cost controls integrate with CI:
   - Cost tracking is reported in CI logs
   - Cost budgets are enforced in CI jobs
   - Cost violations are reported in CI summaries
   - Cost alerts are sent (if applicable)
7. Safety controls are configurable:
   - Configuration via environment variables
   - Configuration via pytest markers
   - Configuration via CI workflow variables
   - Default values are reasonable for scheduled execution
8. Safety controls are documented:
   - Credential requirements and setup
   - Token/time budget limits and configuration
   - Timeout configuration
   - Scheduled-only enforcement policy
   - Retry policy and configuration
9. Unit tests exist for safety control utilities.
10. Safety controls are tested in CI:
    - Credential gates are tested (with and without credentials)
    - Budget enforcement is tested (budget violations)
    - Timeout enforcement is tested (timeout violations)
    - Scheduled-only enforcement is tested (PR vs scheduled)

## Tasks / Subtasks

- [ ] Task 1: Implement credential presence gates (AC: 1)
  - [ ] Create `tests/e2e/fixtures/credential_gates.py`
  - [ ] Implement credential checking for `requires_llm` marker:
    - [ ] Check for Ollama (running locally)
    - [ ] Check for Anthropic API key
    - [ ] Check for OpenAI API key
  - [ ] Implement credential checking for `requires_context7` marker:
    - [ ] Check for Context7 API key
  - [ ] Implement skip logic (skip if missing, don't fail)
  - [ ] Add clear skip messages
  - [ ] Integrate with pytest skip logic
  - [ ] Test credential gates (with and without credentials)

- [ ] Task 2: Implement token/time budgeting (AC: 2)
  - [ ] Create `tests/e2e/fixtures/cost_controls.py`
  - [ ] Implement token budget tracking:
    - [ ] Track tokens used per test suite
    - [ ] Enforce token budget limits
    - [ ] Report token usage
  - [ ] Implement time budget tracking:
    - [ ] Track time elapsed per test suite
    - [ ] Enforce time budget limits
    - [ ] Report time usage
  - [ ] Implement budget violation handling (warnings or failures)
  - [ ] Add budget configuration (environment variables, markers)
  - [ ] Reset budgets per CI run

- [ ] Task 3: Implement per-suite timeouts (AC: 3)
  - [ ] Extend timeout utilities (from E2E foundation)
  - [ ] Implement per-suite timeout configuration
  - [ ] Enforce timeouts at suite level
  - [ ] Produce clear timeout error messages
  - [ ] Trigger artifact capture on timeout
  - [ ] Integrate with CI job timeouts

- [ ] Task 4: Implement scheduled-only enforcement (AC: 4)
  - [ ] Create `tests/e2e/fixtures/scheduled_enforcement.py`
  - [ ] Implement check for CI context (PR, main branch, scheduled)
  - [ ] Skip real-service tests on PR checks
  - [ ] Skip real-service tests on main branch pushes (unless scheduled)
  - [ ] Allow real-service tests on scheduled runs
  - [ ] Allow real-service tests on manual triggers
  - [ ] Add configuration for enforcement policy
  - [ ] Document enforcement policy

- [ ] Task 5: Implement retry policy (AC: 5)
  - [ ] Extend retry utilities (from Epic 10.3 if implemented)
  - [ ] Implement bounded retry logic for transient failures
  - [ ] Define retryable error types (network errors, rate limits, temporary unavailability)
  - [ ] Implement retry configuration (max retries, backoff strategy)
  - [ ] Record retry counts and reasons in logs
  - [ ] Fail fast on deterministic logic errors (no retries)
  - [ ] Integrate with workflow runner and CLI runner

- [ ] Task 6: Integrate cost controls with CI (AC: 6)
  - [ ] Add cost tracking to CI logs
  - [ ] Enforce cost budgets in CI jobs
  - [ ] Report cost violations in CI summaries
  - [ ] Add cost alerts (if applicable, e.g., Slack, email)
  - [ ] Test cost controls in CI

- [ ] Task 7: Make safety controls configurable (AC: 7)
  - [ ] Add environment variable configuration
  - [ ] Add pytest marker configuration
  - [ ] Add CI workflow variable configuration
  - [ ] Set reasonable defaults for scheduled execution
  - [ ] Document configuration options

- [ ] Task 8: Create pytest fixtures for safety controls (AC: 1, 2, 3, 4)
  - [ ] Add `credential_check` fixture to `tests/e2e/conftest.py`
  - [ ] Add `cost_budget` fixture
  - [ ] Add `suite_timeout` fixture
  - [ ] Add `scheduled_enforcement` fixture
  - [ ] Integrate with existing E2E fixtures

- [ ] Task 9: Documentation and unit tests (AC: 8, 9)
  - [ ] Document credential requirements in `docs/CI_REAL_TESTS.md`
  - [ ] Document token/time budget limits and configuration
  - [ ] Document timeout configuration
  - [ ] Document scheduled-only enforcement policy
  - [ ] Document retry policy and configuration
  - [ ] Create unit tests in `tests/unit/e2e/test_credential_gates.py`
  - [ ] Create unit tests in `tests/unit/e2e/test_cost_controls.py`
  - [ ] Create unit tests in `tests/unit/e2e/test_scheduled_enforcement.py`
  - [ ] Test credential gates
  - [ ] Test budget enforcement
  - [ ] Test timeout enforcement
  - [ ] Test scheduled-only enforcement

- [ ] Task 10: Test safety controls in CI (AC: 10)
  - [ ] Test credential gates in CI (with and without credentials)
  - [ ] Test budget enforcement in CI (budget violations)
  - [ ] Test timeout enforcement in CI (timeout violations)
  - [ ] Test scheduled-only enforcement in CI (PR vs scheduled)
  - [ ] Verify safety controls work correctly in all contexts

## Dev Notes

### Existing System Context

- Real tests documentation:
  - `tests/integration/README_REAL_TESTS.md` - real integration test guidance
  - Tests skip cleanly if services unavailable
- E2E foundation (from Epic 8):
  - `tests/e2e/fixtures/e2e_harness.py` - E2E harness utilities
  - Timeout utilities (if implemented)
- Reliability controls (from Epic 10.3):
  - `tests/e2e/fixtures/reliability_controls.py` - reliability controls (if implemented)
  - Retry policy, timeout controls, cost guardrails
- CI configuration:
  - `.github/workflows/ci.yml` - CI workflow
  - Scheduled triggers (if any)
- Existing skip logic:
  - `tests/conftest.py` - `pytest_collection_modifyitems` for skipping `requires_llm` and `requires_context7` tests

### Integration Approach

- Build on existing skip logic in `tests/conftest.py`
- Extend reliability controls from Epic 10.3 (if implemented)
- Integrate with CI workflow for scheduled-only enforcement
- Reuse E2E foundation utilities
- Follow existing real-tests documentation patterns

### Technology Research

- Use `pytest` fixtures for safety controls
- Use `pytest` skip markers for credential gates
- Use `pytest-timeout` for timeout enforcement
- Use `tenacity` or similar for retry logic (if needed)
- Use environment variables for configuration
- Use GitHub Actions context for CI detection

### Risk Assessment

- **Primary risk**: Safety controls become too restrictive or complex
- **Mitigation**: Keep controls focused and well-documented; provide clear defaults; test thoroughly
- **Rollback plan**: Safety controls are additive; can be disabled or simplified without affecting core test functionality

### Testing

- Test file location: `tests/unit/e2e/test_credential_gates.py`, `tests/unit/e2e/test_cost_controls.py`, etc.
- Test standards: Use `pytest`, follow existing unit test patterns
- Testing frameworks: `pytest`
- Specific requirements:
  - Test credential gates (with and without credentials)
  - Test budget enforcement (budget violations)
  - Test timeout enforcement (timeout violations)
  - Test scheduled-only enforcement (PR vs scheduled)
  - Test retry policy (transient failures, deterministic errors)
  - Test safety controls in CI (actual CI runs)

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 12.3       | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

_TBD_

## QA Results

_TBD_
