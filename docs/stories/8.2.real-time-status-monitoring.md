# Story 8.2: Real-Time Status Monitoring

<!-- Source: implementation/EPIC_08_Real_Time_Progress_Updates.md -->

## Status

**Ready for Review**

## Story

**As a** user running workflows,
**I want** real-time monitoring of workflow status changes,
**so that** progress updates are triggered immediately when execution state changes.

## Acceptance Criteria

1. Status file monitoring system detects changes in workflow status files
2. Event-driven updates are triggered when status changes occur
3. Background Agent execution status is monitored in real-time
4. Update frequency throttling prevents chat spam while maintaining responsiveness
5. Monitoring system handles file read failures gracefully with fallback mechanisms

## Tasks / Subtasks

- [x] Task 1: Implement status file monitoring (AC: 1)
  - [x] Create StatusFileMonitor class
  - [x] Implement file watching mechanism (polling or file system events)
  - [x] Detect changes to workflow state files in `.tapps-agents/workflow-state/`
  - [x] Handle multiple concurrent workflow monitoring

- [x] Task 2: Create event-driven update system (AC: 2)
  - [x] Define status change events (step_started, step_progress, step_completed, step_failed, workflow_completed)
  - [x] Implement event emitter/listener pattern
  - [x] Connect status changes to progress update generation
  - [x] Add event queuing for rapid status changes

- [x] Task 3: Add Background Agent monitoring (AC: 3)
  - [x] Monitor Background Agent execution status files
  - [x] Detect Background Agent lifecycle events (started, running, completed, failed)
  - [x] Integrate Background Agent status with workflow status monitoring
  - [x] Handle Background Agent execution in separate worktrees

- [x] Task 4: Implement update frequency throttling (AC: 4)
  - [x] Add configurable throttle settings (min_interval_seconds, max_updates_per_minute)
  - [x] Implement debounce mechanism for rapid status changes
  - [x] Prioritize critical updates (errors, completion) over routine progress
  - [x] Add adaptive throttling based on update importance

- [x] Task 5: Add error handling and fallback (AC: 5)
  - [x] Handle file read errors gracefully (file not found, permission denied, corrupted)
  - [x] Implement fallback to periodic polling if file watching fails
  - [x] Add retry logic with exponential backoff for transient failures
  - [x] Log monitoring errors without disrupting workflow execution

## Dev Notes

### Existing System Context

- Status files stored in `.tapps-agents/workflow-state/` directory
- Workflow state JSON files updated by CursorWorkflowExecutor.save_state()
- Background Agent execution creates status files in worktree directories
- File watching available via watchdog library (if needed) or polling with pathlib
- Status files from Epic 7 provide structured status information

### Integration Approach

- Create new module `tapps_agents/workflow/status_monitor.py`
- StatusFileMonitor integrates with existing state persistence system
- Event system connects to ProgressUpdateGenerator from Story 8.1
- Monitoring runs asynchronously to avoid blocking workflow execution
- Configuration for monitoring behavior in `.tapps-agents/config.yaml`

### Technical Considerations

- Choose polling vs file system events based on platform support (Windows, macOS, Linux)
- Polling interval should balance responsiveness vs resource usage
- Event system must handle high-frequency status changes (rapid step execution)
- Background Agent monitoring must handle worktree isolation (separate file paths)
- Monitoring should be lightweight to not impact workflow performance

### Risk Assessment

- **Primary risk**: File watching may fail on some platforms (Windows file locking)
  - **Mitigation**: Fallback to polling, handle platform-specific issues, graceful degradation
- **Primary risk**: Monitoring overhead may slow down workflow execution
  - **Mitigation**: Async monitoring, efficient polling intervals, event batching
- **Primary risk**: Status file race conditions during rapid updates
  - **Mitigation**: File locking checks, retry logic, handle partial file reads gracefully

### Rollback Plan

- Status monitoring is optional enhancement
- Can disable via configuration flag
- Falls back to manual status checks if monitoring disabled
- No changes to status file format or persistence logic

### Testing

- Unit tests for StatusFileMonitor (file change detection, event emission)
- Unit tests for throttling mechanism (interval enforcement, priority handling)
- Integration tests with actual status files (create, modify, delete scenarios)
- Test Background Agent monitoring with worktree isolation
- Test error handling (missing files, permission errors, corrupted JSON)
- Performance tests to ensure monitoring doesn't impact workflow speed

## Change Log

| Date       | Version | Description                     | Author      |
| ---------- | ------- | ------------------------------- | ----------- |
| 2025-01-27 | 0.1     | Initial draft for Epic 8.2      | bmad-master |

## Dev Agent Record

_TBD_

## QA Results

_TBD_

