# Story 4.4: Cache Statistics & Monitoring

<!-- Source: implementation/cursor/EPIC_04_Context7_Integration.md -->
<!-- Context: Extend existing Context7 analytics + health reporting to meet Epic targets -->

## Status

Draft

## Story

**As a** developer and operations owner,
**I want** clear, queryable Context7 cache statistics and health monitoring,
**so that** we can measure hit rate, latency, and token savings and detect regressions early.

## Acceptance Criteria

1. Cache statistics are accessible programmatically via `Context7AgentHelper.get_cache_statistics()` and include (when enabled):
   - `total_entries`, `total_libraries`, `cache_hits`, `cache_misses`, `hit_rate`, `avg_response_time_ms`
2. A cache health indicator exists (e.g., `healthy` vs `needs_attention`) based on the configured hit rate threshold (`Context7KnowledgeBaseConfig.hit_rate_threshold`).
3. Token accounting is available:
   - Cache entries track token counts (already estimated in `KBCache.store`)
   - Metrics/reporting includes `total_tokens` and a best-effort “token savings” estimate (documented clearly as approximate)
4. Metrics persistence is durable and safe:
   - Metrics writes do not corrupt `.metrics.yaml` under concurrent access (best-effort; see locking/atomic write story)
5. Unit tests cover statistics shape and health classification, extending existing analytics tests.

## Tasks / Subtasks

- [ ] Task 1: Standardize stats output + health classification (AC: 1–2)
  - [ ] Confirm baseline fields in `tapps_agents/context7/agent_integration.py::get_cache_statistics`
  - [ ] Add/align health status calculation using config hit-rate threshold

- [ ] Task 2: Add token accounting and token-savings estimate (AC: 3)
  - [ ] Ensure `LibraryMetadata.total_tokens` is kept up to date (if currently missing/under-reported)
  - [ ] Implement a documented approximate token-savings metric (e.g., “tokens served from cache” vs “tokens fetched via API”)

- [ ] Task 3: Expose stats for automation (AC: 1)
  - [ ] Extend `Context7Commands.cmd_status()` or add a JSON-export helper for CI dashboards

- [ ] Task 4: Add tests (AC: 5)
  - [ ] Extend `tests/unit/context7/test_analytics.py` with health classification assertions
  - [ ] Add regression tests for stats schema returned by helper/commands

## Dev Notes

### Existing System Context

- Analytics implementation:
  - `tapps_agents/context7/analytics.py::Analytics` persists counters in `.metrics.yaml` and computes `CacheMetrics`.
  - `get_status_report()` already provides a `status` field based on hit rate (>70% = healthy).
- Agent-facing stats surface:
  - `tapps_agents/context7/agent_integration.py::Context7AgentHelper.get_cache_statistics()` returns `enabled` plus metrics.
- Token counts are estimated at store time:
  - `tapps_agents/context7/kb_cache.py::KBCache.store` computes `token_count = len(content) // 4` for entries.

### Integration Approach

- Align the health threshold with config (`Context7KnowledgeBaseConfig.hit_rate_threshold`) instead of a hardcoded 70%.
- Keep token savings explicitly approximate (this repo estimates tokens based on character count).

### Risk Assessment

- **Risk**: metrics drift between “per-entry metadata” and global `.metrics.yaml` counters.
- **Mitigation**: keep schema stable and test the public outputs; avoid breaking changes.

### Rollback Plan

- Revert to the existing analytics status report behavior.

### Testing

- Existing analytics tests live in `tests/unit/context7/test_analytics.py`.

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 4.4        | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
