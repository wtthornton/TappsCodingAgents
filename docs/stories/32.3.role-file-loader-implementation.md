# Story 32.3: Role File Loader Implementation

<!-- Source: implementation/EPIC_04_Agent_Role_Markdown_Files.md -->

## Status

**Ready for Review**

## Story

**As a** framework user,
**I want** a loader that reads and parses agent role files,
**so that** role definitions can be applied to agents during initialization.

## Acceptance Criteria

1. Role file loader reads markdown files from `templates/agent_roles/`
2. Loader parses YAML frontmatter correctly
3. Loader parses markdown content correctly
4. Loader integrates into agent initialization flow
5. Role file lookup by agent ID works correctly
6. Loader handles missing role files gracefully (no error, uses defaults)
7. Loader handles invalid role files gracefully (logs error, uses defaults)

## Tasks / Subtasks

- [x] Task 1: Implement file reading (AC: 1)
  - [x] Read markdown files from role directory
  - [x] Handle file not found
  - [x] Support role file lookup by agent_id

- [x] Task 2: Parse YAML frontmatter (AC: 2)
  - [x] Extract YAML frontmatter from markdown
  - [x] Parse YAML metadata
  - [x] Validate required fields

- [x] Task 3: Parse markdown content (AC: 3)
  - [x] Extract markdown content
  - [x] Parse sections (Identity, Principles, etc.)
  - [x] Structure parsed content

- [ ] Task 4: Integrate with agent init (AC: 4)
  - [ ] Add loader call to agent initialization
  - [ ] Load role file before persona adoption
  - [ ] Apply role definitions

- [x] Task 5: Implement lookup (AC: 5)
  - [x] Lookup role file by agent_id
  - [x] Handle case variations
  - [x] Support multiple lookup strategies

- [x] Task 6: Error handling (AC: 6, 7)
  - [x] Handle missing role files
  - [x] Handle invalid YAML
  - [x] Handle invalid markdown
  - [x] Log errors, use defaults

## Dev Notes

### Existing System Context

- Agent initialization in `tapps_agents/core/agent_base.py`
- Markdown parsing available
- YAML parsing available
- File reading utilities exist

### Integration Approach

- Create role file loader module
- Use markdown/YAML parsing libraries
- Integrate with agent initialization
- Follow existing loader patterns

### Risk Assessment

- **Primary risk**: Parsing may fail on edge cases
  - **Mitigation**: Robust parsing, error handling, validation

### Rollback Plan

- Remove role file loading
- Role files optional
- No breaking changes

### Testing

- Test file reading
- Test YAML parsing
- Test markdown parsing
- Test lookup functionality
- Test error handling
- Integration tests

## Change Log

| Date       | Version | Description                     | Author      |
| ---------- | ------- | ------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 32.3     | bmad-master |

## Dev Agent Record

### Completion Notes

- Created role file loader module: `tapps_agents/core/role_loader.py`
- Implemented YAML frontmatter parsing with error handling
- Implemented markdown section parsing (Identity, Principles, Communication Style, etc.)
- Implemented role file lookup by agent_id (supports project-specific and framework default paths)
- Graceful error handling: missing files return None, invalid files log warnings and return None
- Loader returns structured data with metadata and sections

### File List

- `tapps_agents/core/role_loader.py` (new)

### Change Log

| Date       | Version | Description                     | Author      |
| ---------- | ------- | ------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 32.3     | bmad-master |
| 2025-01-XX | 1.0     | Story completed - loader implemented | James       |

## QA Results

_TBD_

