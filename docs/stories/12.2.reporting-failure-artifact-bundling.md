# Story 12.2: Reporting + Failure Artifact Bundling

<!-- Source: implementation/cursor/EPIC_12_E2E_CI_CD_Execution.md -->
<!-- Context: Produce consistent artifacts on failure (logs, state snapshots, produced files) and publish JUnit + minimal summaries for PR checks -->

## Status

Draft

## Story

**As a** CI/CD engineer and developer,
**I want** consistent failure artifact bundling and reporting (JUnit XML, failure bundles, minimal summaries) for E2E test failures,
**so that** failures are diagnosable without rerunning locally and CI results are actionable for PR checks.

## Acceptance Criteria

1. JUnit XML reporting exists for CI UI:
   - JUnit XML is generated for all test runs
   - JUnit XML includes test results, timing, and failure details
   - JUnit XML is published as CI artifact
   - JUnit XML is compatible with CI UI (GitHub Actions, GitLab CI, etc.)
2. Failure artifact bundling exists:
   - Failure bundles are created automatically on test failure
   - Failure bundles include:
     - Test logs (structured logs with correlation IDs)
     - State snapshots (workflow state, step state, test state)
     - Produced files (artifacts, outputs, generated files)
     - Step timeline (execution timeline, step transitions)
     - Environment information (Python version, OS, dependencies)
   - Failure bundles are published as CI artifacts
3. Minimal summaries exist for PR checks:
   - Test summary is generated (pass/fail counts, duration)
   - Summary is displayed in PR checks (GitHub Actions, GitLab CI)
   - Summary includes key failure information (test name, error message)
   - Summary is concise and actionable
4. Artifact security hygiene:
   - Secrets are redacted from logs before bundling
   - PII is redacted from logs and artifacts
   - Credentials are masked in captured output
   - Failure bundles are safe to publish in CI
5. Correlation IDs are attached to CI logs:
   - Each test run has a correlation ID
   - Correlation ID is included in logs, state snapshots, and artifacts
   - Correlation ID enables traceability across logs and artifacts
6. Artifact collection utilities exist:
   - Utilities to collect logs, state, artifacts, and timeline
   - Utilities to create failure bundles
   - Utilities to redact secrets from artifacts
   - Utilities to generate JUnit XML
7. CI integration for artifact publishing:
   - Artifacts are uploaded to CI artifact storage
   - Artifacts are retained for appropriate duration (e.g., 7 days)
   - Artifacts are accessible from CI UI
   - Artifact download links are provided in PR checks
8. Reporting utilities integrate with E2E foundation:
   - Use E2E artifact capture utilities
   - Use E2E correlation IDs
   - Follow E2E conventions (logging, failure bundles)
9. Unit tests exist for reporting utilities.
10. Documentation exists for artifact structure and access.

## Tasks / Subtasks

- [ ] Task 1: Implement JUnit XML generation (AC: 1)
  - [ ] Create `tests/e2e/fixtures/junit_reporter.py`
  - [ ] Implement JUnit XML generation from pytest results
  - [ ] Include test results, timing, and failure details
  - [ ] Ensure JUnit XML compatibility with CI UI
  - [ ] Integrate with pytest hooks or plugins

- [ ] Task 2: Implement failure artifact bundling (AC: 2, 5)
  - [ ] Create `tests/e2e/fixtures/artifact_bundler.py`
  - [ ] Implement failure bundle creation:
    - [ ] Collect test logs (with correlation IDs)
    - [ ] Collect state snapshots (workflow, step, test state)
    - [ ] Collect produced files (artifacts, outputs)
    - [ ] Collect step timeline (execution timeline)
    - [ ] Collect environment information
  - [ ] Create failure bundle archive (ZIP or tar)
  - [ ] Include correlation ID in bundle

- [ ] Task 3: Implement minimal summaries (AC: 3)
  - [ ] Create `tests/e2e/fixtures/summary_reporter.py`
  - [ ] Implement test summary generation:
    - [ ] Pass/fail counts
    - [ ] Test duration
    - [ ] Key failure information (test name, error message)
  - [ ] Format summary for CI UI (GitHub Actions, GitLab CI)
  - [ ] Integrate with pytest hooks

- [ ] Task 4: Implement artifact security hygiene (AC: 4)
  - [ ] Extend secret redaction utilities (from E2E foundation)
  - [ ] Redact secrets from logs before bundling
  - [ ] Redact PII from logs and artifacts
  - [ ] Mask credentials in captured output
  - [ ] Validate failure bundles are safe to publish
  - [ ] Add redaction configuration (patterns, keywords)

- [ ] Task 5: Implement correlation ID attachment (AC: 5)
  - [ ] Extend correlation ID utilities (from E2E foundation)
  - [ ] Attach correlation ID to CI logs
  - [ ] Include correlation ID in state snapshots
  - [ ] Include correlation ID in artifacts
  - [ ] Enable traceability across logs and artifacts

- [ ] Task 6: Create artifact collection utilities (AC: 6)
  - [ ] Create utilities to collect logs (structured logs)
  - [ ] Create utilities to collect state snapshots
  - [ ] Create utilities to collect artifacts and produced files
  - [ ] Create utilities to collect step timeline
  - [ ] Create utilities to create failure bundles
  - [ ] Create utilities to redact secrets
  - [ ] Integrate with E2E artifact capture utilities

- [ ] Task 7: Integrate with CI for artifact publishing (AC: 7)
  - [ ] Add artifact upload step to CI workflow
  - [ ] Upload JUnit XML as artifact
  - [ ] Upload failure bundles as artifacts
  - [ ] Set artifact retention (e.g., 7 days)
  - [ ] Add artifact download links to PR checks
  - [ ] Test artifact publishing in CI

- [ ] Task 8: Integrate with E2E foundation (AC: 8)
  - [ ] Use E2E artifact capture utilities
  - [ ] Use E2E correlation IDs
  - [ ] Follow E2E conventions (logging, failure bundles)
  - [ ] Integrate with E2E fixtures in `tests/e2e/conftest.py`

- [ ] Task 9: Create pytest hooks/plugins (AC: 1, 2, 3)
  - [ ] Create pytest hook for JUnit XML generation
  - [ ] Create pytest hook for failure artifact bundling
  - [ ] Create pytest hook for summary generation
  - [ ] Integrate with pytest test execution lifecycle
  - [ ] Test hooks in pytest execution

- [ ] Task 10: Unit tests and documentation (AC: 9, 10)
  - [ ] Create unit tests in `tests/unit/e2e/test_junit_reporter.py`
  - [ ] Create unit tests in `tests/unit/e2e/test_artifact_bundler.py`
  - [ ] Create unit tests in `tests/unit/e2e/test_summary_reporter.py`
  - [ ] Test JUnit XML generation
  - [ ] Test failure artifact bundling
  - [ ] Test secret redaction
  - [ ] Document artifact structure in `docs/CI_ARTIFACTS.md`
  - [ ] Document how to access artifacts from CI
  - [ ] Document correlation ID usage

## Dev Notes

### Existing System Context

- E2E foundation (from Epic 8):
  - `tests/e2e/fixtures/e2e_harness.py` - E2E harness utilities
  - Artifact capture utilities
  - Correlation ID utilities
  - Secret redaction utilities (if implemented)
- CI configuration:
  - `.github/workflows/ci.yml` - CI workflow
  - Artifact upload patterns (if any)
- Pytest plugins:
  - `pytest-html` - HTML reporting (if used)
  - `pytest-junit` - JUnit XML (if used)
  - `pytest-cov` - Coverage reporting
- Existing reporting:
  - Coverage reports (XML, HTML)
  - Test output in CI logs

### Integration Approach

- Build on E2E artifact capture utilities from Epic 8
- Extend correlation ID utilities
- Create pytest hooks/plugins for reporting
- Integrate with CI artifact upload
- Reuse secret redaction patterns

### Technology Research

- Use `pytest` hooks for reporting integration
- Use `pytest-junit` or custom JUnit XML generation
- Use `pytest-html` for HTML reports (if needed)
- Use `zipfile` or `tarfile` for artifact bundling
- Use `json` for structured logs
- Use GitHub Actions artifact upload

### Risk Assessment

- **Primary risk**: Artifacts become too large or contain secrets
- **Mitigation**: Enforce secret redaction; limit artifact size; compress artifacts
- **Rollback plan**: Can disable artifact bundling or reduce scope; JUnit XML remains essential

### Testing

- Test file location: `tests/unit/e2e/test_junit_reporter.py`, `tests/unit/e2e/test_artifact_bundler.py`, etc.
- Test standards: Use `pytest`, follow existing unit test patterns
- Testing frameworks: `pytest`
- Specific requirements:
  - Test JUnit XML generation (valid XML, correct structure)
  - Test failure artifact bundling (all components included)
  - Test secret redaction (secrets removed)
  - Test correlation ID attachment
  - Test artifact publishing in CI (actual CI run)

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 12.2       | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

_TBD_

## QA Results

_TBD_
