# Story 3.1: Expert Registry & Configuration System

<!-- Source: implementation/cursor/EPIC_03_Expert_System.md -->
<!-- Context: Brownfield hardening of existing tapps_agents/experts registry + config loading -->

## Status

Draft

## Story

**As a** workflow agent that consults experts (e.g., Designer/Implementer),
**I want** a reliable Expert Registry and configuration system that loads built-in + customer experts deterministically,
**so that** expert consultation is consistent, optional, and safe across projects.

## Acceptance Criteria

1. Expert configuration can be loaded from project-local files when present:
   - `.tapps-agents/domains.md` (domain-driven weight matrix)
   - `.tapps-agents/experts.yaml` (explicit expert list)
   and falls back to built-in experts only when neither exists.
2. Precedence is deterministic and documented (e.g., domains.md preferred over experts.yaml, or explicit rule), and registry initialization does not double-initialize or drop customer experts.
3. Customer vs built-in experts remain clearly separated (built-in immutable, customer configurable) while both are accessible via a single consult API.
4. Expert consultation remains **optional**: if registry initialization fails, agents continue without expert guidance (no crashes) and emit a clear log/debug signal.
5. Unit tests cover the load paths and separation logic (built-in only, domains.md, experts.yaml, and fallback).

## Tasks / Subtasks

- [ ] Task 1: Audit current expert configuration load paths (AC: 1–2)
  - [ ] Review `tapps_agents/experts/agent_integration.py::_initialize_expert_support`
  - [ ] Review `tapps_agents/experts/domain_config.py::DomainConfigParser`
  - [ ] Review `tapps_agents/experts/expert_registry.py::from_config_file` (ensure single registry construction and correct customer expert registration)

- [ ] Task 2: Define and document deterministic precedence + error handling (AC: 2, 4)
  - [ ] Decide and implement a single precedence rule (domains.md vs experts.yaml)
  - [ ] Ensure errors are logged at debug/warn and do not abort agent activation

- [ ] Task 3: Ensure config schema validation and helpful errors (AC: 1–2)
  - [ ] Validate `experts.yaml` via `tapps_agents/experts/expert_config.py` (Pydantic model)
  - [ ] Provide actionable error messages (file path, failing expert index/key)

- [ ] Task 4: Add/extend tests (AC: 5)
  - [ ] Add/extend tests under `tests/unit/experts/` for precedence and fallback
  - [ ] Add regression test ensuring customer experts are not lost when built-ins are loaded

## Dev Notes

### Existing System Context

- Expert system lives in `tapps_agents/experts/`.
- Registry: `tapps_agents/experts/expert_registry.py` (built-in + customer separation, consult aggregation).
- Built-in expert definitions: `tapps_agents/experts/builtin_registry.py`.
- Domains parsing + weight matrix generation: `tapps_agents/experts/domain_config.py`, `tapps_agents/experts/weight_distributor.py`.
- YAML config model and loader: `tapps_agents/experts/expert_config.py`.
- Agent integration mixin: `tapps_agents/experts/agent_integration.py`.

### Integration Approach

- Keep `ExpertSupportMixin` as the single place that wires expert support into agents.
- Ensure registry construction is single-pass and deterministic; avoid side effects that re-create the registry after registering customer experts.

### Risk Assessment

- **Risk**: precedence ambiguity or double-initialization causes silent loss of customer experts.
- **Mitigation**: explicit precedence rule + tests that assert the final `registry.list_experts()` contains expected IDs.

### Rollback Plan

- If precedence changes break projects, revert to built-in-only fallback and treat project expert files as optional until fixed.

### Testing

- Use existing patterns in `tests/unit/experts/test_dual_layer_registry.py` and related expert tests.

## Change Log

| Date       | Version | Description                    | Author      |
| ---------- | ------- | ------------------------------ | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 3.1     | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
