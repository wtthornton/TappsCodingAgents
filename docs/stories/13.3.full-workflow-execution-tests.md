# Story 13.3: Full Workflow Execution Tests

<!-- Source: implementation/cursor/EPIC_13_E2E_Functional_Validation.md -->
<!-- Context: Extend workflow tests to execute complete workflows and validate intermediate and final outcomes -->

## Status

Draft

## Story

**As a** QA engineer and developer,
**I want** workflow tests that execute complete workflows end-to-end and validate step execution order, dependencies, intermediate state, and final outcomes,
**so that** E2E tests validate actual workflow functionality rather than just running 2-3 steps and checking structure.

## Acceptance Criteria

1. Workflow tests execute complete workflows from start to finish (not just 2-3 steps).
2. Workflow tests validate step execution order correctness:
   - Steps execute in correct sequence
   - Dependencies are resolved correctly
   - Parallel steps execute concurrently when appropriate
3. Workflow tests validate step dependency resolution:
   - Dependencies are correctly identified
   - Steps wait for dependencies before executing
   - Dependency failures propagate correctly
4. Workflow tests validate intermediate state correctness:
   - State is correct after each step
   - Artifacts are created correctly at each step
   - State transitions are valid
5. Workflow tests validate final outcome correctness:
   - Final state matches expected outcome
   - All required artifacts are created
   - Workflow completes successfully
6. Workflow tests include gate routing validation:
   - Pass/fail paths are tested
   - Conditional routing works correctly
   - Gate conditions are evaluated correctly
7. Workflow tests include error handling and recovery validation:
   - Error handling works correctly
   - Recovery mechanisms function properly
   - Error propagation is correct
8. Full workflow execution tests are added to `tests/e2e/workflows/` for key workflows.
9. Workflow execution tests use behavioral mocks (Story 13.1) and outcome validation (Story 13.2).
10. Workflow execution tests are well-documented with examples.

## Tasks / Subtasks

- [ ] Task 1: Analyze existing workflow tests and identify gaps (AC: 1)
  - [ ] Review existing workflow tests in `tests/e2e/workflows/`
  - [ ] Identify which workflows are only partially tested
  - [ ] Document current test limitations (2-3 steps only, no outcome validation)
  - [ ] Identify key workflows that need full execution tests

- [ ] Task 2: Design full workflow execution test framework (AC: 2, 3, 4, 5)
  - [ ] Design test structure for complete workflow execution
  - [ ] Design step execution order validation
  - [ ] Design dependency resolution validation
  - [ ] Design intermediate state validation
  - [ ] Design final outcome validation

- [ ] Task 3: Implement workflow execution test utilities (AC: 2, 3, 4, 5)
  - [ ] Create `execute_full_workflow(workflow_path, project_path)` utility
  - [ ] Create `validate_step_order(workflow_state, expected_order)` utility
  - [ ] Create `validate_dependencies(workflow_state, step_dependencies)` utility
  - [ ] Create `validate_intermediate_state(workflow_state, step_name, expected_state)` utility
  - [ ] Create `validate_final_outcome(workflow_state, expected_outcome)` utility

- [ ] Task 4: Implement gate routing validation (AC: 6)
  - [ ] Create `validate_gate_routing(workflow_state, gate_name, expected_path)` utility
  - [ ] Add tests for pass/fail paths
  - [ ] Add tests for conditional routing
  - [ ] Validate gate condition evaluation

- [ ] Task 5: Implement error handling and recovery validation (AC: 7)
  - [ ] Create `validate_error_handling(workflow_state, error_scenario)` utility
  - [ ] Add tests for error handling
  - [ ] Add tests for recovery mechanisms
  - [ ] Validate error propagation

- [ ] Task 6: Create full workflow execution tests (AC: 8, 9)
  - [ ] Create full execution test for key preset workflows
  - [ ] Create full execution test for example workflows
  - [ ] Integrate with behavioral mocks (Story 13.1)
  - [ ] Integrate with outcome validation (Story 13.2)
  - [ ] Ensure tests validate actual outcomes, not just structure

- [ ] Task 7: Documentation and examples (AC: 10)
  - [ ] Document full workflow execution test patterns
  - [ ] Add examples for step order validation
  - [ ] Add examples for dependency validation
  - [ ] Add examples for outcome validation
  - [ ] Update `tests/e2e/README.md` with new patterns

## Dev Notes

### Existing System Context

- Current workflow tests:
  - Located in `tests/e2e/workflows/`
  - Currently run only 2-3 steps of workflows
  - Validate structure (files exist, state has fields) but not functionality
  - Use generic `mock_mal` fixture
- Workflow system:
  - Workflows defined in YAML under `workflows/`
  - Workflow executor in `tapps_agents/workflow/executor.py`
  - Workflow state persisted to `.tapps-agents/workflow-state/`
  - Supports step dependencies, parallel execution, gate routing
- E2E test structure:
  - `tests/e2e/fixtures/` contains E2E harness utilities
  - `tests/e2e/workflows/` contains workflow tests
  - Existing workflow tests use partial execution

### Integration Approach

- Build on existing workflow test structure in `tests/e2e/workflows/`
- Extend existing tests to execute full workflows
- Integrate with behavioral mocks from Story 13.1
- Integrate with outcome validation from Story 13.2
- Use existing E2E harness for project setup and artifact capture

### Technology Research

- Study workflow executor implementation to understand step execution
- Study workflow state structure for state validation
- Use `pytest` for test execution
- Use `pytest-asyncio` for async workflow execution
- Review existing workflow YAML files to understand workflow structure

### Risk Assessment

- **Primary risk**: Full workflow execution tests are slow
- **Mitigation**: Use behavioral mocks for fast execution; add timeouts; run in scheduled CI
- **Secondary risk**: Workflow state validation may be complex
- **Mitigation**: Start with simple validations; incrementally add complexity
- **Rollback plan**: Full execution tests are additive; existing partial tests remain

### Testing

- Test file location: `tests/e2e/workflows/` (new test files)
- Test standards: Use `pytest`, follow existing E2E test patterns
- Testing frameworks: `pytest`, `pytest-asyncio` for async execution
- Specific requirements:
  - Test complete workflow execution
  - Test step order validation
  - Test dependency resolution
  - Test intermediate state validation
  - Test final outcome validation
  - Test gate routing
  - Test error handling

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 13.3       | bmad-master |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_

