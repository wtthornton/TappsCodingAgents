# Story 29.1: Customization Directory Structure & File Format

<!-- Source: implementation/EPIC_01_Update_Safe_Agent_Customization_Layer.md -->
<!-- Context: Brownfield enhancement - Foundation for agent customization system -->

## Status

**Ready for Review**

## Story

**As a** framework user,
**I want** a standardized directory structure and file format for agent customizations,
**so that** I can customize agent behaviors in a consistent, update-safe way that persists through framework updates.

## Acceptance Criteria

1. `.tapps-agents/customizations/` directory structure is created during project initialization
2. YAML customization file format is defined with required fields: `agent_id`, `persona_overrides`, `command_overrides`, `dependency_overrides`, `project_context`
3. Customization file schema validation is implemented (validates YAML structure and required fields)
4. Customization file naming convention is documented: `{agent-id}-custom.yaml` (e.g., `implementer-custom.yaml`)
5. Example customization file template is created demonstrating all format sections
6. Schema validation catches common errors (missing agent_id, invalid YAML, unknown override keys)

## Tasks / Subtasks

- [x] Task 1: Create directory structure (AC: 1)
  - [x] Add `.tapps-agents/customizations/` directory creation to `init_project()`
  - [x] Ensure directory is created if it doesn't exist
  - [x] Add directory to default gitignore patterns

- [x] Task 2: Define YAML file format (AC: 2)
  - [x] Document YAML structure with all required sections
  - [x] Define `persona_overrides` structure (communication_style, expertise_areas, custom_instructions)
  - [x] Define `command_overrides` structure (add, modify)
  - [x] Define `dependency_overrides` structure (tasks, templates, data)
  - [x] Define `project_context` structure (always_load, preferences)

- [x] Task 3: Implement schema validation (AC: 3, 6)
  - [x] Create YAML schema validation function
  - [x] Validate required fields (agent_id must match filename)
  - [x] Validate YAML syntax
  - [x] Warn on unknown override keys
  - [x] Validate referenced files exist (tasks, templates, data)

- [x] Task 4: Document naming convention (AC: 4)
  - [x] Document `{agent-id}-custom.yaml` naming pattern
  - [x] Add examples of valid filenames
  - [x] Document agent_id matching requirements

- [x] Task 5: Create example template (AC: 5)
  - [x] Create example customization file with all sections
  - [x] Add comments explaining each section
  - [x] Include common customization patterns

## Dev Notes

### Existing System Context

- Project initialization exists in `tapps_agents/core/init_project.py`
- BMAD pattern reference exists in `.bmad-core/customizations/` directory
- Agent definitions are in `.claude/skills/` and `tapps_agents/agents/`
- Project configuration directory is `.tapps-agents/`

### Integration Approach

- Extend `init_project()` to create customizations directory
- Create schema validation module in `tapps_agents/core/customization_schema.py`
- Follow BMAD customization pattern for consistency
- Use YAML parsing library (likely already in dependencies)

### Risk Assessment

- **Primary risk**: Schema validation may be too strict or too permissive
  - **Mitigation**: Start with basic validation, extend based on usage, allow warnings for unknown keys
- **Primary risk**: Directory creation may fail in restricted environments
  - **Mitigation**: Handle permission errors gracefully, provide clear error messages

### Rollback Plan

- Remove customizations directory creation from init_project()
- Schema validation is additive, can be disabled if issues arise

### Testing

- Unit tests for directory creation
- Unit tests for schema validation (valid files, invalid files, edge cases)
- Test file naming convention matching
- Use pytest with tmp_path for isolated testing

## Change Log

| Date       | Version | Description                     | Author      |
| ---------- | ------- | ------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 29.1     | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

- `tapps_agents/core/customization_schema.py` - Schema validation module
- `tapps_agents/core/init_project.py` - Updated with `init_customizations_directory()` function
- `tapps_agents/resources/customizations/example-custom.yaml` - Example template file

## QA Results

_TBD_

