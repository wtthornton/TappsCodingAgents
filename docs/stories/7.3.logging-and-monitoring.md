# Story 7.3: Logging & Monitoring

<!-- Source: implementation/cursor/EPIC_07_Documentation_Polish.md -->
<!-- Context: Structured logs + trace correlation + key metrics/reporting -->

## Status

Draft

## Story

**As a** workflow operator,
**I want** structured logging and lightweight monitoring for workflows and agents,
**so that** I can debug runs quickly and track key SLIs (latency, success rate, retries, cache hit rate, token usage).

## Acceptance Criteria

1. Logs emitted by workflow execution and key agents include consistent correlation fields (at minimum `workflow_id`, `step_id`, and `agent`), and do not leak secrets.
2. Trace context is propagated into logs when available (best-effort):
   - uses a stable field name (e.g., `trace_id`) and sources it from runtime markers such as `CURSOR_TRACE_ID` when present.
3. Logging supports a structured output option (e.g., JSON formatting) suitable for ingestion by log tools, while remaining compatible with local/dev console output.
4. Monitoring/metrics are captured and persisted for at least:
   - workflow success/failure and duration
   - per-agent execution counts and success rate
   - Context7 cache metrics (hit rate, latency, token counts) when Context7 is enabled
5. CLI exposes a supported way to view or export monitoring outputs for workflows and agents.
6. Tests validate correlation fields, redaction behavior, and that metric persistence does not corrupt files under typical use.

## Tasks / Subtasks

- [ ] Task 1: Standardize correlation fields across logs (AC: 1)
  - [ ] Ensure workflow logs consistently use `WorkflowLogger` (or a compatible mechanism)
  - [ ] Ensure secret redaction is applied for workflow-facing logs

- [ ] Task 2: Add trace-context propagation (AC: 2)
  - [ ] Read runtime markers (e.g., `CURSOR_TRACE_ID`) and attach to log context
  - [ ] Ensure trace fields do not break existing logging handlers

- [ ] Task 3: Add structured logging option (AC: 3)
  - [ ] Add config toggle for JSON formatting (opt-in)
  - [ ] Keep dev-friendly output available

- [ ] Task 4: Consolidate metrics/reporting (AC: 4, 5)
  - [ ] Leverage existing analytics collectors for workflow/agent history
  - [ ] Integrate Context7 analytics when enabled
  - [ ] Expose outputs via CLI (existing `analytics` commands)

- [ ] Task 5: Tests (AC: 6)
  - [ ] Unit test redaction patterns and correlation fields
  - [ ] Add tests for metrics persistence (file writes) to avoid corruption

## Dev Notes

### Existing System Context

- Workflow correlation logging already exists:
  - `tapps_agents/workflow/logging_helper.py::WorkflowLogger` attaches `workflow_id`, `step_id`, `agent` via `logging` `extra=...` and applies basic secret redaction.
- Runtime trace context marker exists:
  - `tapps_agents/core/runtime_mode.py` checks environment markers including `CURSOR_TRACE_ID`.
- Metrics/monitoring exists in two main places:
  - Workflow + agent analytics: `tapps_agents/core/analytics_dashboard.py` persists history under `.tapps-agents/analytics/history/*.jsonl` and is exposed via CLI `analytics` commands.
  - Context7 cache metrics: `tapps_agents/context7/analytics.py` persists `.metrics.yaml` and exposes cache status via Context7 helper/commands.
- Workflow timelines exist for human-readable run output:
  - `tapps_agents/workflow/timeline.py` formats a Markdown timeline from workflow state.

### Integration Approach

- Treat `WorkflowLogger` as the canonical place to enforce correlation + redaction.
- Add trace context as an optional field on the workflow logger context.
- Prefer file-based metrics (already used) to keep monitoring lightweight and dependency-free.

### Risk Assessment

- **Risk**: Switching to JSON logs breaks existing log parsing expectations.
- **Mitigation**: Make structured output opt-in via config; preserve default console behavior.

### Rollback Plan

- Keep existing plain logging behavior; ship JSON formatting behind a config flag.

### Testing

- Use `pytest`.
- Focus on:
  - redaction correctness
  - correlation + trace fields present
  - metrics file writes remain readable

## Change Log

| Date       | Version | Description                                 | Author      |
| ---------- | ------- | ------------------------------------------- | ----------- |
| 2025-12-15 | 0.1     | Initial draft for Epic 7.3                  | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
