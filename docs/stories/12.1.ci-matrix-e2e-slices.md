# Story 12.1: CI Matrix for E2E Slices

<!-- Source: implementation/cursor/EPIC_12_E2E_CI_CD_Execution.md -->
<!-- Context: Add CI jobs for smoke/workflow/scenario/real suites using marker expressions with strict marker registration and deterministic env setup -->

## Status

Draft

## Story

**As a** CI/CD engineer and developer,
**I want** a CI pipeline matrix that runs E2E test slices (smoke/workflow/scenario/real) using marker expressions with strict marker registration and deterministic environment setup,
**so that** E2E tests are integrated into CI/CD with appropriate execution contexts (PR, main branch, scheduled runs) and fast PR gating.

## Acceptance Criteria

1. CI pipeline matrix exists with the following execution contexts:
   - **PR checks**: unit + e2e_smoke (fast, deterministic, no external services)
   - **Main branch**: unit + integration (mocked) + e2e_workflow (mocked)
   - **Nightly/scheduled**: e2e_scenario + real-service suites (requires credentials)
2. CI jobs use marker expressions to select test slices:
   - PR job: `pytest -m "unit or e2e_smoke"`
   - Main branch job: `pytest -m "unit or integration or (e2e_workflow and not requires_llm)"`
   - Nightly job: `pytest -m "e2e_scenario or (e2e_workflow and requires_llm)"`
3. Strict marker registration is enforced:
   - All markers are registered in `pytest.ini`
   - `--strict-markers` is enabled in CI
   - Marker expressions are validated before test execution
4. Deterministic environment setup:
   - Python version is pinned (e.g., 3.13)
   - Dependencies are installed deterministically (requirements.txt or pyproject.toml)
   - Environment variables are set consistently
   - No external service dependencies for PR/main jobs (except nightly)
5. CI jobs are organized in GitHub Actions workflow (or equivalent):
   - Separate jobs for PR, main branch, and nightly
   - Job dependencies and conditions are clear
   - Job timeouts are set appropriately
6. PR checks remain fast:
   - PR job runs only unit + e2e_smoke (deterministic, no external services)
   - PR job completes in reasonable time (< 10 minutes)
   - PR job does not require credentials or external services
7. Main branch job includes integration and workflow E2E:
   - Runs unit tests
   - Runs integration tests (mocked)
   - Runs workflow E2E tests (mocked, no real LLM)
   - Completes in reasonable time (< 30 minutes)
8. Nightly job runs scenario and real-service suites:
   - Runs scenario E2E tests
   - Runs workflow E2E tests with real services (if credentials available)
   - Skips cleanly if credentials are missing (skip, don't fail)
   - Runs on schedule (nightly) or manual trigger
9. CI configuration is documented:
   - Execution matrix is documented
   - Marker expressions are documented
   - Job conditions and triggers are documented
   - How to run each slice locally is documented
10. CI configuration is tested:
    - PR job is tested (runs on PR)
    - Main branch job is tested (runs on main branch push)
    - Nightly job is tested (manual trigger or scheduled run)

## Tasks / Subtasks

- [ ] Task 1: Update pytest.ini marker registration (AC: 3)
  - [ ] Verify all E2E markers are registered (e2e_smoke, e2e_workflow, e2e_scenario, e2e_cli)
  - [ ] Verify `--strict-markers` is enabled
  - [ ] Test marker registration with `pytest --markers`
  - [ ] Document marker taxonomy

- [ ] Task 2: Create PR check job (AC: 1, 2, 4, 6)
  - [ ] Update `.github/workflows/ci.yml` (or create new workflow)
  - [ ] Add PR job that runs `pytest -m "unit or e2e_smoke"`
  - [ ] Set job timeout (e.g., 10 minutes)
  - [ ] Ensure no external service dependencies
  - [ ] Test PR job execution

- [ ] Task 3: Create main branch job (AC: 1, 2, 4, 7)
  - [ ] Add main branch job to CI workflow
  - [ ] Job runs `pytest -m "unit or integration or (e2e_workflow and not requires_llm)"`
  - [ ] Set job timeout (e.g., 30 minutes)
  - [ ] Ensure mocked mode (no real LLM)
  - [ ] Test main branch job execution

- [ ] Task 4: Create nightly/scheduled job (AC: 1, 2, 4, 8)
  - [ ] Add nightly job to CI workflow
  - [ ] Configure schedule trigger (nightly, e.g., 2 AM UTC)
  - [ ] Configure manual trigger (workflow_dispatch)
  - [ ] Job runs `pytest -m "e2e_scenario or (e2e_workflow and requires_llm)"`
  - [ ] Add credential presence gates (skip if missing, don't fail)
  - [ ] Set job timeout (e.g., 60 minutes)
  - [ ] Test nightly job execution (manual trigger)

- [ ] Task 5: Implement deterministic environment setup (AC: 4)
  - [ ] Pin Python version in CI (e.g., 3.13)
  - [ ] Use deterministic dependency installation (requirements.txt or pyproject.toml)
  - [ ] Set consistent environment variables
  - [ ] Document environment setup
  - [ ] Test environment consistency

- [ ] Task 6: Organize CI jobs and dependencies (AC: 5)
  - [ ] Structure jobs with clear names and descriptions
  - [ ] Set job dependencies (if needed)
  - [ ] Set job conditions (when to run)
  - [ ] Set appropriate timeouts for each job
  - [ ] Add job status badges (if applicable)

- [ ] Task 7: Add credential handling for nightly job (AC: 8)
  - [ ] Add credential presence checks
  - [ ] Skip tests cleanly if credentials missing
  - [ ] Document required credentials
  - [ ] Add credential setup instructions
  - [ ] Test credential gate behavior

- [ ] Task 8: Documentation and testing (AC: 9, 10)
  - [ ] Document CI execution matrix in `.github/workflows/README.md` or `docs/CI.md`
  - [ ] Document marker expressions for each job
  - [ ] Document job conditions and triggers
  - [ ] Document how to run each slice locally
  - [ ] Test PR job (create test PR)
  - [ ] Test main branch job (push to main)
  - [ ] Test nightly job (manual trigger)

## Dev Notes

### Existing System Context

- Current CI configuration:
  - `.github/workflows/ci.yml` - main CI workflow (lint, type-check, test)
  - `.github/workflows/test.yml` - test workflow
  - Current test job runs: `pytest -q --cov=tapps_agents`
- Pytest configuration:
  - `pytest.ini` - pytest configuration with markers
  - Current default: `-m unit` (unit tests only)
  - Markers: `unit`, `integration`, `e2e`, `e2e_smoke`, `e2e_workflow`, `e2e_scenario`, `e2e_cli`, `requires_llm`, `requires_context7`
- Real tests documentation:
  - `tests/integration/README_REAL_TESTS.md` - real integration test guidance
  - Tests skip cleanly if services unavailable
- E2E foundation (from Epic 8):
  - E2E test structure in `tests/e2e/`
  - E2E markers defined in `pytest.ini`

### Integration Approach

- Extend existing `.github/workflows/ci.yml` or create new workflow
- Build on existing pytest marker system
- Reuse existing test job patterns
- Follow existing real-tests documentation patterns
- Integrate with E2E test structure from Epics 8-11

### Technology Research

- Use GitHub Actions for CI (already in use)
- Use `pytest` with marker expressions
- Use `pytest-xdist` for parallel execution (if needed)
- Use `pytest-html` or `pytest-junit` for reporting (if needed)
- Use GitHub Actions scheduled triggers for nightly jobs

### Risk Assessment

- **Primary risk**: CI becomes slow or expensive
- **Mitigation**: Keep PR checks fast (unit + e2e_smoke only); move real suites to scheduled jobs; add strict timeouts
- **Rollback plan**: Can disable nightly jobs or reduce scope; PR/main jobs remain fast

### Testing

- Test file location: `.github/workflows/ci.yml` (or new workflow file)
- Test standards: Test CI jobs in actual CI environment
- Testing frameworks: GitHub Actions
- Specific requirements:
  - Test PR job execution (create test PR)
  - Test main branch job execution (push to main)
  - Test nightly job execution (manual trigger)
  - Verify marker expressions work correctly
  - Verify timeouts are appropriate
  - Verify credential gates work correctly

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 12.1       | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

_TBD_

## QA Results

_TBD_
