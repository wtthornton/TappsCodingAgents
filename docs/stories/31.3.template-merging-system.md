# Story 31.3: Template Merging System

<!-- Source: implementation/EPIC_03_Dynamic_Tech_Stack_Templates.md -->

## Status

**Ready for Review**

## Story

**As a** framework user,
**I want** stack templates to merge correctly with default configuration,
**so that** I get stack-specific settings while preserving default behavior where appropriate.

## Acceptance Criteria

1. Template merge logic merges stack template with default config
2. Nested configuration merging works correctly (deep merge)
3. Template variable expansion works ({{project.name}}, etc.)
4. User overrides are preserved (user config takes precedence)
5. Merge logic handles conflicts correctly
6. Merge process is documented

## Tasks / Subtasks

- [x] Task 1: Implement merge logic (AC: 1)
  - [x] Create merge function
  - [x] Merge stack template + default config
  - [x] Stack template overrides defaults
  - [x] Defaults fill in missing values

- [x] Task 2: Deep merge (AC: 2)
  - [x] Handle nested dictionaries
  - [x] Handle nested lists (append or replace)
  - [x] Preserve nested structure

- [x] Task 3: Variable expansion (AC: 3)
  - [x] Support {{project.name}} variables
  - [x] Support {{tech_stack.frameworks}} variables
  - [x] Expand variables in template
  - [x] Handle missing variables

- [x] Task 4: Preserve overrides (AC: 4)
  - [x] User config loaded after template
  - [x] User config overrides template
  - [x] User config overrides defaults

- [x] Task 5: Handle conflicts (AC: 5)
  - [x] Define conflict resolution rules
  - [x] Log conflicts
  - [x] Apply resolution

- [x] Task 6: Document merge (AC: 6)
  - [x] Document merge order
  - [x] Document precedence rules
  - [x] Document variable expansion

## Dev Notes

### Existing System Context

- Config merging exists in other parts of system
- YAML parsing available
- Template system patterns exist

### Integration Approach

- Create template merger module
- Use deep merge utilities
- Support variable expansion
- Follow existing merge patterns

### Risk Assessment

- **Primary risk**: Merge may overwrite user config
  - **Mitigation**: User config takes precedence, clear merge order

### Rollback Plan

- Remove template merging
- Manual config
- No breaking changes

### Testing

- Test merge with various configs
- Test deep merge
- Test variable expansion
- Test user override precedence
- Test conflict resolution

## Change Log

| Date       | Version | Description                     | Author      |
| ---------- | ------- | ------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 31.3     | bmad-master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

N/A - No errors encountered

### Completion Notes List

- Created `tapps_agents/core/template_merger.py` module with comprehensive merging logic
- Implemented deep merge for nested dictionaries (recursive merging, lists replaced by override)
- Implemented variable expansion with {{variable.name}} syntax, supporting nested paths (e.g., {{project.name}}, {{tech_stack.frameworks}})
- Implemented merge precedence: default config < template < user config (user config has highest priority)
- Variable expansion handles missing variables gracefully (returns original {{var}} if not found)
- Added comprehensive error handling for missing template files and invalid YAML
- All functions have type hints and docstrings with examples

### File List

- `tapps_agents/core/template_merger.py` (new)

## QA Results

_TBD_

