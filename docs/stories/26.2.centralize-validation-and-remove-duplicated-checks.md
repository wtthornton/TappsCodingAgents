# Story 26.2: Centralize validation and remove duplicated checks

<!-- Source: implementation/cursor/EPIC_26_Core_Maintainability_Unify_Errors_And_Validation.md -->
<!-- Context: Create a single authoritative validation API for path/file operations and ensure all agents use it -->

## Status

**Deferred** - Code maintenance item, lower priority

## Story

**As a** maintainer and security reviewer,  
**I want** a centralized, reusable validation API for path/file operations used consistently across all agents,  
**so that** security-critical enforcement is correct, non-duplicated, and easier to test and audit.

## Acceptance Criteria

1. A single shared validation module/API exists for common path/file validation (read/write boundaries, traversal prevention, allowed roots, etc.).
2. `BaseAgent` and all agents that perform file operations use the centralized API (directly or via thin wrappers).
3. Agent-specific ad-hoc validation logic (duplicate traversal checks, substring checks, etc.) is removed or reduced to minimal wrappers around the centralized implementation.
4. Validation failures return consistent, structured errors suitable for mapping into error envelopes and CLI exit codes (align with Story 26.3).

## Tasks / Subtasks

- [ ] Task 1: Inventory current validation patterns and duplicates (AC: 1, 3)
  - [ ] Review `tapps_agents/core/agent_base.py` for existing validation entry points
  - [ ] Catalog agent-specific checks in `tapps_agents/agents/*` (path traversal, allowlists, root checks)
  - [ ] Identify tests that currently depend on agent-local behavior

- [ ] Task 2: Design and implement the centralized validation API (AC: 1, 4)
  - [ ] Define minimal functions (e.g., `validate_read_path(...)`, `validate_write_path(...)`, `ensure_within_roots(...)`)
  - [ ] Ensure path resolution is safe and cross-platform (Windows included)
  - [ ] Return typed/structured exceptions suitable for envelope mapping

- [ ] Task 3: Adopt the API across BaseAgent and agents (AC: 2, 3)
  - [ ] Refactor `BaseAgent` to call the centralized API
  - [ ] Replace agent-specific checks with centralized calls
  - [ ] Ensure behavior remains consistent with existing expectations (no feature scope changes)

- [ ] Task 4: Document and lock behavior via tests (AC: 1–4)
  - [ ] Add/extend tests for centralized validation behavior (symlinks where applicable; traversal; absolute escapes)
  - [ ] Add a “usage enforcement” test to ensure agents do not reintroduce bespoke validation (or link to Story 26.4)

## Dev Notes

### Existing System Context

- Multiple agents implement overlapping validation patterns for filesystem operations.
- Security-relevant path enforcement is an audit hotspot and should have a single “source of truth”.

### Integration Approach

- Prefer colocating the validation API under `tapps_agents/core/` so it is easily shared by `BaseAgent` and individual agents.
- Align behavior with security policy stories (see Epic 24) to avoid divergence.

### Risk Assessment

- **Risk**: Centralization changes edge-case behavior (especially Windows path normalization) and breaks workflows.
- **Mitigation**: Add regression tests first; adopt incrementally agent-by-agent; provide clear error messages.

### Rollback Plan

- Revert agent migrations to the centralized API while keeping the new validation module available for later adoption.

### Testing

- Unit tests for validation primitives; integration coverage ensuring representative agents use the shared API.

## Change Log

| Date       | Version | Description                         | Author      |
| ---------- | ------- | ----------------------------------- | ----------- |
| 2025-12-16 | 0.1     | Initial draft for Epic 26.2         | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_


