# Story 17.3: Test Real Cache Behavior

<!-- Source: implementation/cursor/EPIC_17_Unit_Test_Mock_Reduction.md -->
<!-- Context: Replace mocked cache dependencies with real cache instances to validate actual cache behavior -->

## Status

Completed (2025-01-15)

## Story

**As a** developer,
**I want** cache tests to use real cache instances instead of mocks,
**so that** we validate actual cache hit/miss behavior, storage, retrieval, invalidation, and cleanup operations.

## Acceptance Criteria

1. Mocked cache dependencies in tests are replaced with real cache instances (UnifiedCache, KBCache).
2. Actual cache hit/miss behavior is tested (not just that methods were called).
3. Cache storage and retrieval operations are validated with real cache instances.
4. Cache invalidation and cleanup are tested with real cache behavior.
5. Test fixtures are used for cache isolation (separate cache directories per test).
6. Test execution time remains reasonable (use fast in-memory or file-based caches for tests).

## Tasks / Subtasks

- [ ] Task 1: Analyze current cache test mocking (AC: 1)
  - [ ] Review cache-related test files for mock usage
  - [ ] Identify which tests mock cache dependencies
  - [ ] Identify cache types: UnifiedCache, KBCache, etc.

- [ ] Task 2: Create test fixtures for real cache instances (AC: 1, 5)
  - [ ] Create pytest fixtures for UnifiedCache with test directories
  - [ ] Create pytest fixtures for KBCache with test directories
  - [ ] Ensure cache isolation per test (separate directories)

- [ ] Task 3: Replace mocked UnifiedCache with real instances (AC: 1, 2, 3)
  - [ ] Update tests in `tests/unit/test_unified_cache.py` to use real instances
  - [ ] Test actual cache hit/miss behavior
  - [ ] Test cache storage and retrieval with real operations
  - [ ] Validate cache keys, values, and metadata

- [ ] Task 4: Replace mocked KBCache with real instances (AC: 1, 2, 3)
  - [ ] Update tests in `tests/unit/context7/test_kb_cache.py` to use real instances
  - [ ] Test actual KB cache hit/miss behavior
  - [ ] Test KB cache storage and retrieval
  - [ ] Validate KB cache structure and content

- [ ] Task 5: Test cache invalidation and cleanup (AC: 4)
  - [ ] Test cache invalidation with real cache instances
  - [ ] Test cache cleanup operations
  - [ ] Test cache expiration and staleness
  - [ ] Validate cache directory cleanup

- [ ] Task 6: Test cache behavior in agent tests (AC: 1, 2, 3)
  - [ ] Update agent tests that mock cache to use real cache instances
  - [ ] Test agent cache interactions with real behavior
  - [ ] Validate cache usage in agent workflows

- [ ] Task 7: Ensure test isolation and performance (AC: 5, 6)
  - [ ] Use test fixtures for cache isolation (separate directories)
  - [ ] Clean up test cache directories after tests
  - [ ] Ensure tests don't affect each other
  - [ ] Use fast cache backends for tests (file-based or in-memory)

## Dev Notes

### Existing System Context

- UnifiedCache exists in `tapps_agents/core/cache.py`:
  - Provides unified caching interface
  - Supports multiple cache backends
  - Current tests may mock cache dependencies
- KBCache exists in `tapps_agents/context7/kb_cache.py`:
  - Provides Context7 knowledge base caching
  - Stores library documentation
  - Current tests may mock KB cache
- Current test files:
  - `tests/unit/test_unified_cache.py` - UnifiedCache tests
  - `tests/unit/context7/test_kb_cache.py` - KB cache tests
  - `tests/unit/test_cache_router.py` - Cache router tests
  - Agent tests that mock cache dependencies
- Test infrastructure:
  - Uses pytest with fixtures
  - Has test data and fixtures in `tests/conftest.py`
  - Uses `unittest.mock` for cache mocking

### Integration Approach

- Replace mocks with real cache instances using test fixtures
- Use test directories for cache isolation (separate `.tapps-agents/cache/` per test)
- Test actual cache operations: get, set, delete, invalidate, cleanup
- Validate cache behavior: hit/miss, storage, retrieval, expiration
- Use fast cache backends for tests (file-based or in-memory, not network-based)

### Risk Assessment

- **Risk**: Real cache instances may slow down tests
- **Mitigation**: Use fast in-memory or file-based caches, clean up after tests
- **Risk**: Cache tests may affect each other
- **Mitigation**: Use test fixtures for cache isolation (separate directories)
- **Risk**: Cache directory cleanup may fail
- **Mitigation**: Use pytest fixtures with proper cleanup, handle cleanup errors gracefully

### Rollback Plan

- Can revert to mocks if real cache instances cause issues
- Keep existing mocked tests as backup (rename or move to separate file)
- No impact on production code

### Testing

- Test file locations: `tests/unit/test_unified_cache.py`, `tests/unit/context7/test_kb_cache.py`, agent test files
- Test standards: pytest, fixtures for cache isolation, real cache instances
- Testing frameworks: pytest, real cache implementations
- Specific requirements:
  - Use pytest fixtures for cache setup and cleanup
  - Ensure cache isolation through separate test directories
  - Validate real cache behavior: hit/miss, storage, retrieval, invalidation
  - Test cache cleanup and directory management

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-01-15 | 0.1     | Initial draft for Epic 17.3       | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_

