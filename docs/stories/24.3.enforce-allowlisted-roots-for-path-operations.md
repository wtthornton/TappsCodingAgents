# Story 24.3: Enforce Allowlisted Roots for Path Operations

<!-- Source: implementation/cursor/EPIC_24_Security_Policy_Reality_And_Path_Enforcement.md -->
<!-- Context: Strengthen path validation by verifying resolved paths remain within allowed roots -->

## Status

Draft

## Story

**As a** maintainer and security reviewer,  
**I want** agent filesystem operations to enforce allowlisted roots using resolved paths (not just string heuristics),  
**so that** traversal and out-of-bounds access are blocked consistently and safely across the codebase.

## Acceptance Criteria

1. Path operations verify **resolved paths** (absolute + normalized) are within configured **allowed roots** for the relevant operation (read/write as applicable).
2. Worktree/state/report paths cannot escape `.tapps-agents/` even with hostile input (e.g., `..`, encoded variants, absolute paths).
3. Agent-specific duplicate path checks are removed (or reduced) in favor of a centralized validation implementation.
4. Error messages for blocked paths are clear and actionable (e.g., what root was expected / how to configure allowed roots).

## Tasks / Subtasks

- [ ] Task 1: Identify and centralize the path validation entry points (AC: 1, 3)
  - [ ] Review existing validation in `tapps_agents/core/agent_base.py`
  - [ ] Locate agent-specific path checks in `tapps_agents/agents/*` and catalog duplicates
  - [ ] Determine the minimal centralized API for “validate read path” and “validate write path”

- [ ] Task 2: Implement allowlisted-root enforcement using resolved paths (AC: 1–2, 4)
  - [ ] Resolve candidate paths safely before comparison (absolute/normalized)
  - [ ] Verify “is within allowed root” using path-aware checks (not substring checks)
  - [ ] Ensure `.tapps-agents/` containment for state/worktree/artifact paths
  - [ ] Provide clear, structured errors for violations

- [ ] Task 3: Remove duplicate checks and adopt centralized validation (AC: 3)
  - [ ] Replace agent-specific logic with centralized calls
  - [ ] Ensure all affected agents continue to function for in-project paths

- [ ] Task 4: Add warn-first mode if required by rollout risk (optional, per Epic risk mitigation)
  - [ ] If a staged rollout is needed, implement warning-only behavior behind an explicit setting
  - [ ] Document behavior and timeline for hard enforcement

## Dev Notes

### Existing System Context

- Path validation exists in `tapps_agents/core/agent_base.py` plus agent-specific checks.
- Worktrees/state/artifacts under `.tapps-agents/` are security-sensitive boundaries.

### Integration Approach

- Align implementation with the policy defined in Story 24.2.
- Prefer one centralized “source of truth” function(s) used by all agents.

### Risk Assessment

- **Risk**: Over-restricting file operations breaks legitimate workflows (especially on Windows path edge cases).
- **Mitigation**: Provide actionable errors; consider warn-first mode; add regression tests before tightening.

### Rollback Plan

- Revert hard enforcement to warn-only while keeping centralized validation and docs alignment.

### Testing

- Covered by Story 24.4: traversal attempts, absolute escapes, and symlink edge cases where supported.

## Change Log

| Date       | Version | Description                     | Author      |
| ---------- | ------- | ------------------------------- | ----------- |
| 2025-12-16 | 0.1     | Initial draft for Epic 24.3     | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_


