# Story 1.4: YAML Workflow Parser

<!-- Source: implementation/cursor/EPIC_01_Foundation.md -->
<!-- Context: Brownfield enhancement to workflow parsing/validation -->

## Status

Draft

## Story

**As a** workflow author,
**I want** YAML workflows to be parsed and validated with clear errors,
**so that** invalid workflows fail fast and dependency references are correct before execution starts.

## Acceptance Criteria

1. Workflow parsing continues to load workflows from `workflows/*.y{a,}ml` using `WorkflowParser`.
2. Parser validates required workflow-level fields and step-level fields and raises actionable errors (including file and step id context).
3. Parser validates references that are currently used by the executor (e.g., `next`, `requires`, `creates`, `consults`) are well-formed types.
4. Workflow `type` values are restricted to known values (`greenfield`, `brownfield`, `hybrid`) and default behavior is explicit.
5. Existing preset workflows remain parseable without modification.

## Tasks / Subtasks

- [ ] Task 1: Audit current parsing behavior (AC: 1, 5)
  - [ ] Review `tapps_agents/workflow/parser.py`
  - [ ] Run parser against `workflows/` presets (unit tests)

- [ ] Task 2: Add validation with good error messages (AC: 2–4)
  - [ ] Improve workflow-level validation (id/name/version/type/settings)
  - [ ] Improve step-level validation beyond “must have id, agent, action”
  - [ ] Ensure exceptions include filename and step id where applicable

- [ ] Task 3: Tests (AC: 2, 5)
  - [ ] Add unit tests for invalid workflows (missing fields, wrong types)
  - [ ] Add regression tests that all shipped workflows parse successfully

## Dev Notes

### Existing System Context

- Parsing is implemented in `tapps_agents/workflow/parser.py` and uses `yaml.safe_load`.
- Workflow models are dataclasses in `tapps_agents/workflow/models.py`.
- Orchestrator lists workflows and parses them in `tapps_agents/agents/orchestrator/agent.py`.

### Integration Approach

- Keep YAML parsing dependency minimal; enhance validation logic in the parser layer.

### Risk Assessment

- **Primary risk**: tightening validation breaks existing workflows
- **Mitigation**: add regression tests for existing `workflows/` presets; stage new validations behind precise, compatible rules.

### Rollback Plan

- Revert validation changes while keeping tests that document expected workflow format.

### Testing

- Use `pytest`.

## Change Log

| Date       | Version | Description                | Author      |
| ---------- | ------- | -------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 1.4 | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
