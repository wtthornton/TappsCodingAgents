# Story 17.4: Add Component Integration Tests

<!-- Source: implementation/cursor/EPIC_17_Unit_Test_Mock_Reduction.md -->
<!-- Context: Test CLI and workflow executor with real component behavior, not fully mocked -->

## Status

Completed (2025-01-15)

## Story

**As a** developer,
**I want** integration tests that validate component interactions with real implementations,
**so that** we catch integration issues and validate that components work together correctly end-to-end.

## Acceptance Criteria

1. CLI tests use real agent instances (not fully mocked) where feasible.
2. Workflow executor tests use real expert registry behavior (not fully mocked).
3. Component interactions are validated end-to-end (CLI → agents → workflow executor → experts).
4. Error propagation across components is tested (errors from one component propagate correctly to others).
5. Test execution time remains reasonable (use fakes for slow operations, mark slow tests appropriately).
6. Tests remain isolated and don't affect each other (use test data isolation).

## Tasks / Subtasks

- [ ] Task 1: Analyze current CLI test mocking (AC: 1)
  - [ ] Review CLI test files for mock usage
  - [ ] Identify which components can use real implementations
  - [ ] Identify which components need fakes vs real implementations

- [ ] Task 2: Update CLI tests to use real agent instances (AC: 1, 3)
  - [ ] Update CLI tests to use real agent instances where feasible
  - [ ] Test CLI → agent interactions with real behavior
  - [ ] Validate CLI command processing with real agents
  - [ ] Test CLI error handling with real agent errors

- [ ] Task 3: Analyze current workflow executor test mocking (AC: 2)
  - [ ] Review workflow executor test files for mock usage
  - [ ] Identify which dependencies can use real implementations
  - [ ] Identify expert registry mocking patterns

- [ ] Task 4: Update workflow executor tests to use real expert registry (AC: 2, 3)
  - [ ] Update workflow executor tests to use real expert registry behavior
  - [ ] Test workflow executor → expert registry interactions
  - [ ] Validate expert consultation with real behavior
  - [ ] Test workflow execution with real expert system

- [ ] Task 5: Add end-to-end component integration tests (AC: 3)
  - [ ] Create integration tests for CLI → agents → workflow executor
  - [ ] Test component interactions end-to-end
  - [ ] Validate data flow through components
  - [ ] Test workflow execution with real components

- [ ] Task 6: Test error propagation across components (AC: 4)
  - [ ] Test errors from agents propagate to CLI correctly
  - [ ] Test errors from expert registry propagate to workflow executor correctly
  - [ ] Test errors from workflow executor propagate correctly
  - [ ] Validate error handling and reporting across components

- [ ] Task 7: Create fakes for slow operations (AC: 5)
  - [ ] Create fake implementations for slow operations (LLM calls, network)
  - [ ] Use fakes instead of mocks for complex dependencies
  - [ ] Mark slow integration tests appropriately (pytest markers)

- [ ] Task 8: Ensure test isolation (AC: 6)
  - [ ] Use test data isolation instead of mocks
  - [ ] Ensure tests don't affect each other
  - [ ] Use fixtures for test setup and cleanup

## Dev Notes

### Existing System Context

- CLI exists in `tapps_agents/cli.py`:
  - Routes commands to agents
  - Uses workflow executor for workflows
  - Current tests may heavily mock agents and workflow executor
- Workflow executor exists in `tapps_agents/workflow/executor.py`:
  - Executes YAML workflows
  - Uses expert registry for expert consultation
  - Uses agents for task execution
  - Current tests may heavily mock expert registry and agents
- Expert registry exists in `tapps_agents/experts/`:
  - Provides expert consultation via RAG system
  - Can be used with real implementations
- Current test files:
  - CLI tests (may be in `tests/unit/test_cli.py` or similar)
  - Workflow executor tests (may be in `tests/unit/workflow/test_executor.py` or similar)
  - Integration tests (may be in `tests/integration/`)
- Test infrastructure:
  - Uses pytest with fixtures
  - Has test data and fixtures in `tests/conftest.py`
  - Uses `unittest.mock` extensively

### Integration Approach

- Replace mocks with real implementations where feasible (agents, expert registry)
- Use fakes for slow operations (LLM calls, network requests)
- Test component interactions end-to-end: CLI → agents → workflow executor → experts
- Use test data isolation: different test files, worktrees, cache directories
- Keep integration tests separate from unit tests (use pytest markers)
- Create reusable fixtures for component setup

### Risk Assessment

- **Risk**: Real implementations may require external dependencies or slow down tests
- **Mitigation**: Use fakes for slow operations, test fixtures for external dependencies, mark slow tests
- **Risk**: Integration tests may be flaky
- **Mitigation**: Use deterministic fakes, proper test isolation, handle cleanup
- **Risk**: Tests may become more complex
- **Mitigation**: Create reusable fixtures and helper functions

### Rollback Plan

- Can revert to mocks if real implementations cause issues
- Keep existing mocked tests as backup (rename or move to separate file)
- No impact on production code

### Testing

- Test file locations: CLI tests, workflow executor tests, integration test files
- Test standards: pytest, fixtures for isolation, real implementations where feasible
- Testing frameworks: pytest, fakes for slow operations
- Specific requirements:
  - Use pytest markers for slow integration tests
  - Ensure test isolation through fixtures and test data
  - Validate component interactions end-to-end
  - Test error propagation across components
  - Use fakes for slow operations, not mocks

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-01-15 | 0.1     | Initial draft for Epic 17.4       | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_

