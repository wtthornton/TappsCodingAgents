# Story 7.7: Workflow Executor Integration

<!-- Source: implementation/EPIC_07_Background_Agent_Auto_Execution.md -->

## Status

**âœ… Completed**

**Last Updated:** 2025-01-27

## Story

**As a** workflow executor,
**I want** to integrate Background Agent auto-execution with the existing workflow execution system,
**so that** workflows can automatically progress through steps without manual intervention.

## Acceptance Criteria

1. Auto-execution system integrated with `CursorWorkflowExecutor`
2. Workflow executor uses Background Agent auto-execution when enabled via configuration
3. Configuration option added to enable/disable auto-execution per workflow or globally
4. Polling integration implemented for completion detection
5. Workflow state synchronized with Background Agent execution status
6. Backward compatibility maintained with manual execution mode

## Tasks / Subtasks

- [x] Task 1: Integrate auto-execution with CursorWorkflowExecutor (AC: 1)
  - [x] Add auto-execution flag to executor initialization
  - [x] Modify step execution to use auto-execution when enabled
  - [x] Create auto-execution handler class
  - [x] Integrate with existing command file generation
  - [x] Test integration with workflow execution flow

- [x] Task 2: Add configuration support (AC: 2, 3)
  - [x] Add `auto_execution_enabled` flag to workflow executor config
  - [x] Support per-workflow and global configuration
  - [x] Read configuration from project config or workflow definition
  - [x] Add configuration validation
  - [x] Document configuration options

- [x] Task 3: Implement polling integration (AC: 4)
  - [x] Create polling mechanism for status file checking
  - [x] Integrate polling with workflow step execution
  - [x] Add configurable polling interval
  - [x] Implement timeout handling
  - [x] Add polling status logging

- [x] Task 4: Synchronize workflow state (AC: 5)
  - [x] Update workflow state when Background Agent execution starts
  - [x] Update workflow state when execution completes
  - [x] Handle execution failures in workflow state
  - [x] Persist state changes to state manager
  - [x] Test state synchronization

- [x] Task 5: Maintain backward compatibility (AC: 6)
  - [x] Ensure manual execution mode still works
  - [x] Test workflows with auto-execution disabled
  - [x] Verify no breaking changes to existing workflows
  - [x] Add feature flag to enable/disable auto-execution
  - [x] Document migration path from manual to auto-execution

## Dev Notes

### Existing System Context

- Workflow executor: `tapps_agents/workflow/cursor_executor.py` - `CursorWorkflowExecutor` class
- Command file generation: `tapps_agents/workflow/cursor_skill_helper.py` - `create_skill_command_file()`
- State management: `tapps_agents/workflow/state_manager.py` - `AdvancedStateManager`
- Workflow state model: `tapps_agents/workflow/models.py` - `WorkflowState`, `StepExecution`
- Configuration: `tapps_agents/core/config.py` - `ProjectConfig`
- Worktree management: `tapps_agents/workflow/worktree_manager.py` - `WorktreeManager`

### Integration Approach

- Modify `CursorWorkflowExecutor` to check for auto-execution configuration
- Create `BackgroundAgentAutoExecutor` class to handle auto-execution logic
- Integrate with existing `create_skill_command_file()` function
- Use existing state manager for state synchronization
- Add polling mechanism that checks status files
- Maintain existing manual execution path as fallback

### Technical Details

**Integration Points:**
- `CursorWorkflowExecutor.execute_step()` - Add auto-execution check before manual execution
- `CursorWorkflowExecutor._execute_skill()` - Route to auto-execution or manual execution
- Status file location: `{worktree_path}/.cursor-skill-status.json`
- Polling interval: Configurable (default: 5 seconds)
- Timeout: Configurable (default: 3600 seconds per step)

**New Components:**
- `tapps_agents/workflow/background_auto_executor.py` - `BackgroundAgentAutoExecutor` class
- Methods: `execute_command()`, `poll_for_completion()`, `check_status()`, `handle_completion()`

**Configuration:**
- Add to `ProjectConfig`: `auto_execution_enabled: bool = False`
- Add to workflow YAML: `auto_execution: true/false` (optional, inherits from global)

### Risk Assessment

- **Primary risk**: Integration may break existing workflow execution
  - **Mitigation**: Feature flag, extensive testing, backward compatibility checks
- **Primary risk**: Polling may be inefficient or miss state changes
  - **Mitigation**: Configurable intervals, status file locking, comprehensive logging

### Rollback Plan

- Disable auto-execution via configuration flag
- Fall back to manual execution mode
- No changes to core workflow execution logic (only additions)

### Testing

- Unit tests for auto-execution integration
- Integration tests for workflow executor with auto-execution enabled
- Integration tests for workflow executor with auto-execution disabled (backward compatibility)
- Test polling mechanism with various scenarios
- Test state synchronization
- End-to-end test: Complete workflow with auto-execution

## Change Log

| Date       | Version | Description                     | Author      |
| ---------- | ------- | ------------------------------- | ----------- |
| 2025-01-27 | 0.1     | Initial draft for Epic 7.7     | bmad-master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Completion Notes

- Created `BackgroundAgentAutoExecutor` class in `tapps_agents/workflow/background_auto_executor.py`
- Added `WorkflowConfig` to `ProjectConfig` with `auto_execution_enabled`, `polling_interval`, and `timeout_seconds`
- Integrated auto-execution with `CursorWorkflowExecutor`:
  - Auto-execution enabled via global config or per-workflow metadata
  - Falls back to manual execution mode when disabled (backward compatible)
  - Uses status file polling (`.cursor-skill-status.json`) with artifact detection fallback
- State synchronization handled automatically through existing step execution tracking
- All acceptance criteria met

### File List

- `tapps_agents/workflow/background_auto_executor.py` (new)
- `tapps_agents/workflow/cursor_executor.py` (modified - integrated auto-execution)
- `tapps_agents/core/config.py` (modified - added WorkflowConfig)

## QA Results

_TBD_

