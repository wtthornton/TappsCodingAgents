# Story 8.2: Marker & Execution Matrix

<!-- Source: implementation/cursor/EPIC_08_E2E_Testing_Foundation.md -->
<!-- Context: Define marker taxonomy and execution matrix for E2E test slices -->

## Status

Complete

## Story

**As a** developer and CI/CD engineer,
**I want** a clear marker taxonomy and execution matrix for E2E test slices,
**so that** tests can be selectively run (smoke/workflow/scenario/CLI, mocked/real) in PR checks, main branch, and scheduled runs without requiring external services by default.

## Acceptance Criteria

1. New E2E markers are added to `pytest.ini`:
   - `e2e_smoke`: Fast, deterministic smoke tests (no external services)
   - `e2e_workflow`: Workflow execution E2E tests
   - `e2e_scenario`: User journey scenario tests
   - `e2e_cli`: CLI command E2E tests
   - `e2e_slow`: Tests that take longer than expected (can combine with other markers)
2. Marker taxonomy supports separation of mocked vs real services:
   - Existing `requires_llm` and `requires_context7` markers continue to work
   - E2E tests default to mocked mode unless explicitly marked with `requires_llm` or `requires_context7`
3. Execution matrix is documented and implemented:
   - **PR/CI default**: `pytest -m "unit or e2e_smoke"` (fast, no external services)
   - **Main branch**: `pytest -m "unit or integration or e2e_workflow"` (mocked by default)
   - **Nightly/scheduled**: `pytest -m "e2e_scenario or (e2e_workflow and requires_llm)"` (real services when available)
4. Documentation exists for running each slice locally:
   - How to run smoke E2E tests (no services required)
   - How to run workflow E2E tests (mocked vs real)
   - How to run scenario E2E tests (mocked vs real)
   - How to run CLI E2E tests
   - How to run with real services (requires credentials)
5. Default `pytest` execution remains unchanged (unit-only via `-m unit` in `pytest.ini`).
6. New markers are registered in `pytest.ini` and don't break `--strict-markers` configuration.
7. CI configuration examples are provided (GitHub Actions, GitLab CI, or generic YAML).

## Tasks / Subtasks

- [x] Task 1: Add E2E markers to pytest.ini (AC: 1, 6)
  - [x] Add `e2e_smoke` marker with description
  - [x] Add `e2e_workflow` marker with description
  - [x] Add `e2e_scenario` marker with description
  - [x] Add `e2e_cli` marker with description
  - [x] Add `e2e_slow` marker with description
  - [x] Verify `--strict-markers` still works with new markers
  - [x] Test marker registration with `pytest --markers`

- [x] Task 2: Document marker taxonomy and usage (AC: 2, 4)
  - [x] Document marker combinations (e.g., `e2e_workflow and requires_llm`)
  - [x] Document default behavior (mocked unless explicitly marked)
  - [x] Create `tests/e2e/README.md` with marker usage guide
  - [x] Document local execution commands for each slice
  - [x] Document how to run with real services

- [x] Task 3: Define and document execution matrix (AC: 3)
  - [x] Document PR/CI default execution (unit + e2e_smoke)
  - [x] Document main branch execution (unit + integration + e2e_workflow mocked)
  - [x] Document nightly execution (scenario + real services)
  - [x] Create execution matrix table in documentation

- [x] Task 4: Create CI configuration examples (AC: 7)
  - [x] Create example GitHub Actions workflow (or GitLab CI, or generic)
  - [x] Show PR check job (unit + e2e_smoke)
  - [x] Show main branch job (unit + integration + e2e_workflow)
  - [x] Show nightly job (scenario + real services with credential gates)
  - [x] Document credential handling (skip, don't fail)

- [x] Task 5: Verify default pytest behavior (AC: 5)
  - [x] Verify `pytest` (no args) still runs unit-only
  - [x] Verify `pytest -m unit` works as before
  - [x] Verify `pytest -m ""` runs all tests (including new E2E)
  - [x] Test marker expressions (e.g., `-m "unit or e2e_smoke"`)

- [x] Task 6: Update pytest collection hooks if needed (AC: 2)
  - [x] Review `pytest_collection_modifyitems` in `tests/conftest.py`
  - [x] Ensure E2E markers work with existing skip logic
  - [x] Ensure `requires_llm` and `requires_context7` continue to work with E2E markers

## Dev Notes

### Existing System Context

- Current markers in `pytest.ini`:
  - `unit`, `integration`, `e2e`, `slow`
  - `requires_ollama`, `requires_llm`, `requires_context7`
- Current default: `-m unit` in `pytest.ini` `addopts`
- Existing skip logic in `tests/conftest.py`:
  - `pytest_collection_modifyitems` automatically skips `requires_llm` and `requires_context7` tests if services unavailable
- Test structure:
  - `tests/unit/` - unit tests
  - `tests/integration/` - integration tests (some E2E-like)
  - `tests/e2e/` - new E2E suite (from Story 8.1)

### Integration Approach

- Extend existing marker system; don't replace
- Maintain backward compatibility with existing markers
- Build on existing skip logic in `pytest_collection_modifyitems`
- Keep default behavior unchanged (unit-only)

### Risk Assessment

- **Primary risk**: Marker conflicts or breaking existing test execution
- **Mitigation**: Test marker combinations thoroughly; maintain backward compatibility
- **Rollback plan**: Revert marker additions; existing tests continue to work

### Testing

- Test file location: `tests/unit/test_markers.py` (new file)
- Test standards: Use `pytest`, verify marker registration and execution
- Testing frameworks: `pytest` with marker introspection
- Specific requirements:
  - Test marker registration
  - Test marker combinations
  - Test default execution behavior
  - Test execution matrix commands

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 8.2        | bmad-master |

## Dev Agent Record

### Agent Model Used

Auto (Cursor AI)

### Debug Log References

N/A - Implementation completed successfully

### Completion Notes List

- All E2E markers added to `pytest.ini`: `e2e_smoke`, `e2e_workflow`, `e2e_scenario`, `e2e_cli`, `e2e_slow`, `template_type`
- Marker taxonomy documented in `tests/e2e/MARKER_TAXONOMY.md` with execution matrix
- CI configuration examples created in `tests/e2e/CI_EXAMPLES.md` (GitHub Actions, GitLab CI, generic YAML)
- Default pytest behavior verified: remains unit-only, E2E tests are opt-in
- All markers registered and compatible with `--strict-markers`
- Execution matrix documented: PR (unit + e2e_smoke), main branch (unit + integration + e2e_workflow), nightly (scenario + real)

### File List

- `pytest.ini` (updated with new markers)
- `tests/e2e/MARKER_TAXONOMY.md` (new)
- `tests/e2e/CI_EXAMPLES.md` (new)
- `tests/e2e/README.md` (updated with marker usage)

## QA Results

âœ… All acceptance criteria met. All tasks completed. Marker system fully functional and documented.
