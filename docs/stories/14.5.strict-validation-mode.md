# Story 14.5: Strict Validation Mode

<!-- Source: implementation/cursor/EPIC_14_E2E_Test_Reliability.md -->
<!-- Context: Add strict validation mode to validators that fails on first error, with relaxed mode opt-in for development -->

## Status

Draft

## Story

**As a** QA engineer and developer,
**I want** strict validation mode as the default for E2E tests that fails on the first error without fallback paths,
**so that** test failures are immediate and transparent, while still allowing relaxed mode for development and debugging when needed.

## Acceptance Criteria

1. Strict validation mode added to validators:
   - Fails on first error (doesn't collect errors and continue)
   - No fallback paths
   - No optional validations that can be skipped
2. Strict mode is the default for E2E tests
3. Relaxed mode available as opt-in for development/debugging:
   - Can be enabled via pytest marker or parameter
   - Collects all errors instead of failing on first
   - Still reports all errors (doesn't mask them)
4. Validators support both strict and relaxed modes:
   - `ScenarioValidator` supports mode parameter
   - `DependencyValidator` supports mode parameter (from Story 14.2)
   - Mode can be set per test or globally via fixture
5. Strict mode validation behavior:
   - Fails immediately on first validation error
   - Raises exception with clear error message
   - No error collection or accumulation
6. Relaxed mode validation behavior:
   - Collects all errors
   - Reports all errors at end (doesn't mask)
   - Still fails test if any errors found
7. Unit tests exist for both strict and relaxed validation modes

## Tasks / Subtasks

- [ ] Task 1: Add validation mode enum/constants (AC: 1, 4)
  - [ ] Create `ValidationMode` enum in `tests/e2e/fixtures/validation_modes.py` (or similar)
  - [ ] Define `STRICT` and `RELAXED` modes
  - [ ] Document mode behavior differences

- [ ] Task 2: Refactor ScenarioValidator to support modes (AC: 1, 4, 5)
  - [ ] Add `mode` parameter to `ScenarioValidator.__init__()`
  - [ ] Default mode is `ValidationMode.STRICT`
  - [ ] Implement strict mode: fail on first error, raise exception immediately
  - [ ] Implement relaxed mode: collect errors, fail at end if any errors

- [ ] Task 3: Refactor DependencyValidator to support modes (AC: 1, 4, 5)
  - [ ] Add `mode` parameter to dependency validation functions
  - [ ] Default mode is `ValidationMode.STRICT`
  - [ ] Implement strict mode: fail on first missing dependency
  - [ ] Implement relaxed mode: collect missing dependencies, fail at end

- [ ] Task 4: Make strict mode default for E2E tests (AC: 2)
  - [ ] Update E2E fixtures to use strict mode by default
  - [ ] Update scenario tests to use strict mode
  - [ ] Update workflow tests to use strict mode
  - [ ] Update smoke tests to use strict mode

- [ ] Task 5: Add relaxed mode opt-in mechanism (AC: 3)
  - [ ] Add `@pytest.mark.relaxed_validation` marker
  - [ ] Add fixture or parameter to enable relaxed mode
  - [ ] Update validators to check marker/parameter
  - [ ] Document relaxed mode usage

- [ ] Task 6: Implement strict mode behavior (AC: 5)
  - [ ] Fail immediately on first error (raise exception)
  - [ ] No error collection or accumulation
  - [ ] Clear error message with context
  - [ ] No fallback paths

- [ ] Task 7: Implement relaxed mode behavior (AC: 6)
  - [ ] Collect all errors instead of failing on first
  - [ ] Report all errors at end
  - [ ] Still fail test if any errors found
  - [ ] Format all errors clearly

- [ ] Task 8: Create unit tests (AC: 7)
  - [ ] Create `tests/unit/e2e/test_validation_modes.py`
  - [ ] Test strict mode fails on first error
  - [ ] Test strict mode doesn't collect errors
  - [ ] Test relaxed mode collects all errors
  - [ ] Test relaxed mode reports all errors
  - [ ] Test default mode is strict

## Dev Notes

### Existing System Context

- Scenario validator: `tests/e2e/fixtures/scenario_validator.py`
  - Currently collects errors in `self.validation_errors` list
  - `validate_all()` method collects all errors before returning
  - Returns `True/False` instead of raising exceptions
- Dependency validator: `tests/e2e/fixtures/dependency_validator.py` (to be created in Story 14.2)
  - Will need mode support from the start
- Current validation pattern:
  ```python
  def validate_all(self) -> bool:
      self.validation_errors.clear()
      self._validate_file_changes()
      self._validate_artifacts()
      # ... more validations
      return len(self.validation_errors) == 0
  ```
- Integration points:
  - Used by E2E scenario tests
  - Used by E2E workflow tests
  - Used by E2E smoke tests

### Integration Approach

- Add validation mode parameter to validator constructors
- Default to strict mode for all validators
- Implement strict mode: raise exception on first error
- Implement relaxed mode: collect errors, raise exception at end with all errors
- Use pytest markers for relaxed mode opt-in
- Update all validators to support both modes

### Technology Research

- Use `Enum` class for validation modes
- Use `pytest.mark` for relaxed mode marker
- Use exception raising for failures (don't return True/False)
- Use exception messages to report all errors in relaxed mode

### Risk Assessment

- **Primary risk**: Strict mode may cause tests to fail more often, revealing previously hidden issues
- **Mitigation**: This is expected and desired. Fix underlying issues rather than masking them.
- **Secondary risk**: Relaxed mode may be overused, masking issues
- **Mitigation**: Document that relaxed mode is for debugging only, not for production tests. Default to strict.

### Testing

- Test file location: `tests/unit/e2e/test_validation_modes.py`
- Test standards: Use `pytest`, follow existing unit test patterns
- Testing frameworks: `pytest`
- Specific requirements:
  - Test strict mode fails on first error
  - Test strict mode doesn't collect subsequent errors
  - Test relaxed mode collects all errors
  - Test relaxed mode reports all errors at end
  - Test default mode is strict
  - Test marker-based relaxed mode opt-in

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 14.5       | bmad-master |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_

