# Story 22.4: CLI Contract Tests (Behavioral) + Entrypoint Parity

<!-- Source: implementation/cursor/EPIC_22_CLI_Reliability_And_Entrypoint_Parity.md -->
<!-- Context: Add/extend behavioral CLI tests to prevent regressions in exit codes, output contracts, and entrypoint parity -->

## Status

**Deferred** - CLI maintenance item, lower priority

## Story

**As a** maintainer and CI owner,
**I want** behavioral contract tests for the CLI (including parity across entrypoints),
**so that** refactors to improve reliability donâ€™t accidentally break scripts, workflows, or user expectations.

## Acceptance Criteria

1. Contract tests validate **golden paths** for representative commands, including at minimum:
   - `--help` (and/or top-level help)
   - `init`
   - `workflow ...` (at least one safe preset path)
2. Contract tests validate **common failure paths**:
   - missing file/invalid path
   - invalid arguments (usage/argparse error)
   - agent execution error surfaced in output
3. Tests validate output contracts:
   - exit codes (0 success, non-zero failure)
   - JSON envelope includes `success` and structured `error` on failure (per Story 22.2)
4. Tests validate entrypoint parity:
   - `tapps-agents ...` and `python -m tapps_agents.cli ...` behave the same for the tested commands (outputs + exit codes + startup behavior).
5. Tests are cross-platform (Windows-friendly) and run reliably in CI.

## Tasks / Subtasks

- [ ] Task 1: Decide test harness approach for entrypoint parity (AC: 4, 5)
  - [ ] Use subprocess-based runner utilities (existing `tests/e2e/fixtures/` patterns)
  - [ ] Ensure ability to invoke both entrypoints in a hermetic way

- [ ] Task 2: Add golden-path contract tests (AC: 1, 3)
  - [ ] `--help` contract test
  - [ ] `init` contract test in isolated temp directory
  - [ ] `workflow` contract test with safe preset and timeouts

- [ ] Task 3: Add failure-path contract tests (AC: 2, 3)
  - [ ] Missing/invalid file path yields consistent exit code + error envelope
  - [ ] Invalid args yield consistent usage error behavior

- [ ] Task 4: Add parity assertions across entrypoints (AC: 4)
  - [ ] For each tested command, execute via both entrypoints and compare:
    - exit code
    - JSON keys (and key semantics)
    - presence/absence of startup behavior indicators

## Dev Notes

### Existing System Context

- Existing CLI E2E harness work exists under Epic 11 (`tests/e2e/fixtures/ci_safety.py`, related fixtures).
- Current startup routine behavior differs by entrypoint (`__main__` block vs console script).

### Integration Approach

- Keep tests focused on contract:
  - exit codes
  - stable JSON envelope keys
  - parity across entrypoints
- Avoid overly strict output string matching; prefer schema/key-based assertions.

### Risk Assessment

- **Primary risk**: tests are flaky due to async/background startup routines.
- **Mitigation**: provide deterministic toggles for startup (Story 22.1), use timeouts, and assert on stable signals rather than timing.

### Testing

- Implement as E2E-style subprocess tests; ensure Windows quoting and `pathlib` usage.

## Change Log

| Date       | Version | Description                                   | Author      |
| ---------- | ------- | --------------------------------------------- | ----------- |
| 2025-12-16 | 0.1     | Initial draft for Epic 22.4                   | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_


