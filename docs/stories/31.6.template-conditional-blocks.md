# Story 31.6: Template Conditional Blocks + Explain Metadata

<!-- Source: docs/prd/epic-3-adaptive-configuration-and-templates.md -->
<!-- Context: Extend tech stack template engine to support conditional blocks and explain/trace output -->

## Status

**Completed** (2025-12-17)

## Story

**As a** framework user,  
**I want** templates to support safe conditional blocks and “explain why this rendered” metadata,  
**so that** generated configuration is adaptive to project context and still transparent/debuggable.

## Acceptance Criteria

1. Template rendering supports basic conditional blocks (`if` / `else`) driven by detected context (project type, frameworks, compliance flags, etc.)
2. Conditional evaluation is **safe** (no arbitrary code execution) and limited to allowlisted variables/operations
3. Rendering produces explain/trace output showing which conditionals evaluated true/false and why (e.g., variable values used)
4. Rendering remains deterministic given the same inputs
5. Existing templates without conditionals continue to render unchanged (backward compatible)
6. Syntax and limitations are documented with examples
7. Unit tests cover true/false paths, missing variables, nested conditionals (if supported), and backward compatibility

## Tasks / Subtasks

- [x] Task 1: Define conditional syntax and evaluation rules (AC: 1, 2, 6)
  - [x] Decide minimal supported syntax (e.g., `{{#if var}}...{{/if}}` and optional `{{#else}}`)
  - [x] Define allowlisted variables and safe operations (presence/equals/contains)
  - [x] Document unsupported patterns explicitly

- [x] Task 2: Implement conditional rendering in template engine (AC: 1, 2, 5)
  - [x] Parse conditional blocks
  - [x] Evaluate conditions using the existing template context (project/tech_stack)
  - [x] Ensure clean failure modes (missing variables → false or configurable behavior)

- [x] Task 3: Add explain/trace output (AC: 3, 4)
  - [x] Define trace format (sidecar JSON, embedded comments, or both)
  - [x] Record evaluated conditions and variable values (redact sensitive fields)
  - [x] Ensure trace is stable and deterministic

- [ ] Task 4: Testing + docs (AC: 6, 7)
  - [ ] Add unit tests for parser/evaluator
  - [ ] Add examples to documentation (conditional blocks + trace output)

## Dev Notes

### Existing System Context

- Variable expansion and merge order exist (see `docs/stories/31.3.template-merging-system.md`)
- Template selection and init integration exist (see `docs/stories/31.2.template-selection-logic.md`, `docs/stories/31.4.init-integration.md`)

### Integration Approach

- Extend the existing template rendering/merge pipeline to support conditionals
- Prefer a **minimal** and **safe** evaluator (no Python `eval`, no arbitrary expressions)
- Emit trace output to help users understand why a config was generated

### Testing

- Unit tests for conditional parsing and evaluation
- Regression tests for templates that use variable expansion only

## Change Log

| Date       | Version | Description                 | Author      |
| ---------- | ------- | --------------------------- | ----------- |
| 2025-12-17 | 0.1     | Initial draft for Epic 3    | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

- `tapps_agents/core/template_merger.py` - Added conditional block processing, trace support, and TemplateTrace dataclass

## QA Results

_TBD_


