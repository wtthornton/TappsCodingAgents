# Story 2.2: Background Cloud Agents - Docs, Ops, Context

<!-- Source: implementation/cursor/EPIC_02_Core_Agents.md -->
<!-- Context: Brownfield enhancement to run docs/ops/context tasks via Background Agents -->

## Status

Draft

## Story

**As a** workflow executor running in Cursor mode,
**I want** documentation, operations/security, and Context7 KB maintenance to run as Background Agent tasks with versioned outputs,
**so that** we can offload long-running support work and reliably consume results in the orchestrated workflow.

## Acceptance Criteria

1. Docs, Ops, and Context tasks can be triggered in Cursor mode via Background Agent API when available (`tapps_agents/workflow/background_agent_api.py`) and fall back to file-based execution instructions when not.
2. Each task emits a versioned JSON artifact (`schema_version`) plus optional markdown summaries, written inside the step worktree.
3. Documentation generation uses existing agent entrypoints (`tapps_agents/agents/documenter/agent.py`) and produces deterministic output locations (e.g., `docs/` and/or `reports/docs/*.json`).
4. Ops/security tasks use existing `OpsAgent` capabilities (`tapps_agents/agents/ops/agent.py`) and produce deterministic output locations (e.g., `reports/ops/security-report.json`).
5. Context tasks support cache health operations using the existing Context7 subsystem (`tapps_agents/context7/`), including at least:
   - cache warmup (scripted entrypoint exists: `scripts/prepopulate_context7_cache.py`)
   - cache staleness evaluation (see `tapps_agents/context7/staleness_policies.py`)
   - cache statistics reporting (see `tapps_agents/context7/agent_integration.py`)
6. Runs are cancellable and time-bounded; on cancel/timeout, a partial “status + error” artifact is still written.

## Tasks / Subtasks

- [ ] Task 1: Standardize Docs task outputs (AC: 2–3)
  - [ ] Review `tapps_agents/agents/documenter/agent.py` and its output behavior
  - [ ] Define versioned JSON summary artifact for documentation runs
  - [ ] Ensure output paths are deterministic and safe inside worktrees

- [ ] Task 2: Standardize Ops task outputs (AC: 2, 4)
  - [ ] Review `tapps_agents/agents/ops/agent.py` handlers (security scan, dependency audit, infra setup)
  - [ ] Define versioned JSON summary artifact for ops/security runs

- [ ] Task 3: Implement/Expose Context “agent” operations (AC: 2, 5)
  - [ ] Decide whether to add a new `tapps_agents/agents/context/agent.py` wrapper or expose Context ops through orchestrator commands
  - [ ] Reuse `scripts/prepopulate_context7_cache.py` for warmup in background execution
  - [ ] Emit cache stats via `Context7AgentHelper.get_cache_statistics()`

- [ ] Task 4: Wire Cursor Background Agent triggering + fallback (AC: 1)
  - [ ] Integrate with `tapps_agents/workflow/skill_invoker.py` (new mappings / actions) or workflow step configuration
  - [ ] Ensure `.cursor-skill-command*.txt` + `.cursor-skill-instructions.md` fallback exists per step

- [ ] Task 5: Cancellation, timeouts, and resource hygiene (AC: 6)
  - [ ] Ensure these tasks do not write outside the worktree beyond explicitly allowed shared caches
  - [ ] Ensure large outputs are bounded and secrets/PII are not written to artifacts

- [ ] Task 6: Tests (AC: 1–6)
  - [ ] Unit tests for command mapping + artifact detection
  - [ ] Integration tests for Context7 cache stats and “warmup” dry-run behavior (guarded by API key when needed)

## Dev Notes

### Existing System Context

- `DocumenterAgent` exists at `tapps_agents/agents/documenter/agent.py`.
- `OpsAgent` exists at `tapps_agents/agents/ops/agent.py` and already includes dependency/security auditing hooks.
- Context7 integration exists under `tapps_agents/context7/` and includes:
  - cache management (`tapps_agents/context7/kb_cache.py`)
  - staleness policies (`tapps_agents/context7/staleness_policies.py`)
  - agent helper (`tapps_agents/context7/agent_integration.py`)
  - warmup script (`scripts/prepopulate_context7_cache.py`)

### Integration Approach

- Treat Docs/Ops/Context as **background-capable services** that emit stable artifacts.
- Prefer “wrapper tasks” over rewriting existing agents: run existing agent commands, then normalize outputs to versioned JSON.

### Risk Assessment

- **Primary risk**: Context7 API access is environment-dependent; background jobs may not have credentials.
- **Mitigation**: design Context tasks to be KB-first, degrade gracefully, and emit explicit `enabled`/`error` fields.

### Rollback Plan

- Disable background execution for these tasks; continue running existing local agent behavior or skipping non-essential tasks while emitting “not run” artifacts.

### Testing

- Add unit tests for wrapper output normalization.
- For Context7, gate real-API tests behind env vars (pattern already exists in `tests/integration/test_context7_real.py`).

## Change Log

| Date       | Version | Description                           | Author      |
| ---------- | ------- | ------------------------------------- | ----------- |
| 2025-12-14 | 0.1     | Initial draft for Epic 2.2            | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

_TBD_
