# Story 14.1: Remove Fallback Paths in Scenario Validator

<!-- Source: implementation/cursor/EPIC_14_E2E_Test_Reliability.md -->
<!-- Context: Refactor scenario_validator.py to remove fallback artifact location logic and fail immediately when expected artifacts don't exist at expected locations -->

## Status

**Deferred** - Testing infrastructure improvement, lower priority

## Story

**As a** QA engineer and developer,
**I want** the scenario validator to fail immediately when expected artifacts don't exist at their expected locations, without trying fallback paths,
**so that** test failures are transparent and indicate exactly what's broken, rather than masking failures through fallback logic.

## Acceptance Criteria

1. Refactor `scenario_validator.py` to remove all fallback artifact location logic (e.g., try `.tapps-agents/artifacts/` first, then fallback to project root)
2. Validator fails immediately if expected artifacts don't exist at their expected locations (single, explicit path per artifact type)
3. Clear error messages indicate expected vs actual artifact locations:
   - Expected location: `{artifacts_dir}/{artifact_type}/{artifact_name}`
   - Actual locations checked: show exactly what paths were checked
   - Missing artifact: specific artifact name and type
4. Remove fallback logic for test file existence checks (fail immediately if test files don't exist where expected)
5. All validation methods fail fast on first error (don't collect errors and continue)
6. Existing E2E scenario tests continue to work but may fail more often due to strict validation (this is expected and desired)
7. Unit tests exist for the refactored validator demonstrating fail-fast behavior

## Tasks / Subtasks

- [ ] Task 1: Refactor `_validate_artifacts()` method (AC: 1, 2, 3)
  - [ ] Remove fallback path logic (trying project root after `.tapps-agents/artifacts/`)
  - [ ] Use single, explicit path per artifact: `artifacts_dir / artifact_type / artifact_name`
  - [ ] Fail immediately with `pytest.fail()` or raise `AssertionError` if artifact doesn't exist
  - [ ] Add clear error messages showing expected location and artifact details

- [ ] Task 2: Refactor `_validate_file_changes()` method (AC: 4)
  - [ ] Remove any fallback logic for file existence checks
  - [ ] Fail immediately if expected files don't exist at exact expected paths
  - [ ] Add clear error messages for missing files

- [ ] Task 3: Implement fail-fast validation mode (AC: 5)
  - [ ] Modify `validate_all()` to fail on first error instead of collecting errors
  - [ ] Raise exception immediately when first validation error is encountered
  - [ ] Ensure all validation methods propagate exceptions (don't catch and continue)

- [ ] Task 4: Update error messages for clarity (AC: 3)
  - [ ] Include context: test name, scenario type, template size
  - [ ] Show expected location path
  - [ ] Show actual checked paths (if any were checked)
  - [ ] Include artifact type and name in error message

- [ ] Task 5: Update tests and verify behavior (AC: 6, 7)
  - [ ] Update unit tests in `tests/unit/e2e/test_scenario_validator.py` to verify fail-fast behavior
  - [ ] Add tests that verify immediate failure on missing artifacts
  - [ ] Add tests that verify clear error messages
  - [ ] Run existing E2E scenario tests to verify they still work (may need updates if they relied on fallbacks)

## Dev Notes

### Existing System Context

- Scenario validator location: `tests/e2e/fixtures/scenario_validator.py`
- Current implementation has fallback paths:
  ```python
  # Lines 88-93: Planning artifacts fallback
  artifact_path = artifacts_dir / artifact
  if not artifact_path.exists():
      # Try project root as fallback
      artifact_path = self.project_path / artifact
      if not artifact_path.exists():
          self.validation_errors.append(...)
  ```
- Artifact types: planning, design, code, review, test, docs
- Expected artifact location: `.tapps-agents/artifacts/{artifact_type}/{artifact_name}`
- Fallback location: `{project_root}/{artifact_name}`
- Integration points:
  - Used by E2E scenario tests in `tests/e2e/scenarios/`
  - Called from `ScenarioValidator.validate_all()` method
  - Errors collected in `self.validation_errors` list

### Integration Approach

- Refactor `_validate_artifacts()` to remove fallback logic
- Use explicit path construction: `artifacts_dir / artifact_type / artifact_name`
- Fail immediately using `pytest.fail()` or raise `AssertionError` with clear message
- Update `validate_all()` to propagate exceptions immediately (don't catch and collect)
- Preserve existing method signatures for compatibility
- Update error messages to be more descriptive and actionable

### Technology Research

- Use `pathlib.Path` for path operations (already in use)
- Use `pytest.fail()` for test failures or raise `AssertionError` for immediate failure
- Error messages should be formatted clearly for debugging

### Risk Assessment

- **Primary risk**: Existing tests may fail more often, appearing "flaky" when they're actually catching real issues
- **Mitigation**: This is expected behavior - failures are now visible instead of hidden. Update tests to ensure dependencies are correctly set up.
- **Rollback plan**: Can temporarily revert to fallback behavior if needed, but should address root cause instead

### Testing

- Test file location: `tests/unit/e2e/test_scenario_validator.py` (create if doesn't exist)
- Test standards: Use `pytest`, follow existing unit test patterns
- Testing frameworks: `pytest`
- Specific requirements:
  - Test that validator fails immediately when artifact doesn't exist at expected location
  - Test that no fallback paths are checked
  - Test that error messages are clear and include expected path
  - Test that all artifact types fail fast (planning, design, code, review, test, docs)
  - Test that file changes validation also fails fast

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 14.1       | bmad-master |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_

