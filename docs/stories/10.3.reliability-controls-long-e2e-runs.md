# Story 10.3: Reliability Controls for Long E2E Runs

<!-- Source: implementation/cursor/EPIC_10_E2E_Scenario_Tests.md -->
<!-- Context: Implement reliability controls (timeouts, retries, cost guardrails) for long-running scenario E2E tests -->

## Status

Draft

## Story

**As a** QA engineer and CI/CD engineer,
**I want** reliability controls (timeouts, retries, cost guardrails) for long-running scenario E2E tests,
**so that** scenario tests are reliable, cost-effective, and can handle transient failures gracefully while failing fast on deterministic errors.

## Acceptance Criteria

1. Timeout controls exist for scenario E2E tests:
   - Per-scenario timeout caps (configurable per scenario type)
   - Per-step timeout controls (step-level timeouts)
   - Per-workflow timeout controls (workflow-level timeouts)
   - Timeout configuration via fixtures, environment variables, or test markers
   - Timeout violations produce clear error messages and captured state
2. Partial progress capture exists on failure:
   - State snapshots captured at timeout points
   - Artifacts created before timeout are preserved
   - Step timeline captured up to timeout point
   - Failure bundles include partial progress information
3. Retry policy exists for transient external failures:
   - Bounded retries for transient network failures (real LLM, Context7)
   - Bounded retries for transient service failures (API rate limits, temporary unavailability)
   - Retry configuration (max retries, backoff strategy, retryable error types)
   - Retry counts and reasons recorded in logs
   - Fail fast on deterministic logic errors (no retries)
4. Cost guardrails exist for real-service scenario tests:
   - Token/call budgets per scenario (configurable limits)
   - Parallelism limits (max concurrent real-service calls)
   - Cost tracking and reporting (tokens used, API calls made, estimated cost)
   - Cost budget violations produce warnings or fail tests (configurable)
5. Credential presence gates exist:
   - Tests skip cleanly when credentials are missing (skip, don't fail)
   - Clear skip messages indicating missing credentials
   - Tests can be run with mocked mode when credentials unavailable
   - Credential validation before test execution
6. Reliability controls integrate with E2E foundation:
   - Use E2E harness utilities for timeout handling
   - Use E2E artifact capture for partial progress
   - Use E2E correlation IDs for retry tracking
   - Follow E2E conventions (logging, failure bundles)
7. Reliability controls are configurable:
   - Configuration via pytest fixtures
   - Configuration via environment variables
   - Configuration via test markers
   - Default values are reasonable for scheduled execution
8. Reliability controls are documented:
   - Timeout configuration and defaults
   - Retry policy and configuration
   - Cost guardrails and limits
   - Credential requirements
   - How to configure for different execution contexts (local, CI, scheduled)
9. Unit tests exist for reliability control utilities.

## Tasks / Subtasks

- [ ] Task 1: Implement timeout controls (AC: 1, 2)
  - [ ] Create `tests/e2e/fixtures/reliability_controls.py`
  - [ ] Implement per-scenario timeout caps
  - [ ] Implement per-step timeout controls
  - [ ] Implement per-workflow timeout controls
  - [ ] Add timeout configuration (fixtures, env vars, markers)
  - [ ] Integrate with workflow runner for timeout handling
  - [ ] Capture partial progress on timeout (state, artifacts, timeline)
  - [ ] Produce clear timeout error messages

- [ ] Task 2: Implement partial progress capture (AC: 2)
  - [ ] Extend E2E artifact capture to handle partial progress
  - [ ] Capture state snapshots at timeout points
  - [ ] Preserve artifacts created before timeout
  - [ ] Capture step timeline up to timeout point
  - [ ] Include partial progress in failure bundles
  - [ ] Document partial progress in failure artifacts

- [ ] Task 3: Implement retry policy (AC: 3)
  - [ ] Implement bounded retry logic for transient failures
  - [ ] Define retryable error types (network errors, rate limits, temporary unavailability)
  - [ ] Implement retry configuration (max retries, backoff strategy)
  - [ ] Record retry counts and reasons in logs
  - [ ] Fail fast on deterministic logic errors (no retries)
  - [ ] Integrate with workflow runner for retry handling
  - [ ] Add retry configuration (fixtures, env vars, markers)

- [ ] Task 4: Implement cost guardrails (AC: 4)
  - [ ] Create cost tracking utilities
  - [ ] Implement token/call budget limits per scenario
  - [ ] Implement parallelism limits (max concurrent calls)
  - [ ] Track tokens used, API calls made, estimated cost
  - [ ] Implement cost budget violation handling (warnings or failures)
  - [ ] Add cost reporting (logs, test summaries)
  - [ ] Add cost configuration (fixtures, env vars, markers)

- [ ] Task 5: Implement credential presence gates (AC: 5)
  - [ ] Create credential validation utilities
  - [ ] Check for required credentials before test execution
  - [ ] Skip tests cleanly when credentials missing (skip, don't fail)
  - [ ] Provide clear skip messages
  - [ ] Support fallback to mocked mode when credentials unavailable
  - [ ] Integrate with pytest skip logic

- [ ] Task 6: Integrate with E2E foundation (AC: 6)
  - [ ] Use E2E harness utilities for timeout handling
  - [ ] Use E2E artifact capture for partial progress
  - [ ] Use E2E correlation IDs for retry tracking
  - [ ] Follow E2E conventions (logging, failure bundles)
  - [ ] Integrate with E2E fixtures in `tests/e2e/conftest.py`

- [ ] Task 7: Create pytest fixtures for reliability controls (AC: 7)
  - [ ] Add `scenario_timeout` fixture to `tests/e2e/conftest.py`
  - [ ] Add `retry_policy` fixture
  - [ ] Add `cost_guardrails` fixture
  - [ ] Add `credential_check` fixture
  - [ ] Support configuration via fixtures, env vars, markers
  - [ ] Provide reasonable defaults

- [ ] Task 8: Documentation and unit tests (AC: 8, 9)
  - [ ] Document timeout controls in `tests/e2e/scenarios/README.md`
  - [ ] Document retry policy and configuration
  - [ ] Document cost guardrails and limits
  - [ ] Document credential requirements
  - [ ] Document configuration for different execution contexts
  - [ ] Create unit tests in `tests/unit/e2e/test_reliability_controls.py`
  - [ ] Test timeout controls
  - [ ] Test retry policy
  - [ ] Test cost guardrails
  - [ ] Test credential validation

## Dev Notes

### Existing System Context

- E2E foundation (from Epic 8):
  - `tests/e2e/fixtures/e2e_harness.py` - E2E harness utilities
  - `tests/e2e/conftest.py` - E2E fixtures
  - Artifact capture and failure bundle utilities
- Workflow runner (from Epic 9):
  - `tests/e2e/fixtures/workflow_runner.py` - workflow runner harness
- Scenario templates (from Story 10.1):
  - `tests/e2e/fixtures/scenario_templates.py` - scenario templates
- Existing timeout handling:
  - `pytest-timeout` plugin (already in use)
  - `pytest-asyncio` with timeout support
- Existing retry patterns:
  - Some integration tests may have retry logic (check existing patterns)
- Cost tracking:
  - LLM providers may have cost tracking utilities (check existing patterns)

### Integration Approach

- Build on existing `pytest-timeout` plugin
- Extend E2E harness utilities for timeout and retry handling
- Integrate with workflow runner for step-level controls
- Reuse E2E artifact capture for partial progress
- Follow existing patterns for credential validation and skipping

### Technology Research

- Use `pytest-timeout` for timeout controls (already in use)
- Use `pytest-asyncio` for async timeout handling
- Use `tenacity` or similar library for retry logic (if needed)
- Use `pytest` skip markers for credential gates
- Use structured logging for retry tracking and cost reporting

### Risk Assessment

- **Primary risk**: Reliability controls become too complex or interfere with test execution
- **Mitigation**: Keep controls focused and well-documented; provide clear defaults; test thoroughly
- **Rollback plan**: Reliability controls are additive; can be disabled or simplified without affecting core test functionality

### Testing

- Test file location: `tests/unit/e2e/test_reliability_controls.py`
- Test standards: Use `pytest`, follow existing unit test patterns
- Testing frameworks: `pytest`, `pytest-asyncio`, `pytest-timeout`
- Specific requirements:
  - Test timeout controls (scenario, step, workflow levels)
  - Test partial progress capture
  - Test retry policy (transient failures, deterministic errors)
  - Test cost guardrails (budget limits, tracking, reporting)
  - Test credential validation and skipping
  - Test configuration (fixtures, env vars, markers)

## Change Log

| Date       | Version | Description                       | Author      |
| ---------- | ------- | --------------------------------- | ----------- |
| 2025-01-XX | 0.1     | Initial draft for Epic 10.3       | bmad-master |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

_TBD_

## QA Results

_TBD_
